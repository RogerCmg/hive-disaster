---
phase: 02-hook-observers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - hooks/hive-recall-agent.js
  - .claude/settings.json
  - scripts/build-hooks.js
autonomous: true

must_haves:
  truths:
    - "After a Hive agent (agent_type starting with 'hive-') completes, an agent_completion event appears in events.jsonl with agent name"
    - "Non-Hive agents (agent_type not starting with 'hive-') do NOT produce agent_completion events"
    - "A hook failure (malformed stdin JSON, missing config, disk error) is silently swallowed and exit code is 0"
    - "session_boundary is a recognized event type in VALID_EVENT_TYPES for query/stats commands"
    - "All 4 new hook scripts are registered in settings.json and listed in build-hooks.js"
  artifacts:
    - path: "hooks/hive-recall-agent.js"
      provides: "SubagentStop observer that writes agent_completion events"
      contains: "agent_completion"
      min_lines: 25
    - path: "hive/bin/hive-tools.js"
      provides: "Updated VALID_EVENT_TYPES including session_boundary"
      contains: "session_boundary"
    - path: ".claude/settings.json"
      provides: "Hook registrations for SubagentStop, PostToolUseFailure, PreCompact, SessionStart, SessionEnd"
      contains: "hive-recall-agent"
    - path: "scripts/build-hooks.js"
      provides: "Updated HOOKS_TO_COPY with 4 new recall hooks"
      contains: "hive-recall-agent"
  key_links:
    - from: ".claude/settings.json"
      to: "hooks/hive-recall-agent.js"
      via: "SubagentStop hook command registration"
      pattern: "hive-recall-agent"
    - from: "hooks/hive-recall-agent.js"
      to: ".planning/telemetry/events.jsonl"
      via: "fs.appendFileSync direct write"
      pattern: "appendFileSync"
    - from: "hive/bin/hive-tools.js"
      to: "session_boundary event type"
      via: "VALID_EVENT_TYPES array inclusion"
      pattern: "session_boundary"
---

<objective>
Create the SubagentStop hook observer (hive-recall-agent.js) that passively captures Hive agent completions to events.jsonl, add session_boundary to VALID_EVENT_TYPES, and register all 4 new Recall hooks in settings.json and build-hooks.js.

Purpose: Establishes the hook observer pattern for Phase 2 (stdin parse, filter, config check, envelope, append) with a working first hook, and pre-registers all hooks so Plan 02 only needs to create the remaining 3 hook files.
Output: Working SubagentStop observer, updated VALID_EVENT_TYPES, complete hook registrations, updated build script.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-hook-observers/02-RESEARCH.md
@hooks/hive-check-update.js
@hive/bin/hive-tools.js
@.claude/settings.json
@scripts/build-hooks.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session_boundary to VALID_EVENT_TYPES and create SubagentStop hook</name>
  <files>hive/bin/hive-tools.js, hooks/hive-recall-agent.js</files>
  <action>
**In hive/bin/hive-tools.js:**
Add `'session_boundary'` to the VALID_EVENT_TYPES array (currently at ~line 149). Insert it after `'session_summary'` since they are related. The array should become 11 types.

**Create hooks/hive-recall-agent.js:**
Create a new file following the exact stdin-parsing pattern from hive-check-update.js. The hook:

1. Reads JSON from stdin (process.stdin on 'data'/'end' pattern)
2. Entire body wrapped in outer try/catch with EMPTY catch (HOOK-06: fail-silent)
3. Filters: checks `data.agent_type` starts with `'hive-'` -- if not, return early (HOOK-07)
4. Config check: reads `.planning/config.json` from `data.cwd`, checks `config.telemetry?.enabled !== false` and `config.telemetry?.hooks !== false`. Missing/corrupt config defaults to enabled (try/catch with empty catch around config read).
5. Builds event envelope matching Phase 1 format EXACTLY:
   ```
   {
     ts: new Date().toISOString(),
     session: data.session_id || 'unknown',
     type: 'agent_completion',
     v: 1,
     data: {
       agent: data.agent_type,
       agent_id: data.agent_id || null,
       duration_ms: null,  // NOT available from SubagentStop input
       exit_code: 0,       // SubagentStop = successful completion
       error: null
     }
   }
   ```
6. Ensures telemetry directory exists: `fs.mkdirSync(path.join(data.cwd, '.planning', 'telemetry'), { recursive: true })`
7. Appends event as JSONL: `fs.appendFileSync(eventsPath, JSON.stringify(event) + '\n')`

Do NOT shell out to hive-tools.js CLI (avoid ~100ms child process overhead). Write directly to events.jsonl.
Do NOT use async/await or Promises. Keep everything synchronous after stdin is consumed.
Do NOT use process.stdout for output. Silent exit 0.

Add shebang line: `#!/usr/bin/env node`
Add header comment: `// Hive Recall -- Agent completion observer`
Add hook identifier comment: `// Hook: SubagentStop | Fail-silent`
  </action>
  <verify>
1. `grep 'session_boundary' hive/bin/hive-tools.js` shows the type in VALID_EVENT_TYPES
2. `node -c hooks/hive-recall-agent.js` passes syntax check
3. `echo '{"session_id":"test","cwd":"/tmp","agent_type":"hive-executor","agent_id":"abc"}' | node hooks/hive-recall-agent.js` runs without error (may not write if /tmp/.planning doesn't exist, but should NOT crash)
4. `echo '{"session_id":"test","cwd":"/tmp","agent_type":"regular-agent"}' | node hooks/hive-recall-agent.js` runs without error and does NOT write (non-Hive agent filtered)
5. `echo 'invalid json' | node hooks/hive-recall-agent.js` exits 0 silently (fail-silent)
  </verify>
  <done>
hive-recall-agent.js exists with stdin parsing, hive- prefix filtering, config gating, envelope construction, and direct JSONL append. VALID_EVENT_TYPES includes session_boundary (11 types total). All malformed input exits silently.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register all Recall hooks in settings.json and update build-hooks.js</name>
  <files>.claude/settings.json, scripts/build-hooks.js</files>
  <action>
**In .claude/settings.json:**
Read the existing file and MERGE new hook registrations. Do NOT overwrite existing hooks. The existing SessionStart hook for hive-check-update.js MUST be preserved.

Add these hook registrations (following the exact structure of the existing SessionStart entry):

```json
{
  "hooks": {
    "SubagentStop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/hive-recall-agent.js"
          }
        ]
      }
    ],
    "PostToolUseFailure": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/hive-recall-error.js"
          }
        ]
      }
    ],
    "PreCompact": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/hive-recall-compact.js"
          }
        ]
      }
    ],
    "SessionStart": [
      ... existing hive-check-update.js entry (KEEP) ...,
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/hive-recall-session.js start"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/hive-recall-session.js end"
          }
        ]
      }
    ]
  },
  "statusLine": { ... existing statusLine entry (KEEP) ... }
}
```

Key: SessionStart array gets a SECOND entry appended (the session recall hook) alongside the existing update checker. The `statusLine` field must remain unchanged.

**In scripts/build-hooks.js:**
Add 4 new entries to the HOOKS_TO_COPY array:
- `'hive-recall-agent.js'`
- `'hive-recall-error.js'`
- `'hive-recall-compact.js'`
- `'hive-recall-session.js'`

Keep the existing entries (`'hive-check-update.js'`, `'hive-statusline.js'`).
  </action>
  <verify>
1. `node -e "const s = require('./.claude/settings.json'); console.log(Object.keys(s.hooks))"` shows SubagentStop, PostToolUseFailure, PreCompact, SessionStart, SessionEnd
2. `node -e "const s = require('./.claude/settings.json'); console.log(s.hooks.SessionStart.length)"` outputs 2 (existing + recall)
3. `node -e "const s = require('./.claude/settings.json'); console.log(s.statusLine.command)"` still shows hive-statusline.js (not overwritten)
4. `grep 'hive-recall-agent' scripts/build-hooks.js` finds the entry
5. `grep 'hive-recall-session' scripts/build-hooks.js` finds the entry
  </verify>
  <done>
settings.json contains registrations for all 5 hook events (SubagentStop, PostToolUseFailure, PreCompact, SessionStart, SessionEnd) with existing hive-check-update.js preserved. build-hooks.js HOOKS_TO_COPY lists all 6 hooks (2 existing + 4 new).
  </done>
</task>

</tasks>

<verification>
1. `node -c hooks/hive-recall-agent.js` -- syntax valid
2. `echo 'bad' | node hooks/hive-recall-agent.js; echo $?` -- exits 0 (fail-silent)
3. `grep 'session_boundary' hive/bin/hive-tools.js` -- type registered
4. `node -e "const s = require('./.claude/settings.json'); console.log(JSON.stringify(Object.keys(s.hooks).sort()))"` -- all 5 events registered
5. `node -e "const s = require('./.claude/settings.json'); console.log(s.hooks.SessionStart.length)"` -- 2 entries (check-update + recall)
</verification>

<success_criteria>
- hive-recall-agent.js is a working SubagentStop hook that filters for hive- agents, checks config, and appends agent_completion events to events.jsonl
- VALID_EVENT_TYPES includes session_boundary (11 types)
- settings.json registers all 4 new Recall hooks without breaking existing hooks
- build-hooks.js includes all 4 new hooks in HOOKS_TO_COPY
</success_criteria>

<output>
After completion, create `.planning/phases/02-hook-observers/02-01-SUMMARY.md`
</output>
