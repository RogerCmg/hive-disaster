---
phase: 13-build-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - hive/bin/hive-tools.js
  - .claude/hive/bin/hive-tools.js
  - hive/workflows/complete-milestone.md
  - .claude/hive/workflows/complete-milestone.md
  - hive/templates/config.json
  - .claude/hive/templates/config.json
autonomous: true

must_haves:
  truths:
    - "Gate 3 uses pre_main_command when configured instead of build_command"
    - "Gate 3 falls back to build_command when pre_main_command is not set"
    - "Gate 3 falls back to auto-detection when neither pre_main_command nor build_command is set"
    - "pre_main_command supports both string and array formats (same as build_command after Plan 01)"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "Gate-specific command selection via --gate parameter"
      contains: "pre_main_command"
    - path: "hive/workflows/complete-milestone.md"
      provides: "Gate 3 invocation with --gate pre_main parameter"
      contains: "pre_main"
    - path: "hive/templates/config.json"
      provides: "pre_main_command config field"
      contains: "pre_main_command"
  key_links:
    - from: "loadConfig"
      to: "cmdGitRunBuildGate"
      via: "git_pre_main_command field used when gate is pre_main"
      pattern: "git_pre_main_command"
    - from: "complete-milestone.md"
      to: "cmdGitRunBuildGate"
      via: "--gate pre_main CLI argument"
      pattern: "run-build-gate.*--gate"
---

<objective>
Gate 3 uses a separate pre_main_command for pre-main-merge validation, with fallback to build_command.

Purpose: Pre-main merge validation often needs different or additional checks (e.g., full integration tests, production build) compared to per-PR build gates. A separate command allows configuring heavier validation for the milestone completion gate without slowing down per-plan builds.

Output: Modified hive-tools.js with gate-aware command selection, updated complete-milestone.md workflow, and config template with pre_main_command field.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-build-pipeline/13-01-SUMMARY.md
@hive/bin/hive-tools.js
@hive/workflows/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pre_main_command config field and gate-aware command selection to hive-tools.js</name>
  <files>hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js</files>
  <action>
Three changes to hive-tools.js (apply identically to both copies):

**1. loadConfig — add pre_main_command field:**

In the defaults object, add:
```javascript
git_pre_main_command: null,
```

In the return object, add:
```javascript
git_pre_main_command: gitSection.pre_main_command ?? defaults.git_pre_main_command,
```

**2. cmdGitRunBuildGate — accept --gate parameter for gate-specific command selection:**

Add a `gate` parameter to the function. Parse it from CLI args (see step 3 below).

Change the function signature from `cmdGitRunBuildGate(cwd, raw)` to `cmdGitRunBuildGate(cwd, gate, raw)`.

Change the build command resolution from:
```javascript
const buildCmd = config.git_build_command || detectBuildCommand(cwd).command;
```

To:
```javascript
// Gate-specific command selection: pre_main_command for Gate 3, build_command for others
let buildCmd;
if (gate === 'pre_main' && config.git_pre_main_command) {
  buildCmd = config.git_pre_main_command;
} else {
  buildCmd = config.git_build_command || detectBuildCommand(cwd).command;
}
```

This means:
- When called with `--gate pre_main` AND `pre_main_command` is configured: use `pre_main_command`
- When called with `--gate pre_main` but `pre_main_command` is NOT configured: fall back to `build_command` (or auto-detection)
- When called without `--gate` or with any other gate: use `build_command` (or auto-detection) as before

**3. CLI router — pass --gate argument:**

In the git subcommand dispatcher (around line 6332), change from:
```javascript
} else if (subcommand === 'run-build-gate') {
  cmdGitRunBuildGate(cwd, raw);
```

To:
```javascript
} else if (subcommand === 'run-build-gate') {
  const gateIndex = args.indexOf('--gate');
  const gate = gateIndex !== -1 && args[gateIndex + 1] ? args[gateIndex + 1] : null;
  cmdGitRunBuildGate(cwd, gate, raw);
```

**IMPORTANT:** Apply ALL changes identically to both `hive/bin/hive-tools.js` and `.claude/hive/bin/hive-tools.js`. Use `git add -f .claude/hive/bin/hive-tools.js` since it's gitignored but tracked.
  </action>
  <verify>
```bash
# Check pre_main_command exists in loadConfig
grep -n "pre_main_command" hive/bin/hive-tools.js

# Check gate parameter handling
grep -n "gate.*pre_main" hive/bin/hive-tools.js

# Check CLI router passes gate
grep -A3 "run-build-gate" hive/bin/hive-tools.js | grep gate

# Verify both copies match
diff <(grep -A3 "pre_main_command" hive/bin/hive-tools.js) <(grep -A3 "pre_main_command" .claude/hive/bin/hive-tools.js)

# Verify tool still runs
node hive/bin/hive-tools.js git run-build-gate --raw
```
  </verify>
  <done>
  - loadConfig returns git_pre_main_command field (default null)
  - cmdGitRunBuildGate accepts --gate parameter, uses pre_main_command when gate is pre_main and command is configured
  - Falls back to build_command when pre_main_command is not set
  - Backward compatible: existing callers without --gate work unchanged
  - Both hive-tools.js copies are identical
  </done>
</task>

<task type="auto">
  <name>Task 2: Update complete-milestone workflow and config template for pre_main_command</name>
  <files>hive/workflows/complete-milestone.md, .claude/hive/workflows/complete-milestone.md, hive/templates/config.json, .claude/hive/templates/config.json</files>
  <action>
**1. complete-milestone.md — pass --gate pre_main to Gate 3 build gate call:**

In the `merge_dev_to_main` step, find the Gate 3 build gate invocation. In `hive/workflows/complete-milestone.md` (source), change:

```bash
BUILD_RESULT=$(node ~/.claude/hive/bin/hive-tools.js git run-build-gate --raw)
```

To:

```bash
BUILD_RESULT=$(node ~/.claude/hive/bin/hive-tools.js git run-build-gate --gate pre_main --raw)
```

In `.claude/hive/workflows/complete-milestone.md` (installed), change:

```bash
BUILD_RESULT=$(node ./.claude/hive/bin/hive-tools.js git run-build-gate --gate pre_main --raw)
```

(Note the different path prefix: `~/` for source, `./` for installed — this is the established convention.)

**2. config template — add pre_main_command field:**

In both `hive/templates/config.json` and `.claude/hive/templates/config.json`, add the `pre_main_command` field in the git section. Place it after `build_command`:

Change from:
```json
"build_command": null,
```

To:
```json
"build_command": null,
"pre_main_command": null,
```

**Apply path conventions correctly:** Source files use `~/` paths, installed files use `./` paths.
  </action>
  <verify>
```bash
# Check Gate 3 passes --gate pre_main
grep "run-build-gate.*--gate" hive/workflows/complete-milestone.md
grep "run-build-gate.*--gate" .claude/hive/workflows/complete-milestone.md

# Check config template has pre_main_command
grep "pre_main_command" hive/templates/config.json
grep "pre_main_command" .claude/hive/templates/config.json

# Verify valid JSON
node -e "JSON.parse(require('fs').readFileSync('hive/templates/config.json','utf8')); console.log('valid')"

# Verify path conventions are correct
grep "node ~/" hive/workflows/complete-milestone.md | head -3
grep "node ./" .claude/hive/workflows/complete-milestone.md | head -3
```
  </verify>
  <done>
  - Gate 3 in complete-milestone.md passes --gate pre_main to run-build-gate
  - Config template includes pre_main_command: null field
  - Source files use ~/ paths, installed files use ./ paths
  - Both copy pairs (source/installed) are consistent
  </done>
</task>

</tasks>

<verification>
1. `grep -c "pre_main_command" hive/bin/hive-tools.js` returns at least 3 (default, parse, usage)
2. `grep "run-build-gate.*--gate pre_main" hive/workflows/complete-milestone.md` finds the Gate 3 call
3. `grep "pre_main_command" hive/templates/config.json` shows the field
4. `node hive/bin/hive-tools.js git run-build-gate --gate pre_main --raw` runs without error
5. `node hive/bin/hive-tools.js git run-build-gate --raw` still works (backward compatible)
</verification>

<success_criteria>
- Gate 3 uses pre_main_command when configured via --gate pre_main parameter
- Gate 3 falls back to build_command when pre_main_command is not set
- Existing Gate 1 calls without --gate work unchanged
- Config template documents the new pre_main_command field
- pre_main_command supports same formats as build_command (string or array, per Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/13-build-pipeline/13-02-SUMMARY.md`
</output>
