---
phase: 10-pr-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/hive/workflows/execute-plan.md
autonomous: true

must_haves:
  truths:
    - "After a plan passes its build gate, a PR is created from the plan branch to dev via gh pr create"
    - "The PR body contains the plan's SUMMARY.md content (one-liner, task commits, build gate result, phase context)"
    - "In single-terminal mode, the PR is immediately self-merged preserving per-task commit history"
    - "After merge, the executor checks out dev and pulls to sync the merge commit locally"
    - "When git flow is none or gh CLI is unavailable, PR steps are skipped gracefully with a note in SUMMARY"
  artifacts:
    - path: ".claude/hive/workflows/execute-plan.md"
      provides: "PR creation and self-merge step in execute-plan workflow"
      contains: "create_pr_and_merge"
  key_links:
    - from: ".claude/hive/workflows/execute-plan.md (create_summary)"
      to: ".claude/hive/workflows/execute-plan.md (create_pr_and_merge)"
      via: "SUMMARY.md file on disk — summary created first, PR body reads it"
      pattern: "create_summary.*create_pr_and_merge"
    - from: ".claude/hive/workflows/execute-plan.md (build_gate)"
      to: ".claude/hive/workflows/execute-plan.md (create_pr_and_merge)"
      via: "BUILD_GATE_RESULT variable — PR blocked when gate fails"
      pattern: "BUILD_GATE_RESULT"
---

<objective>
Wire PR creation and self-merge into the execute-plan.md workflow so that after a plan passes its build gate and summary is created, a PR is automatically created from the plan branch to dev and immediately self-merged.

Purpose: This is the core PR flow — the bridge between plan execution (Phase 9) and integrated code on the dev branch. Without this step, plan branches sit unmerged and dev never advances.

Output: Updated execute-plan.md with reordered steps (create_summary moved before create_pr_and_merge) and a new create_pr_and_merge step.
</objective>

<execution_context>
@~/.claude/hive/workflows/execute-plan.md
@~/.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-pr-workflow-integration/10-RESEARCH.md
@.planning/phases/09-branch-lifecycle-build-gates/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder steps and add create_pr_and_merge step to execute-plan.md</name>
  <files>.claude/hive/workflows/execute-plan.md</files>
  <action>
Modify `.claude/hive/workflows/execute-plan.md` with two changes:

**Change 1: Reorder steps so create_summary comes BEFORE the new PR step.**

The current ordering after Phase 9 is:
1. record_completion_time
2. build_gate
3. generate_user_setup
4. create_summary
5. ...

Move `create_summary` to come immediately after `build_gate`, before `generate_user_setup`. The new ordering is:
1. record_completion_time
2. build_gate
3. create_summary (MOVED UP)
4. create_pr_and_merge (NEW)
5. generate_user_setup (shifted down)
6. ...

This reordering is required because the PR body needs SUMMARY.md content (PR-02). The BUILD_GATE_RESULT variable is already set before create_summary runs (it was designed this way in Phase 9).

**Change 2: Add a new `<step name="create_pr_and_merge">` between create_summary and generate_user_setup.**

The new step must:

1. **Check if PR flow applies:**
   ```bash
   GIT_FLOW=$(echo "$CONFIG_CONTENT" | jq -r '.git.flow // "github"')
   GIT_DEV_BRANCH=$(echo "$CONFIG_CONTENT" | jq -r '.git.dev_branch // "dev"')
   ```

   Skip conditions (any one skips):
   - GIT_FLOW is "none" -> Skip: "Git flow disabled. Skipping PR creation."
   - BUILD_GATE_RESULT is "failed" or "timeout" (and user chose "stop") -> Skip: "Build gate did not pass. Skipping PR creation."

   Check gh CLI availability:
   ```bash
   GH_CHECK=$(node ./.claude/hive/bin/hive-tools.js git detect --raw)
   GH_AVAILABLE=$(echo "$GH_CHECK" | jq -r '.gh.available')
   ```
   If GH_AVAILABLE is false: Skip with message "gh CLI not available. Skipping PR creation. Plan code is committed locally on branch." Set PR_FLOW_RESULT="skipped_no_gh". Continue to next step.

2. **Construct PR title and body from SUMMARY.md:**

   Read the SUMMARY.md that was just created in the previous step:
   ```bash
   SUMMARY_PATH=".planning/phases/${PHASE_DIR}/${PHASE}-${PLAN}-SUMMARY.md"
   ```

   Extract from SUMMARY.md:
   - One-liner: the bold line after the title (the substantive description)
   - Task commits section: the "## Task Commits" table

   Construct PR title: `${PHASE}-${PLAN}: ${ONE_LINER}` (truncate to 72 chars if needed)

   Construct PR body in markdown format:
   ```
   ## ${PHASE}-${PLAN}

   ${ONE_LINER}

   ### Task Commits
   ${TASK_COMMITS_TABLE}

   ### Build Gate
   **Result:** ${BUILD_GATE_RESULT}
   **Command:** ${BUILD_CMD}

   ### Context
   Phase: ${PHASE_NUMBER} - ${PHASE_NAME}
   Branch: $(git branch --show-current)
   ```

   Truncate body at 4000 chars to avoid shell argument limits.

3. **Push branch to remote and create PR:**
   ```bash
   # Push plan branch to remote (required for gh pr create)
   git push -u origin "$(git branch --show-current)" 2>/dev/null
   ```

   If push fails: set PR_FLOW_RESULT="skipped_push_failed", log "Could not push branch to remote. Skipping PR creation." Continue to next step.

   ```bash
   PR_RESULT=$(node ./.claude/hive/bin/hive-tools.js git create-pr \
     --base "${GIT_DEV_BRANCH}" \
     --title "${PR_TITLE}" \
     --body "${PR_BODY}" \
     --raw)
   PR_SUCCESS=$(echo "$PR_RESULT" | jq -r '.success')
   PR_URL=$(echo "$PR_RESULT" | jq -r '.pr_url // empty')
   ```

   If PR creation fails: log warning with error, set PR_FLOW_RESULT="failed_pr_create". Continue to next step (do NOT block execution).

4. **Self-merge the PR (single-terminal mode):**
   Extract PR number from URL:
   ```bash
   PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
   ```

   If PR_NUMBER is empty, fall back:
   ```bash
   PR_NUMBER=$(gh pr list --head "$(git branch --show-current)" --json number --jq '.[0].number' 2>/dev/null)
   ```

   Merge:
   ```bash
   MERGE_RESULT=$(node ./.claude/hive/bin/hive-tools.js git self-merge-pr "${PR_NUMBER}" --raw)
   MERGE_SUCCESS=$(echo "$MERGE_RESULT" | jq -r '.success')
   MERGE_STRATEGY=$(echo "$MERGE_RESULT" | jq -r '.strategy')
   ```

   Handle merge result:
   - success: true -> Log: "PR #${PR_NUMBER} merged (${MERGE_STRATEGY}). Branch deleted by gh." Set PR_FLOW_RESULT="merged".
   - success: false, error contains "merge conflict" -> Report conflict to user with options: resolve, skip, stop.
   - success: false, other error -> Log warning. Set PR_FLOW_RESULT="failed_merge". Continue.

5. **After successful merge, checkout dev and pull:**
   ```bash
   git checkout "${GIT_DEV_BRANCH}"
   git pull origin "${GIT_DEV_BRANCH}" 2>/dev/null || true
   ```

   This syncs the merge commit locally so the next plan branch forks from the latest dev state.

6. **Record PR result for SUMMARY update (optional):**
   If the workflow wants to append PR info to the existing SUMMARY.md, it can add a "## PR Flow" section. This is optional — the SUMMARY was already created, so this is an append:
   ```
   ## PR Flow

   **Result:** ${PR_FLOW_RESULT}
   **PR:** ${PR_URL}
   **Merge strategy:** ${MERGE_STRATEGY}
   ```

**Important notes for the implementer:**
- Do NOT modify any existing steps except reordering create_summary.
- The build_gate step already sets BUILD_GATE_RESULT and BUILD_CMD variables — use them directly.
- CONFIG_CONTENT is already loaded in init_context — do NOT re-read config.json.
- The PR body construction should use inline string building, not a template engine.
- Shell variable escaping: the PR body may contain markdown special chars. Write it to a temp file if needed, but try --body first with proper quoting.
- The create_pr subcommand accepts --base, --title, --body flags (verified in Phase 8).
- The self-merge-pr subcommand reads git_merge_strategy from config (merge by default, squash optional) — PR-04 is handled automatically.
  </action>
  <verify>
1. Read `.claude/hive/workflows/execute-plan.md` and verify:
   - The `create_summary` step appears BEFORE `create_pr_and_merge`
   - The `create_pr_and_merge` step appears BEFORE `generate_user_setup`
   - The new step includes: GIT_FLOW check, gh availability check, PR body construction from SUMMARY.md, git push, create-pr call, self-merge-pr call, dev checkout + pull
   - Skip conditions handle: flow=none, build gate failed, gh unavailable, push failed
2. Verify the step references BUILD_GATE_RESULT and BUILD_CMD variables set by the build_gate step
3. Verify the step does NOT re-read config.json (uses CONFIG_CONTENT from init_context)
  </verify>
  <done>
execute-plan.md has a create_pr_and_merge step that creates a PR from the plan branch to dev after the build gate passes and summary is created, then self-merges it and checks out dev. The step degrades gracefully when git flow is disabled, gh is unavailable, push fails, or merge encounters conflicts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync source and installed copies of execute-plan.md</name>
  <files>.claude/hive/workflows/execute-plan.md</files>
  <action>
After Task 1 modifies `.claude/hive/workflows/execute-plan.md` (the installed copy that Claude reads at runtime), also verify the source copy at `hive/workflows/execute-plan.md` is in sync.

**Check the current state of both files:**
```bash
diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md 2>/dev/null
```

The `.claude/hive/` directory is gitignored (local installed copy). The `hive/` directory is the git-tracked source. Both must have identical content.

**If they differ:** Copy the updated content from `.claude/hive/workflows/execute-plan.md` to `hive/workflows/execute-plan.md` (or vice versa — ensure both match).

**If the source file (`hive/workflows/execute-plan.md`) was already modified by the git status at the start of this session:** The installed copy may be behind. In that case, use the source as the reference and apply changes to both.

**Commit the source copy:**
```bash
git add hive/workflows/execute-plan.md
git commit -m "feat(10-01): add PR creation and self-merge to execute-plan workflow"
```

Note: The `.claude/` copy is not committed (gitignored), so only the `hive/` source copy appears in git.
  </action>
  <verify>
1. Run `diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md` and confirm no differences
2. Run `git log --oneline -1` and confirm the commit message references 10-01
  </verify>
  <done>
Source (`hive/workflows/execute-plan.md`) and installed (`.claude/hive/workflows/execute-plan.md`) copies are identical, and the source copy is committed to git.
  </done>
</task>

</tasks>

<verification>
1. Read the full execute-plan.md and trace the step ordering: init_context -> ... -> record_completion_time -> build_gate -> create_summary -> create_pr_and_merge -> generate_user_setup -> ...
2. Verify PR body construction references SUMMARY.md content
3. Verify all skip conditions are handled: git flow none, build gate failed, gh unavailable, push failed
4. Verify source and installed copies match
</verification>

<success_criteria>
- execute-plan.md contains create_pr_and_merge step between create_summary and generate_user_setup
- PR is created from plan branch to dev with SUMMARY.md content as body
- PR is self-merged immediately in single-terminal mode
- After merge, dev is checked out and pulled
- All degradation paths handled gracefully (no gh, no remote, merge conflicts)
- Source and installed copies in sync
</success_criteria>

<output>
After completion, create `.planning/phases/10-pr-workflow-integration/10-01-SUMMARY.md`
</output>
