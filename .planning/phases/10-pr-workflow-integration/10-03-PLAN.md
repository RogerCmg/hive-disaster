---
phase: 10-pr-workflow-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/hive/bin/hive-tools.js
  - .claude/hive/workflows/progress.md
autonomous: true

must_haves:
  truths:
    - "Running `hive-tools.js git git-status --raw` returns JSON with branch, ahead, behind, open_prs, git_flow, dev_branch"
    - "The progress display (/hive:progress) shows a Git Status section with current branch, ahead/behind info, and open PR count when git flow is enabled"
    - "When git flow is none, the Git Status section is omitted from progress display"
    - "When gh CLI is unavailable, open_prs defaults to 0 and gh_available is false"
    - "When no remote tracking branch exists, ahead/behind show 0 and has_remote is false"
  artifacts:
    - path: ".claude/hive/bin/hive-tools.js"
      provides: "git-status subcommand returning branch, ahead/behind, open PR count"
      contains: "cmdGitStatus"
    - path: ".claude/hive/workflows/progress.md"
      provides: "Git Status section in progress report"
      contains: "git_status"
  key_links:
    - from: ".claude/hive/workflows/progress.md (git_status step)"
      to: ".claude/hive/bin/hive-tools.js (cmdGitStatus)"
      via: "Node CLI call to git git-status subcommand"
      pattern: "git git-status --raw"
---

<objective>
Add a git-status subcommand to hive-tools.js and integrate it into the progress display so users see their current branch, ahead/behind status, and open PR count.

Purpose: Situational awareness. When working through multi-plan phases with branching, the user needs to see where they are in the git workflow at a glance. This completes INTG-05.

Output: New cmdGitStatus function in hive-tools.js, updated git CLI router, and new git_status step in progress.md.
</objective>

<execution_context>
@~/.claude/hive/workflows/execute-plan.md
@~/.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-pr-workflow-integration/10-RESEARCH.md
@.planning/phases/08-safety-configuration/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cmdGitStatus subcommand and git_status step to progress.md</name>
  <files>
    .claude/hive/bin/hive-tools.js
    .claude/hive/workflows/progress.md
  </files>
  <action>
**Part A: Add cmdGitStatus to hive-tools.js**

In `.claude/hive/bin/hive-tools.js`, add a new function `cmdGitStatus` near the other git subcommand functions (after `cmdGitCurrentBranch`, around line 5275). This is a NEW subcommand, separate from `cmdGitCurrentBranch` (which returns only the branch name and is used by execute-phase for branch validation).

```javascript
function cmdGitStatus(cwd, raw) {
  const config = loadConfig(cwd);

  // Current branch
  const branchResult = execCommand('git', ['rev-parse', '--abbrev-ref', 'HEAD'], { cwd });
  const branch = branchResult.success ? branchResult.stdout.trim() : 'unknown';

  // Ahead/behind (only if tracking branch exists)
  let ahead = 0, behind = 0, hasRemote = false;
  const trackResult = execCommand('git', ['rev-parse', '--abbrev-ref', '@{u}'], { cwd });
  if (trackResult.success) {
    hasRemote = true;
    const aheadResult = execCommand('git', ['rev-list', '--count', '@{u}..HEAD'], { cwd });
    const behindResult = execCommand('git', ['rev-list', '--count', 'HEAD..@{u}'], { cwd });
    ahead = aheadResult.success ? parseInt(aheadResult.stdout.trim(), 10) || 0 : 0;
    behind = behindResult.success ? parseInt(behindResult.stdout.trim(), 10) || 0 : 0;
  }

  // Open PR count (only if gh available)
  let openPRs = 0, ghAvailable = false;
  const ghResult = execCommand('gh', ['pr', 'list', '--state', 'open', '--json', 'number', '--jq', 'length'], { cwd });
  if (ghResult.success) {
    ghAvailable = true;
    openPRs = parseInt(ghResult.stdout.trim(), 10) || 0;
  }

  output({
    success: true,
    branch,
    ahead,
    behind,
    has_remote: hasRemote,
    open_prs: openPRs,
    gh_available: ghAvailable,
    git_flow: config.git_flow,
    dev_branch: config.git_dev_branch
  }, raw, branch);
}
```

Key design decisions:
- `cmdGitStatus` does NOT check `config.git_flow === 'none'` for bypass. This is an informational command (same rationale as `current-branch` — see decision in STATE.md). It always returns data regardless of flow config.
- `execCommand` is the existing spawnSync wrapper from Phase 8 that returns `{ success, stdout, stderr, exitCode }`.
- `output` is the existing helper that formats as JSON when `raw` is true, or as human-readable text when false.
- `loadConfig` is the existing config loader that provides `git_flow` and `git_dev_branch` with defaults.

**Register in the CLI router:**

Find the git subcommand dispatch section (around line 5930-5960). Add a new case for `git-status`:

```javascript
} else if (subcommand === 'git-status') {
  cmdGitStatus(cwd, raw);
```

Add before the `else` (unknown subcommand) case.

Also update the error message for unknown subcommands to include `git-status` in the available list.

**Part B: Add git_status step to progress.md**

In `.claude/hive/workflows/progress.md`, add a new step `git_status` between the existing `position` step and the `report` step. This step gathers git status data that is then included in the report.

Add this new step:

```markdown
<step name="git_status">
**Gather git status information (if git flow enabled):**

```bash
GIT_STATUS=$(node ./.claude/hive/bin/hive-tools.js git git-status --raw 2>/dev/null)
GIT_FLOW=$(echo "$GIT_STATUS" | jq -r '.git_flow // "none"')
```

If GIT_FLOW is not "none", extract display values:

```bash
GIT_BRANCH=$(echo "$GIT_STATUS" | jq -r '.branch')
GIT_AHEAD=$(echo "$GIT_STATUS" | jq -r '.ahead')
GIT_BEHIND=$(echo "$GIT_STATUS" | jq -r '.behind')
GIT_HAS_REMOTE=$(echo "$GIT_STATUS" | jq -r '.has_remote')
GIT_OPEN_PRS=$(echo "$GIT_STATUS" | jq -r '.open_prs')
GIT_GH_AVAILABLE=$(echo "$GIT_STATUS" | jq -r '.gh_available')
GIT_DEV_BRANCH=$(echo "$GIT_STATUS" | jq -r '.dev_branch')
```

Format ahead/behind display:
- has_remote false: "" (empty, no remote info)
- ahead=0, behind=0: "(up to date)"
- ahead>0, behind=0: "(${GIT_AHEAD} ahead)"
- ahead=0, behind>0: "(${GIT_BEHIND} behind)"
- both>0: "(${GIT_AHEAD} ahead, ${GIT_BEHIND} behind)"

If git-status command fails (node not found, etc.): skip git status section entirely.
</step>
```

Then update the `report` step to include the Git Status section. In the report template, after the "## Current Position" section and before "## Key Decisions Made", add:

```markdown
{If GIT_FLOW is not "none":}

## Git Status
Branch: ${GIT_BRANCH} ${AHEAD_BEHIND_DISPLAY}
Open PRs: ${GIT_OPEN_PRS} ${GIT_GH_AVAILABLE ? "" : "(gh CLI unavailable)"}
Flow: ${GIT_FLOW} (dev: ${GIT_DEV_BRANCH})
```

If GIT_FLOW is "none": omit the Git Status section entirely.
  </action>
  <verify>
1. Verify `cmdGitStatus` function exists in `.claude/hive/bin/hive-tools.js` with the correct structure (branch, ahead/behind, open_prs, git_flow, dev_branch)
2. Verify the git CLI router dispatches `git-status` to `cmdGitStatus`
3. Verify the "Available" error message includes `git-status`
4. Read `.claude/hive/workflows/progress.md` and verify:
   - `git_status` step exists between `position` and `report`
   - Report template includes "## Git Status" section
   - Git Status section is conditionally shown only when git_flow is not "none"
5. Test the subcommand: `node ./.claude/hive/bin/hive-tools.js git git-status --raw` should return valid JSON
  </verify>
  <done>
hive-tools.js has a cmdGitStatus function that returns branch, ahead/behind, open PR count, and git flow config. The progress.md workflow includes a git_status step that calls this subcommand and displays the results in the progress report when git flow is enabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync source/installed copies and commit</name>
  <files>
    .claude/hive/bin/hive-tools.js
    .claude/hive/workflows/progress.md
  </files>
  <action>
Sync source and installed copies of both modified files.

1. Check for differences:
```bash
diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js 2>/dev/null | head -40
diff hive/workflows/progress.md .claude/hive/workflows/progress.md 2>/dev/null
```

2. Ensure both file pairs are identical. The `.claude/hive/` copies are the installed (runtime) versions. The `hive/` copies are the git-tracked source. Sync them.

3. Commit the source copies:
```bash
git add hive/bin/hive-tools.js hive/workflows/progress.md
git commit -m "feat(10-03): add git-status subcommand and progress display integration"
```

Note: `.claude/` copies are gitignored.
  </action>
  <verify>
1. Run `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js | head -10` — ideally no differences (or only path-related differences)
2. Run `diff hive/workflows/progress.md .claude/hive/workflows/progress.md` — no differences
3. Run `git log --oneline -1` — commit message references 10-03
  </verify>
  <done>
Source and installed copies of hive-tools.js and progress.md are synced. Source copies committed to git.
  </done>
</task>

</tasks>

<verification>
1. Run `node ./.claude/hive/bin/hive-tools.js git git-status --raw` and verify valid JSON output
2. Read progress.md and confirm the Git Status section is present
3. Verify cmdGitStatus handles edge cases: no remote tracking, no gh CLI
4. Source and installed copies match
</verification>

<success_criteria>
- `git git-status --raw` returns JSON with branch, ahead, behind, open_prs, git_flow, dev_branch
- Progress display includes Git Status section when git flow is enabled
- Git Status section omitted when git flow is none
- Graceful degradation when gh unavailable or no remote tracking
- Source and installed copies in sync
</success_criteria>

<output>
After completion, create `.planning/phases/10-pr-workflow-integration/10-03-SUMMARY.md`
</output>
