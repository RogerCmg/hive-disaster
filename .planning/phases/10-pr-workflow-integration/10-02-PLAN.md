---
phase: 10-pr-workflow-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/hive/workflows/execute-phase.md
  - .claude/hive/workflows/complete-milestone.md
autonomous: true

must_haves:
  truths:
    - "After a plan's PR is merged to dev, the local plan branch is deleted via git branch -d (not -D)"
    - "The 'not yet merged' warning from Phase 9 is replaced with actual post-merge cleanup"
    - "Running /hive:complete-milestone with git flow enabled triggers Gate 3 build on dev, then merges dev to main via merge-dev-to-main subcommand"
    - "When git flow is none, the existing handle_branches step runs as before (backward compatible)"
    - "Gate 3 failure presents fix/skip/stop options identical to Gate 1 pattern"
  artifacts:
    - path: ".claude/hive/workflows/execute-phase.md"
      provides: "Post-merge branch cleanup replacing Phase 9 placeholder"
      contains: "delete-plan-branch"
    - path: ".claude/hive/workflows/complete-milestone.md"
      provides: "Dev-to-main merge with Gate 3 build validation"
      contains: "merge_dev_to_main"
  key_links:
    - from: ".claude/hive/workflows/execute-phase.md (branch cleanup)"
      to: ".claude/hive/workflows/execute-plan.md (create_pr_and_merge)"
      via: "Branch cleanup succeeds because PR self-merge already merged the branch to dev"
      pattern: "git branch -d"
    - from: ".claude/hive/workflows/complete-milestone.md (merge_dev_to_main)"
      to: "hive-tools.js cmdGitMergeDevToMain"
      via: "Node CLI call to merge-dev-to-main subcommand"
      pattern: "git merge-dev-to-main"
---

<objective>
Wire post-merge branch cleanup into execute-phase.md and add dev-to-main merge flow with Gate 3 validation to complete-milestone.md.

Purpose: Execute-phase needs to clean up plan branches after they are merged (replacing the Phase 9 placeholder). Complete-milestone needs to validate dev before merging to main, ensuring broken code never reaches the main branch.

Output: Updated execute-phase.md with active branch cleanup and updated complete-milestone.md with merge_dev_to_main step.
</objective>

<execution_context>
@~/.claude/hive/workflows/execute-plan.md
@~/.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-pr-workflow-integration/10-RESEARCH.md
@.planning/phases/09-branch-lifecycle-build-gates/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update execute-phase.md branch cleanup and add merge_dev_to_main to complete-milestone.md</name>
  <files>
    .claude/hive/workflows/execute-phase.md
    .claude/hive/workflows/complete-milestone.md
  </files>
  <action>
**Part A: Update execute-phase.md branch cleanup (INTG-01)**

In `.claude/hive/workflows/execute-phase.md`, find the plan branch cleanup step (step 6 in both team_mode and standalone_mode sections within execute_waves). The Phase 9 version has:

```
If cleanup fails with "not fully merged": log warning "Branch ${BRANCH_NAME} not yet merged -- skipping cleanup (will be cleaned after merge in Phase 10)". Do NOT force-delete.
```

Replace this with active post-merge cleanup. The key insight: by the time execute-phase cleanup runs, the plan has already been through execute-plan's create_pr_and_merge step, which merged the PR and deleted the remote branch. The local branch now needs cleanup.

Update the cleanup step in BOTH team_mode and standalone_mode sections:

```markdown
6. **Plan branch cleanup (git flow "github" only):**

   After wave completion and BEFORE proceeding to next wave, clean up plan branches that were merged during execute-plan's PR flow.

   For each completed plan in the wave (where git_flow is "github"):
   ```bash
   # Verify we are on dev (execute-plan should have left us here after PR merge)
   CURRENT=$(git branch --show-current)
   if [ "$CURRENT" != "${GIT_DEV_BRANCH}" ]; then
     git checkout "${GIT_DEV_BRANCH}" 2>/dev/null || true
   fi

   # Delete local plan branch (safe delete — succeeds because branch is merged to dev)
   CLEANUP=$(node ~/.claude/hive/bin/hive-tools.js git delete-plan-branch "${BRANCH_NAME}" --raw)
   CLEANUP_SUCCESS=$(echo "$CLEANUP" | jq -r '.success')
   ```

   If cleanup succeeds: log "Cleaned up branch: ${BRANCH_NAME}".
   If cleanup fails with "not fully merged": the plan's PR may not have been merged (gh unavailable, merge failed, etc.). Log warning: "Branch ${BRANCH_NAME} not fully merged to dev. Keeping for manual resolution." Do NOT force-delete.
   If cleanup fails with other error: log warning but do not block execution.

   Branch cleanup is BEST EFFORT. Stale branches are informational, not harmful.
```

Also update the **Note** at the top of each cleanup section. Remove the Phase 9 note that says "Since Phase 10 implements the actual PR and merge flow..." and replace with a note explaining the actual flow:

```
**Note:** Plan branches are merged to dev via PR self-merge in execute-plan.md. This cleanup step handles the LOCAL branch deletion. The remote branch is already deleted by `gh pr merge --delete-branch`.
```

**Part B: Add merge_dev_to_main step to complete-milestone.md (INTG-03)**

In `.claude/hive/workflows/complete-milestone.md`, add a new step `merge_dev_to_main` BEFORE the existing `handle_branches` step.

Insert this new step:

```markdown
<step name="merge_dev_to_main">

**Merge dev branch to main with Gate 3 validation (git flow only).**

Check git flow config:

```bash
CONFIG=$(cat .planning/config.json 2>/dev/null)
GIT_FLOW=$(echo "$CONFIG" | jq -r '.git.flow // "none"')
GIT_DEV_BRANCH=$(echo "$CONFIG" | jq -r '.git.dev_branch // "dev"')
```

**If GIT_FLOW is "none":** Skip this step entirely. The existing `handle_branches` step handles legacy branching.

**Gate 3 (pre-main build validation):**

```bash
PRE_MAIN=$(echo "$CONFIG" | jq -r '.git.build_gates.pre_main // true')
```

If PRE_MAIN is true:

```bash
# Ensure we are on dev for the build
git checkout "${GIT_DEV_BRANCH}"

BUILD_RESULT=$(node ./.claude/hive/bin/hive-tools.js git run-build-gate --raw)
BUILD_SUCCESS=$(echo "$BUILD_RESULT" | jq -r '.success')
BUILD_SKIPPED=$(echo "$BUILD_RESULT" | jq -r '.skipped // false')
BUILD_TIMED_OUT=$(echo "$BUILD_RESULT" | jq -r '.timedOut // false')
BUILD_CMD=$(echo "$BUILD_RESULT" | jq -r '.command // "unknown"')
BUILD_EXIT_CODE=$(echo "$BUILD_RESULT" | jq -r '.exitCode // "N/A"')
BUILD_STDERR=$(echo "$BUILD_RESULT" | jq -r '.stderr // ""')
```

Handle results using the same pattern as the execute-plan build gate:
- BUILD_SKIPPED true: "No build command detected. Skipping Gate 3." Continue to merge.
- BUILD_SUCCESS true: "Gate 3 passed (command: ${BUILD_CMD})." Continue to merge.
- BUILD_TIMED_OUT true: Present timeout with fix/increase-timeout/skip/stop options.
- BUILD_SUCCESS false: Present failure with fix/skip/stop options.

If user chooses "fix": investigate, fix, commit fix, re-run gate.
If user chooses "skip": log "Gate 3 skipped by user." Continue to merge.
If user chooses "stop": abort milestone completion. Do NOT proceed to merge.

**Merge dev to main:**

```bash
MERGE_RESULT=$(node ./.claude/hive/bin/hive-tools.js git merge-dev-to-main --raw)
MERGE_SUCCESS=$(echo "$MERGE_RESULT" | jq -r '.success')
MERGE_FROM=$(echo "$MERGE_RESULT" | jq -r '.from')
MERGE_TO=$(echo "$MERGE_RESULT" | jq -r '.to')
```

If success: log "Merged ${MERGE_FROM} into ${MERGE_TO}." Continue to git_tag.
If failure (merge conflict): present to user with options:
- "resolve" — User resolves conflicts manually, then proceed
- "abort" — Abort the merge, cancel milestone completion
- "skip" — Skip the merge, continue with milestone completion (tag only)

**After merge, return to dev:**

```bash
git checkout "${GIT_DEV_BRANCH}"
```

**If GIT_FLOW is "github":** After this step completes, SKIP the `handle_branches` step entirely (legacy branching and git_flow are mutually exclusive paths).

</step>
```

Also, in the existing `handle_branches` step, add a guard at the top:

```markdown
**If GIT_FLOW is "github":** This step was already handled by `merge_dev_to_main`. Skip.
```

This ensures the two paths are mutually exclusive: git_flow="github" uses merge_dev_to_main, branching_strategy="phase"/"milestone" uses handle_branches, and "none" for both skips both.
  </action>
  <verify>
1. Read `.claude/hive/workflows/execute-phase.md` and verify:
   - Branch cleanup step no longer contains the "not yet merged -- skipping cleanup (will be cleaned after merge in Phase 10)" message
   - Cleanup uses `delete-plan-branch` subcommand with best-effort handling
   - Both team_mode and standalone_mode sections have the updated cleanup
2. Read `.claude/hive/workflows/complete-milestone.md` and verify:
   - `merge_dev_to_main` step exists BEFORE `handle_branches`
   - Gate 3 uses `run-build-gate` with pass/fail/timeout handling
   - `merge-dev-to-main` subcommand is called after Gate 3 passes
   - `handle_branches` has a guard to skip when GIT_FLOW is "github"
   - Conflict handling offers resolve/abort/skip options
  </verify>
  <done>
execute-phase.md has active post-merge branch cleanup (replacing Phase 9 placeholder). complete-milestone.md has a merge_dev_to_main step with Gate 3 validation that runs before the git tag. Legacy handle_branches and new merge_dev_to_main are mutually exclusive paths based on git_flow config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync source and installed copies of modified workflow files</name>
  <files>
    .claude/hive/workflows/execute-phase.md
    .claude/hive/workflows/complete-milestone.md
  </files>
  <action>
Sync the source (`hive/`) and installed (`.claude/hive/`) copies of both modified workflow files.

1. Check for differences:
```bash
diff hive/workflows/execute-phase.md .claude/hive/workflows/execute-phase.md 2>/dev/null
diff hive/workflows/complete-milestone.md .claude/hive/workflows/complete-milestone.md 2>/dev/null
```

2. Ensure both file pairs are identical. Copy from `.claude/hive/` to `hive/` (or vice versa — ensure both match).

3. Commit the source copies:
```bash
git add hive/workflows/execute-phase.md hive/workflows/complete-milestone.md
git commit -m "feat(10-02): wire branch cleanup and dev-to-main merge into workflows"
```

Note: `.claude/` copies are gitignored — only source copies are committed.
  </action>
  <verify>
1. Run `diff hive/workflows/execute-phase.md .claude/hive/workflows/execute-phase.md` — no differences
2. Run `diff hive/workflows/complete-milestone.md .claude/hive/workflows/complete-milestone.md` — no differences
3. Run `git log --oneline -1` — commit message references 10-02
  </verify>
  <done>
Source and installed copies of execute-phase.md and complete-milestone.md are identical, and source copies are committed to git.
  </done>
</task>

</tasks>

<verification>
1. Read execute-phase.md and confirm branch cleanup is now active (post-merge pattern, not Phase 9 placeholder)
2. Read complete-milestone.md and confirm merge_dev_to_main step exists with Gate 3
3. Verify the two branch handling paths (git_flow vs branching_strategy) are mutually exclusive
4. Verify all source/installed copies are in sync
</verification>

<success_criteria>
- execute-phase branch cleanup works post-merge (no "will be cleaned after merge in Phase 10" message)
- complete-milestone has Gate 3 + dev-to-main merge before git tag
- Legacy handle_branches preserved for branching_strategy users
- git_flow="github" and branching_strategy paths are mutually exclusive
- All file copies synced
</success_criteria>

<output>
After completion, create `.planning/phases/10-pr-workflow-integration/10-02-SUMMARY.md`
</output>
