---
phase: 06-transcript-analysis
plan: "02"
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - hive/bin/hive-tools.js
  - hive/workflows/analyze-session.md
  - agents/hive-recall-analyst.md
  - .claude/hive/workflows/analyze-session.md
  - .claude/agents/hive-recall-analyst.md
autonomous: true

must_haves:
  truths:
    - "Running `hive-tools.js telemetry transcript --cross-session` returns cross-session pattern data including quality trend, recurring patterns, and recurring recommendations from accumulated session_summary events"
    - "The analyst agent can receive cross-session context (prior session summaries) and incorporate trend awareness into its analysis"
    - "Cross-session analysis uses a sliding window of recent session summaries (last 10) to avoid stale pattern references"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "detectCrossSessionPatterns helper function and --cross-session flag on transcript command"
      contains: "detectCrossSessionPatterns"
    - path: "hive/workflows/analyze-session.md"
      provides: "Cross-session step that queries prior summaries and passes context to analyst"
      contains: "cross-session"
    - path: "agents/hive-recall-analyst.md"
      provides: "Cross-session analysis guidance in agent prompt"
      contains: "cross-session"
  key_links:
    - from: "hive/workflows/analyze-session.md"
      to: "hive/bin/hive-tools.js"
      via: "telemetry transcript --cross-session CLI invocation"
      pattern: "cross-session"
    - from: "hive/bin/hive-tools.js"
      to: "events.jsonl"
      via: "query session_summary events for pattern detection"
      pattern: "session_summary"
    - from: "hive/workflows/analyze-session.md"
      to: "agents/hive-recall-analyst.md"
      via: "Task() prompt includes cross-session context"
      pattern: "cross-session|prior.session|trend"
---

<objective>
Add cross-session pattern detection to the transcript analysis pipeline, enabling quality trend tracking and recurring pattern identification across multiple analyzed sessions.

Purpose: Detect recurring failures, implicit user preferences, and agent behavior drift across sessions by querying accumulated session_summary events and incorporating cross-session context into the analyst's prompt (TRANS-03).

Output: Enhanced `telemetry transcript` command with `--cross-session` flag, updated workflow with cross-session step, updated analyst agent with cross-session guidance.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-transcript-analysis/06-RESEARCH.md
@.planning/phases/06-transcript-analysis/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-session pattern detection to hive-tools.js</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
**Add `detectCrossSessionPatterns(cwd)` function** near the other telemetry helpers (after `cmdTelemetryTranscript`):

This function:
1. Loads events from events.jsonl using the existing pattern: `safeReadFile` + split + filter + JSON.parse + filter for `type === 'session_summary'`.
2. If fewer than 2 session_summary events exist, return `null` (not enough data for cross-session analysis).
3. Take only the most recent 10 events (sliding window to avoid stale patterns). Use `.slice(-10)`.
4. Compute quality trend:
   - `scores` = array of `e.data.quality_score` values (filter nullish)
   - `avgScore` = average of all scores
   - `recentAvg` = average of last 3 scores
   - `trend` = `recentAvg > avgScore + 5 ? 'improving' : recentAvg < avgScore - 5 ? 'declining' : 'stable'` (5-point threshold to avoid noise)
5. Compute waste trend:
   - Same approach with `e.data.waste_pct`
6. Aggregate recurring patterns:
   - Flatten all `e.data.patterns` arrays into a frequency map
   - Filter to patterns appearing 2+ times
   - Sort by frequency descending, take top 5
7. Aggregate recurring recommendations:
   - Same approach with `e.data.recommendations`
   - Filter to 2+ occurrences, top 3
8. Aggregate user preferences:
   - Same with `e.data.user_preferences`
   - Filter to 2+ occurrences, top 3
9. Return result object:
   ```
   {
     sessions_analyzed: events.length,
     window_size: windowedEvents.length,
     avg_quality: Math.round(avgScore),
     quality_trend: trend,
     avg_waste: Math.round(avgWaste),
     waste_trend: wasteTrend,
     recurring_patterns: [...],      // [{pattern, count}]
     recurring_recommendations: [...], // [{recommendation, count}]
     recurring_preferences: [...],    // [{preference, count}]
   }
   ```

**Add `--cross-session` flag to `cmdTelemetryTranscript`:**

At the beginning of `cmdTelemetryTranscript`, check for a `crossSession` boolean parameter. If true:
- Skip transcript extraction entirely
- Call `detectCrossSessionPatterns(cwd)` instead
- If result is null, `error('Not enough session summaries for cross-session analysis (need at least 2)')`
- Otherwise output the result via `output(result, raw)`

**Update the telemetry case dispatcher** to pass the `--cross-session` flag:

In the `transcript` subcommand branch, detect `--cross-session`:
```javascript
} else if (subcommand === 'transcript') {
  const crossSession = args.indexOf('--cross-session') !== -1;
  if (crossSession) {
    cmdTelemetryTranscript(cwd, null, raw, true);
  } else {
    const sessionId = args[2] && !args[2].startsWith('--') ? args[2] : null;
    cmdTelemetryTranscript(cwd, sessionId, raw, false);
  }
}
```

Update `cmdTelemetryTranscript` signature to accept the 4th `crossSession` parameter.
  </action>
  <verify>
1. `grep -c 'detectCrossSessionPatterns' hive/bin/hive-tools.js` returns 2+ (definition + usage).
2. `grep 'cross-session' hive/bin/hive-tools.js` finds the flag handling in the dispatcher.
3. Run `node ./hive/bin/hive-tools.js telemetry transcript --cross-session --raw 2>&1` -- should either return cross-session data (if session_summary events exist) or an error about not enough summaries or disabled config. Should NOT show "Unknown telemetry subcommand".
  </verify>
  <done>
The `detectCrossSessionPatterns` function queries accumulated session_summary events with a sliding window of 10, computes quality/waste trends via simple averaging, and aggregates recurring patterns/recommendations/preferences by frequency. The `--cross-session` flag on the transcript command routes to this function instead of transcript extraction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update workflow and agent for cross-session awareness, sync mirror copies</name>
  <files>hive/workflows/analyze-session.md, agents/hive-recall-analyst.md, .claude/hive/workflows/analyze-session.md, .claude/agents/hive-recall-analyst.md</files>
  <action>
**Update hive/workflows/analyze-session.md:**

Add a new step between the existing `extract_transcript` step and the `analyze` step:

`query_cross_session`: Run `node ~/.claude/hive/bin/hive-tools.js telemetry transcript --cross-session --raw 2>/dev/null`. If this succeeds (exit code 0) and returns valid JSON, store the cross-session data. If it fails (not enough data, disabled), set cross-session data to null and continue without it. This step is NON-BLOCKING -- cross-session analysis is a bonus, not a requirement.

**Update the `analyze` step** in the workflow:

When spawning the analyst via Task(), if cross-session data is available, include it in the prompt:

```
{If cross-session data is available:}
<cross_session_context>
Quality trend: {quality_trend} (avg: {avg_quality}, recent: {recent avg})
Waste trend: {waste_trend} (avg: {avg_waste})
Recurring patterns (seen in multiple sessions):
{For each recurring pattern: "- {pattern} (seen {count} times)"}
Recurring recommendations:
{For each: "- {recommendation} (seen {count} times)"}
User preferences across sessions:
{For each: "- {preference} (seen {count} times)"}
</cross_session_context>

Consider these cross-session trends when analyzing the current session. Note if current session patterns align with or diverge from historical trends.
```

**Update the `report` step** in the workflow:

After displaying the single-session analysis results, if cross-session data was available, add a "Cross-Session Trends" section showing:
- Quality trend (improving/stable/declining) with average score
- Waste trend with average percentage
- Recurring patterns that also appeared in this session (if any overlap)
- Recurring unaddressed recommendations

**Update agents/hive-recall-analyst.md:**

Add a `<cross_session_guidance>` section (after the existing analysis_framework, before output_format):

When cross-session context is provided:
1. Compare current session patterns against historical recurring patterns
2. Note if quality_score is above or below the historical average
3. Note if waste_pct shows improvement or regression
4. Flag any NEW patterns not seen in prior sessions
5. Highlight recurring recommendations that remain unaddressed
6. Include a `cross_session_notes` field in the JSON output (array of max 3 strings) -- only when cross-session context is provided; omit the field entirely when no cross-session data is available.

Update the `<output_format>` section to document the optional `cross_session_notes` field.

**Sync mirror copies:**

1. Copy updated `agents/hive-recall-analyst.md` to `.claude/agents/hive-recall-analyst.md` (no path changes needed for agents).
2. Copy updated `hive/workflows/analyze-session.md` to `.claude/hive/workflows/analyze-session.md` with `~/.claude/` replaced by `./.claude/` in all CLI command paths.

Use `git add -f` for the `.claude/` files.
  </action>
  <verify>
1. `grep 'cross-session\|cross_session' hive/workflows/analyze-session.md` returns multiple matches (query step, analyze step, report step).
2. `grep 'cross_session' agents/hive-recall-analyst.md` returns matches for the guidance section and output format.
3. Verify mirror sync: `diff <(sed 's|~/\\.claude/|./.claude/|g' hive/workflows/analyze-session.md) .claude/hive/workflows/analyze-session.md` should show no differences (or only expected whitespace).
4. `diff agents/hive-recall-analyst.md .claude/agents/hive-recall-analyst.md` should show no differences.
5. `grep './.claude/' .claude/hive/workflows/analyze-session.md | head -3` confirms installed copy uses relative paths.
  </verify>
  <done>
The workflow queries cross-session patterns before analysis, passes them as context to the analyst agent, and displays cross-session trends in the report. The analyst agent has guidance for comparing current session against historical trends and includes an optional `cross_session_notes` field in output. All mirror copies are synchronized with correct path conventions.
  </done>
</task>

</tasks>

<verification>
1. The `--cross-session` flag on `telemetry transcript` correctly queries session_summary events and returns trend data
2. `detectCrossSessionPatterns` uses a sliding window of 10 most recent events
3. The workflow gracefully handles missing cross-session data (non-blocking)
4. The analyst agent includes cross-session comparison guidance
5. Mirror copies are synchronized and use correct path conventions
6. Quality and waste trends use simple averaging with a 5-point threshold to avoid noise
</verification>

<success_criteria>
- `telemetry transcript --cross-session` returns cross-session analysis data when 2+ session_summary events exist
- The analyze-session workflow incorporates cross-session context into the analyst prompt when available
- The analyst agent compares current session against historical trends and flags new patterns
- Cross-session analysis is non-blocking -- workflow continues with single-session analysis even if no prior summaries exist
- All mirror copies synchronized with correct path conventions
</success_criteria>

<output>
After completion, create `.planning/phases/06-transcript-analysis/06-02-SUMMARY.md`
</output>
