---
phase: 04-feedback-loop
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
autonomous: true

must_haves:
  truths:
    - "Running `hive-tools.js telemetry digest` produces INSIGHTS.md with recurring patterns, deviation trends, agent performance tables, and recommendations"
    - "INSIGHTS.md contains machine-parseable <!-- recall-start --> / <!-- recall-end --> markers around top patterns"
    - "Init commands return a `recall_context` field extracted from INSIGHTS.md top patterns"
    - "events.jsonl remains gitignored and INSIGHTS.md remains committable"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "Enhanced cmdTelemetryDigest with pattern detection, getRecallContext helper, recall_context in init commands"
      contains: "recall-start"
  key_links:
    - from: "cmdTelemetryDigest"
      to: "INSIGHTS.md"
      via: "fs.writeFileSync with recall markers"
      pattern: "recall-start"
    - from: "getRecallContext"
      to: "INSIGHTS.md"
      via: "regex extraction of recall-start/recall-end block"
      pattern: "recall-start.*recall-end"
    - from: "cmdInitExecutePhase"
      to: "getRecallContext"
      via: "result.recall_context assignment"
      pattern: "recall_context"
---

<objective>
Enhance the telemetry digest with pattern detection, trend analysis, and recommendations, then wire recall context extraction into all agent-spawning init commands.

Purpose: This is the data foundation of the feedback loop. The enhanced digest transforms raw events into actionable patterns, and the init commands make those patterns available to every workflow that spawns agents.
Output: Enhanced cmdTelemetryDigest function, getRecallContext() helper, recall_context field in all relevant init commands -- all in hive/bin/hive-tools.js.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-feedback-loop/04-RESEARCH.md
@hive/bin/hive-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance cmdTelemetryDigest with pattern detection and recall markers</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
Replace the existing `cmdTelemetryDigest` function (lines ~4437-4576) with an enhanced version that adds:

1. **Recurring pattern detection** (after existing agent/deviation/tool-error aggregation):
   - Count deviation types by `data.deviation_type || data.description || 'unknown'`, tracking count and phases
   - Count tool errors by `data.tool + ':' + (data.error_type || 'error')` combination
   - Count verification gap levels by `data.level` (truth/artifact/wiring)
   - Count checkpoint outcomes from `data.outcome`

2. **Deviation trend analysis**:
   - Split deviation events at midpoint, compare first-half count vs second-half count
   - Report trend as "decreasing", "increasing", or "stable"

3. **Recommendations section**:
   - If any deviation type recurs 3+ times: recommend auto-check for that type
   - If any tool error recurs 3+ times: recommend guard for that tool
   - If deviation trend is increasing: warn about quality regression
   - If deviation trend is decreasing: acknowledge improvement

4. **Top Patterns section with recall markers**:
   - Add `## Top Patterns` section AFTER the existing sections (Event Summary, Agent Performance, Recent Deviations, Tool Errors)
   - Wrap content in `<!-- recall-start -->` and `<!-- recall-end -->` HTML comments
   - Each pattern is a single dash-prefixed line with category prefix:
     - `PATTERN:` for recurring issues (top 3 by frequency from deviations and tool errors)
     - `TREND:` for deviation trend direction
     - `REC:` for recommendations (max 2)
   - Cap at 5 total lines within the recall markers
   - If no meaningful patterns exist (no deviations, no tool errors), include a single line: `- No actionable patterns detected yet.`

5. **Remove Phase 1 footer**: Delete the `*Phase 1 digest -- enhanced analysis available in Phase 4*` line and the separator line above it. Replace with `---` followed by `*Recall digest v2 -- generated by hive-tools.js telemetry digest*`.

6. **Add generation timestamp** in a machine-readable format: after the `*Generated:*` line, add `*Digest version: 2*` so the recall extraction can verify format.

Preserve ALL existing sections (Event Summary table, Agent Performance table, Recent Deviations, Tool Errors). The new sections (Recommendations, Top Patterns) are ADDED after the existing ones.

For the empty-events stub case: also replace the Phase 1 footer text with the v2 footer. Add empty recall markers:
```
## Top Patterns

<!-- recall-start -->
- No actionable patterns detected yet.
<!-- recall-end -->
```
  </action>
  <verify>
Run `node hive/bin/hive-tools.js telemetry digest --raw` from project root. Verify:
1. Output JSON has `generated: true`
2. Read the generated `.planning/telemetry/INSIGHTS.md` and confirm it contains:
   - `## Top Patterns` section
   - `<!-- recall-start -->` and `<!-- recall-end -->` markers
   - `*Recall digest v2*` footer (not Phase 1 footer)
   - All original sections still present (Event Summary, Agent Performance, Recent Deviations, Tool Errors)
3. No syntax errors: `node -e "require('./hive/bin/hive-tools.js')"` exits cleanly (or equivalent: `node hive/bin/hive-tools.js --help` runs without error)
  </verify>
  <done>cmdTelemetryDigest produces INSIGHTS.md with pattern detection, trend analysis, recommendations, and machine-parseable recall markers. Phase 1 footer is replaced with v2 footer.</done>
</task>

<task type="auto">
  <name>Task 2: Add getRecallContext helper and inject recall_context into init commands</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
1. **Add `getRecallContext(cwd)` helper function** near the other telemetry helpers (around line ~560, after `parseSinceDuration` or similar). Implementation:
   ```javascript
   function getRecallContext(cwd) {
     const insightsPath = path.join(cwd, '.planning', 'telemetry', 'INSIGHTS.md');
     const content = safeReadFile(insightsPath);
     if (!content) return null;
     const match = content.match(/<!-- recall-start -->\n([\s\S]*?)<!-- recall-end -->/);
     if (!match) return null;
     const patterns = match[1].trim();
     if (!patterns || patterns === '- No actionable patterns detected yet.') return null;
     return patterns;
   }
   ```
   Key: returns `null` when INSIGHTS.md doesn't exist, has no recall markers, or only has the "no patterns" placeholder. This prevents empty/useless recall blocks in agent prompts.

2. **Add `recall_context` to agent-spawning init commands**. For each of these functions, add `result.recall_context = getRecallContext(cwd);` just before the `output(result, raw);` call:

   - `cmdInitExecutePhase` (~line 3736): spawns executor agents
   - `cmdInitPlanPhase` (~line 3832): spawns researcher/planner agents
   - `cmdInitQuick` (~line 3962): spawns planner/executor agents
   - `cmdInitNewProject` (~line 3888): spawns researcher agents
   - `cmdInitNewMilestone` (~line 3916): spawns researcher agents
   - `cmdInitVerifyWork` (~line 4019): spawns verifier/planner agents
   - `cmdInitMapCodebase` (~line 4205): spawns mapper agents
   - `cmdInitPhaseOp` (~line 4050): spawns researcher agents (used by research-phase, discuss-phase)

   Do NOT add to display-only commands that don't spawn agents:
   - `cmdInitResume` (routes to other workflows, doesn't spawn directly)
   - `cmdInitTodos` (display-only)
   - `cmdInitProgress` (display-only)
   - `cmdInitMilestoneOp` (display-only)

3. **Verify the recall_context field propagates correctly** by confirming that `cmdInitExecutePhase` returns it when INSIGHTS.md exists with recall markers.
  </action>
  <verify>
1. Generate a digest first: `node hive/bin/hive-tools.js telemetry digest --raw`
2. Then check init output includes recall: `node hive/bin/hive-tools.js init execute-phase 04-feedback-loop --raw | grep -o '"recall_context"'` should output `"recall_context"`
3. Check plan-phase init too: `node hive/bin/hive-tools.js init plan-phase 04-feedback-loop --raw | grep -o '"recall_context"'`
4. Verify display-only commands do NOT have it: `node hive/bin/hive-tools.js init progress --raw | grep -c '"recall_context"'` should output `0`
5. No syntax errors: `node -c "require('./hive/bin/hive-tools.js')"` or `node hive/bin/hive-tools.js --help`
  </verify>
  <done>getRecallContext() helper exists and returns extracted patterns from INSIGHTS.md. All 8 agent-spawning init commands include recall_context in their JSON output. Display-only init commands do not include it.</done>
</task>

</tasks>

<verification>
1. `node hive/bin/hive-tools.js telemetry digest --raw` succeeds and generates INSIGHTS.md
2. Generated INSIGHTS.md contains all sections: Event Summary, Agent Performance, Recent Deviations, Tool Errors, Recommendations (if applicable), Top Patterns with recall markers
3. `node hive/bin/hive-tools.js init execute-phase 04-feedback-loop --raw` includes `recall_context` field
4. `node hive/bin/hive-tools.js init plan-phase 04-feedback-loop --raw` includes `recall_context` field
5. No regression: existing telemetry commands (emit, query, stats, rotate) still work
6. .gitignore still excludes events.jsonl (FEED-05 verified)
7. INSIGHTS.md path is NOT in .gitignore (FEED-06 verified)
</verification>

<success_criteria>
- Enhanced digest produces INSIGHTS.md with pattern detection, trends, recommendations, and recall markers
- getRecallContext() extracts patterns from INSIGHTS.md via recall-start/recall-end markers
- 8 agent-spawning init commands return recall_context field
- 4 display-only init commands do NOT return recall_context
- No breaking changes to existing telemetry or init functionality
</success_criteria>

<output>
After completion, create `.planning/phases/04-feedback-loop/04-01-SUMMARY.md`
</output>
