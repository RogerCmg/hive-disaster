---
phase: 14-multi-worker-safety
plan: 02
type: execute
wave: 2
depends_on: [14-01]
files_modified: [hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js, hive/workflows/execute-plan.md, .claude/hive/workflows/execute-plan.md, hive/workflows/manage-repo.md, .claude/hive/workflows/manage-repo.md]
autonomous: true

must_haves:
  truths:
    - "A plan can specify merge_strategy in PLAN.md frontmatter to override the global config"
    - "self-merge-pr accepts an optional --strategy flag that takes precedence over config"
    - "execute-plan reads merge_strategy from plan frontmatter and passes it to self-merge-pr"
    - "manage-repo passes per-entry merge strategy when processing queue entries"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "self-merge-pr with --strategy override"
      contains: "strategyOverride"
    - path: ".claude/hive/bin/hive-tools.js"
      provides: "Installed copy identical to hive/bin/hive-tools.js"
      contains: "strategyOverride"
    - path: "hive/workflows/execute-plan.md"
      provides: "Reads merge_strategy from PLAN.md frontmatter, passes to self-merge-pr"
      contains: "merge_strategy"
    - path: "hive/workflows/manage-repo.md"
      provides: "Passes per-entry merge strategy to self-merge-pr"
      contains: "merge_strategy"
  key_links:
    - from: "hive/workflows/execute-plan.md"
      to: "hive/bin/hive-tools.js cmdGitSelfMergePr"
      via: "--strategy flag from PLAN.md frontmatter"
      pattern: "--strategy"
    - from: "hive/bin/hive-tools.js cmdGitSelfMergePr"
      to: "gh pr merge"
      via: "strategyOverride || config.git_merge_strategy"
      pattern: "strategyOverride"
    - from: "hive/bin/hive-tools.js cmdGitQueueSubmit"
      to: "queue entry merge_strategy field"
      via: "--merge-strategy option stored in entry"
      pattern: "merge_strategy"
---

<objective>
Enable per-plan merge strategy override via PLAN.md frontmatter, so individual plans can use squash or rebase while the project defaults to merge commits.

Purpose: MULTI-02 allows fine-grained control where specific plans (e.g., large refactors) can squash their commits while most plans preserve full commit history via merge commits.

Output: Updated self-merge-pr with strategy override, updated execute-plan.md and manage-repo.md to read and pass per-plan strategy.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-multi-worker-safety/14-01-SUMMARY.md
@hive/bin/hive-tools.js
@hive/workflows/execute-plan.md
@hive/workflows/manage-repo.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --strategy override to self-merge-pr and --merge-strategy to queue-submit in hive-tools.js</name>
  <files>hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js</files>
  <action>
  Modify hive-tools.js in these specific functions:

  **1. cmdGitSelfMergePr (line ~5479):**
  - Change function signature from `cmdGitSelfMergePr(cwd, prNumber, raw)` to `cmdGitSelfMergePr(cwd, prNumber, strategyOverride, raw)`
  - Change merge strategy resolution to: `const mergeStrategy = strategyOverride || config.git_merge_strategy || 'merge';`
  - Validate strategyOverride if provided: must be one of 'merge', 'squash', 'rebase' or null. If invalid, output error and return.

  **2. CLI dispatch for self-merge-pr (line ~6391):**
  - Parse `--strategy` flag: `const strategyIdx = args.indexOf('--strategy'); const strategy = strategyIdx !== -1 ? args[strategyIdx + 1] : null;`
  - Pass to function: `cmdGitSelfMergePr(cwd, args[2], strategy, raw);`

  **3. cmdGitQueueSubmit (line ~5633):**
  - Accept `merge_strategy` option: add `merge_strategy: options.merge_strategy || null` to the entry object.
  - This stores the per-plan strategy so manage-repo can pass it to self-merge-pr later.

  **4. CLI dispatch for queue-submit (line ~6401):**
  - Parse `--merge-strategy` flag: `const mergeStratIdx = args.indexOf('--merge-strategy'); options.merge_strategy = mergeStratIdx !== -1 ? args[mergeStratIdx + 1] : null;`
  - Pass it through to cmdGitQueueSubmit via the options object.

  **5. Ensure both copies are identical:** After modifying `hive/bin/hive-tools.js`, copy it to `.claude/hive/bin/hive-tools.js`.
  </action>
  <verify>
  Run: `node hive/bin/hive-tools.js git self-merge-pr 999 --strategy squash --raw 2>&1` — should attempt squash merge (will fail due to no PR 999, but the error should not be about strategy parsing).
  Run: `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js` returns no differences.
  </verify>
  <done>
  self-merge-pr accepts --strategy flag that overrides global config. queue-submit stores merge_strategy in entry. Invalid strategies are rejected. Both copies identical.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update execute-plan.md and manage-repo.md to pass per-plan merge strategy</name>
  <files>hive/workflows/execute-plan.md, .claude/hive/workflows/execute-plan.md, hive/workflows/manage-repo.md, .claude/hive/workflows/manage-repo.md</files>
  <action>
  **1. execute-plan.md — step "create_pr_and_merge":**

  In step 4 (self-merge the PR, around line 752), before the self-merge-pr call, add logic to read merge_strategy from the plan frontmatter:

  ```bash
  # Read per-plan merge strategy from frontmatter (overrides global config)
  PLAN_MERGE_STRATEGY=$(node ./.claude/hive/bin/hive-tools.js frontmatter get "${PLAN_PATH}" --field merge_strategy --raw 2>/dev/null | jq -r '.value // empty')

  # Build strategy flag
  STRATEGY_FLAG=""
  if [ -n "$PLAN_MERGE_STRATEGY" ]; then
    STRATEGY_FLAG="--strategy ${PLAN_MERGE_STRATEGY}"
  fi
  ```

  Update the self-merge-pr call to include the strategy flag:
  ```bash
  MERGE_RESULT=$(node ./.claude/hive/bin/hive-tools.js git self-merge-pr "${PR_NUMBER}" ${STRATEGY_FLAG} --raw)
  ```

  Also in the queue-submit section (step 3.5, repo_manager path), pass merge_strategy to queue-submit:
  ```bash
  # Include per-plan merge strategy if specified
  MERGE_STRAT_FLAG=""
  if [ -n "$PLAN_MERGE_STRATEGY" ]; then
    MERGE_STRAT_FLAG="--merge-strategy ${PLAN_MERGE_STRATEGY}"
  fi

  QUEUE_RESULT=$(node ./.claude/hive/bin/hive-tools.js git queue-submit \
    --plan-id "${PHASE}-${PLAN}" \
    --branch "$(git branch --show-current)" \
    --wave "${PLAN_WAVE}" \
    --pr-number "${PR_NUMBER}" \
    --pr-url "${PR_URL}" \
    ${MERGE_STRAT_FLAG} \
    --raw)
  ```

  Move the PLAN_MERGE_STRATEGY read to early in step 3.5 (before the repo_manager check) so it's available for both paths.

  **2. manage-repo.md — step "process_waves":**

  In the merge PR step (step c), update to pass per-entry merge_strategy:
  ```bash
  # Pass per-entry merge strategy if stored
  ENTRY_STRATEGY=$(echo "$ENTRY" | jq -r '.merge_strategy // empty')
  STRATEGY_FLAG=""
  if [ -n "$ENTRY_STRATEGY" ]; then
    STRATEGY_FLAG="--strategy ${ENTRY_STRATEGY}"
  fi

  node ~/.claude/hive/bin/hive-tools.js git self-merge-pr "${PR_NUMBER}" ${STRATEGY_FLAG} --raw
  ```

  **3. Copy workflow files to installed location:**
  - Copy `hive/workflows/execute-plan.md` to `.claude/hive/workflows/execute-plan.md`
  - Copy `hive/workflows/manage-repo.md` to `.claude/hive/workflows/manage-repo.md`
  </action>
  <verify>
  Grep execute-plan.md for "merge_strategy" — should find frontmatter read and strategy flag construction.
  Grep manage-repo.md for "merge_strategy" — should find per-entry strategy pass-through.
  Run: `diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md` returns no differences.
  Run: `diff hive/workflows/manage-repo.md .claude/hive/workflows/manage-repo.md` returns no differences.
  </verify>
  <done>
  execute-plan reads merge_strategy from PLAN.md frontmatter and passes it to self-merge-pr via --strategy flag. manage-repo reads merge_strategy from queue entry and passes it to self-merge-pr. Plans can now override the global merge strategy. All workflow copies are identical.
  </done>
</task>

</tasks>

<verification>
1. `grep -n "strategyOverride" hive/bin/hive-tools.js` finds strategy override in cmdGitSelfMergePr
2. `grep -n "merge_strategy" hive/workflows/execute-plan.md` finds frontmatter read and flag construction
3. `grep -n "merge_strategy" hive/workflows/manage-repo.md` finds per-entry strategy pass-through
4. `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js` returns empty
5. `diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md` returns empty
6. `diff hive/workflows/manage-repo.md .claude/hive/workflows/manage-repo.md` returns empty
</verification>

<success_criteria>
- Per-plan merge strategy in PLAN.md frontmatter overrides global config (MULTI-02)
- self-merge-pr accepts --strategy flag with validation
- execute-plan reads merge_strategy from frontmatter and passes to self-merge-pr
- manage-repo reads merge_strategy from queue entry and passes to self-merge-pr
- Full backward compatibility: no merge_strategy in frontmatter = use global config
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-worker-safety/14-02-SUMMARY.md`
</output>
