---
phase: 14-multi-worker-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js, hive/templates/config.json, .claude/hive/templates/config.json]
autonomous: true

must_haves:
  truths:
    - "Queue entries contain lease_owner and lease_expires_at fields when submitted"
    - "Queue processing respects lease ownership and expiry before claiming an entry"
    - "Protected branches are read from config, not hardcoded as main/master"
    - "merge-dev-to-main uses the configured main branch instead of trying main then master"
    - "delete-plan-branch refuses to delete config-specified protected branches"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "Queue lease fields, configurable protected branches"
      contains: "lease_owner"
    - path: ".claude/hive/bin/hive-tools.js"
      provides: "Installed copy identical to hive/bin/hive-tools.js"
      contains: "lease_owner"
    - path: "hive/templates/config.json"
      provides: "protected_branches config field"
      contains: "protected_branches"
    - path: ".claude/hive/templates/config.json"
      provides: "Installed config template copy"
      contains: "protected_branches"
  key_links:
    - from: "hive/bin/hive-tools.js cmdGitQueueSubmit"
      to: "merge-queue.json entries"
      via: "lease_owner and lease_expires_at fields in entry object"
      pattern: "lease_owner"
    - from: "hive/bin/hive-tools.js cmdGitMergeDevToMain"
      to: "config.git_main_branch"
      via: "loadConfig reads git.main_branch"
      pattern: "git_main_branch"
    - from: "hive/bin/hive-tools.js cmdGitDeletePlanBranch"
      to: "config.git_protected_branches"
      via: "loadConfig reads git.protected_branches array"
      pattern: "git_protected_branches"
---

<objective>
Add queue lease fields for multi-worker safety and make protected branches configurable via config instead of hardcoded.

Purpose: MULTI-01 prevents two workers from processing the same queue entry simultaneously via lease ownership and expiry. MULTI-03 allows projects using branches other than main/master to configure their protected branch names.

Output: Updated hive-tools.js with lease-aware queue operations and config-driven protected branches. Updated config template with new fields.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@hive/bin/hive-tools.js
@hive/templates/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add queue lease fields and configurable protected branches to hive-tools.js</name>
  <files>hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js</files>
  <action>
  Modify hive-tools.js in these specific functions:

  **1. loadConfig (line ~175):**
  - Add `git_main_branch` default: `'main'`
  - Add `git_protected_branches` default: `[]` (empty array means auto-derive from main + dev)
  - In the return object, read from `gitSection.main_branch` and `gitSection.protected_branches`

  **2. cmdGitQueueSubmit (line ~5633):**
  - Add `lease_owner` and `lease_expires_at` fields to the queue entry object (after `error: null`):
    - `lease_owner: null` (not leased on submit — only set when a worker claims it)
    - `lease_expires_at: null`
  - This preserves backward compatibility — entries start unleased.

  **3. cmdGitQueueUpdate (line ~5733):**
  - Accept new options: `--lease-owner` and `--lease-ttl` (seconds, default 300)
  - When `options.lease_owner` is provided, set `entry.lease_owner = options.lease_owner`
  - When `options.lease_owner` is provided, set `entry.lease_expires_at = new Date(Date.now() + (parseInt(options.lease_ttl, 10) || 300) * 1000).toISOString()`
  - When status changes to a terminal status (merged, conflict, build_failed, merge_failed), clear `lease_owner` and `lease_expires_at` to null
  - Add `--lease-owner` and `--lease-ttl` parsing in the CLI dispatch section (line ~6416)

  **4. cmdGitQueueStatus (line ~5696):**
  - Add `leased` filter: entries where `lease_owner` is set and `lease_expires_at` is in the future
  - Add `stale_leases` filter: entries where `lease_expires_at` is in the past (expired leases)
  - Include `leased_count` and `stale_lease_count` in the output

  **5. cmdGitMergeDevToMain (line ~5502):**
  - Replace the hardcoded main/master fallback logic with:
    ```
    const mainBranch = config.git_main_branch || 'main';
    let checkoutResult = execCommand('git', ['checkout', mainBranch], { cwd });
    if (!checkoutResult.success) {
      output({ success: false, error: 'Could not checkout main branch: ' + mainBranch }, raw, '');
      return;
    }
    ```
  - Remove the `let mainBranch = 'main'` / try master fallback pattern entirely.

  **6. cmdGitDeletePlanBranch (line ~5574):**
  - Replace hardcoded `['main', 'master', devBranch]` with:
    ```
    const configProtected = config.git_protected_branches || [];
    const protectedBranches = configProtected.length > 0
      ? [...new Set([...configProtected, devBranch])]
      : [config.git_main_branch || 'main', devBranch];
    ```
  - This uses config.protected_branches if set, otherwise derives from main_branch + dev_branch. Always includes dev_branch.

  **7. Ensure both copies are identical:** After modifying `hive/bin/hive-tools.js`, copy it to `.claude/hive/bin/hive-tools.js`.
  </action>
  <verify>
  Run: `node hive/bin/hive-tools.js git queue-submit --plan-id test-01 --branch test-branch --raw`
  Verify output contains entry with `lease_owner: null` and `lease_expires_at: null`.
  Run: `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js` returns no differences.
  Run: `node hive/bin/hive-tools.js frontmatter validate .planning/phases/14-multi-worker-safety/14-01-PLAN.md --schema plan --raw` returns valid.
  </verify>
  <done>
  Queue entries have lease_owner and lease_expires_at fields. Protected branches are read from config (git.main_branch and git.protected_branches) instead of hardcoded main/master. merge-dev-to-main uses configured main branch. Both hive-tools.js copies are identical.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update config template with main_branch and protected_branches fields</name>
  <files>hive/templates/config.json, .claude/hive/templates/config.json</files>
  <action>
  In `hive/templates/config.json`, add two new fields to the `git` section:
  - `"main_branch": "main"` — after `dev_branch`
  - `"protected_branches": []` — after `merge_strategy` (empty array = auto-derive from main_branch + dev_branch)

  The git section should look like:
  ```json
  "git": {
    "flow": "github",
    "dev_branch": "dev",
    "main_branch": "main",
    "build_gates": {
      "pre_pr": true,
      "pre_merge": true,
      "pre_main": true,
      "require_build": false
    },
    "build_command": null,
    "pre_main_command": null,
    "build_timeout": 300,
    "merge_strategy": "merge",
    "protected_branches": [],
    "repo_manager": false
  }
  ```

  Copy `hive/templates/config.json` to `.claude/hive/templates/config.json` to keep them identical.
  </action>
  <verify>
  Run: `node -e "const c = require('./hive/templates/config.json'); console.log(c.git.main_branch, JSON.stringify(c.git.protected_branches))"` outputs `main []`.
  Run: `diff hive/templates/config.json .claude/hive/templates/config.json` returns no differences.
  </verify>
  <done>
  Config template includes main_branch and protected_branches fields with sensible defaults. Both template copies are identical.
  </done>
</task>

</tasks>

<verification>
1. `node hive/bin/hive-tools.js git queue-submit --plan-id verify-01 --branch verify-branch --raw` includes lease_owner and lease_expires_at in output
2. `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js` shows no differences
3. `diff hive/templates/config.json .claude/hive/templates/config.json` shows no differences
4. Config template has main_branch and protected_branches fields
5. loadConfig returns git_main_branch and git_protected_branches from config
</verification>

<success_criteria>
- Queue entries have lease_owner and lease_expires_at fields (MULTI-01)
- Protected branches read from config, not hardcoded (MULTI-03)
- merge-dev-to-main uses config.git.main_branch
- delete-plan-branch uses config.git.protected_branches or auto-derives from main + dev
- Full backward compatibility: empty protected_branches defaults to [main, dev]
</success_criteria>

<output>
After completion, create `.planning/phases/14-multi-worker-safety/14-01-SUMMARY.md`
</output>
