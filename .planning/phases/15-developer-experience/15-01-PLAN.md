---
phase: 15-developer-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - .claude/hive/bin/hive-tools.js
  - hive/workflows/complete-milestone.md
  - .claude/hive/workflows/complete-milestone.md
autonomous: true

must_haves:
  truths:
    - "On milestone completion, a CHANGELOG.md is generated from SUMMARY.md one-liners grouped by phase"
    - "After dev-to-main merge, the system auto-pushes to remote when config auto_push is true"
    - "After dev-to-main merge, the result includes needs_push flag when auto_push is false or not set"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "CHANGELOG generation in cmdMilestoneComplete and auto-push in cmdGitMergeDevToMain"
      contains: "generateChangelog"
    - path: "hive/workflows/complete-milestone.md"
      provides: "CHANGELOG step and auto-push handling in merge_dev_to_main step"
      contains: "CHANGELOG"
  key_links:
    - from: "cmdMilestoneComplete"
      to: "SUMMARY.md files"
      via: "reads one-liners from frontmatter, generates Keep a Changelog format"
      pattern: "generateChangelog|CHANGELOG"
    - from: "cmdGitMergeDevToMain"
      to: "config auto_push"
      via: "reads auto_push from loadConfig, pushes or returns needs_push"
      pattern: "auto_push|needs_push|git.*push"
---

<objective>
Add CHANGELOG generation on milestone completion and auto-push after dev-to-main merge.

Purpose: DX-01 gives users a publishable CHANGELOG.md automatically. DX-02 eliminates the manual "git push" step after milestone merge.
Output: Updated hive-tools.js with CHANGELOG generation and auto-push logic, updated complete-milestone.md workflow.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@hive/bin/hive-tools.js
@hive/workflows/complete-milestone.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CHANGELOG generation to cmdMilestoneComplete and auto-push to cmdGitMergeDevToMain</name>
  <files>hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js</files>
  <action>
  **CHANGELOG generation (DX-01):**

  Add a `generateChangelog` helper function near `cmdMilestoneComplete`. It should:
  1. Accept `cwd`, `version`, `milestoneName`, and a `phases` array (each with `name`, `summaries` containing one-liners and accomplishments)
  2. Generate Keep a Changelog format (matching existing CHANGELOG.md style):
     - Header: `# Changelog\n\nAll notable changes to this project.\n\nFormat follows [Keep a Changelog](https://keepachangelog.com/en/1.1.0/).`
     - Section: `## [${version}] - ${today}` (e.g., `## [v2.1] - 2026-02-16`)
     - Group entries under `### Added`, `### Changed`, `### Fixed` based on commit type prefix in one-liners (default to `### Added` if unclear)
     - Each entry is a bullet from the SUMMARY.md one-liners and accomplishment bullets
  3. Write to `.planning/CHANGELOG.md` in the project directory
  4. If `.planning/CHANGELOG.md` already exists, insert the new version section after `## [Unreleased]` (or after the header if no Unreleased section), preserving previous entries

  In `cmdMilestoneComplete`, after gathering accomplishments from SUMMARY.md files (existing loop around line 3647-3672):
  1. Also collect one-liners and accomplishment bullets per phase (the loop already reads content and extracts frontmatter)
  2. After the existing milestone logic, call `generateChangelog(cwd, version, milestoneName, phaseData)`
  3. Add `changelog_generated: true` to the result object
  4. Add the CHANGELOG.md path to the result's `archived` object

  **Auto-push (DX-02):**

  In `loadConfig` function:
  1. Add `git_auto_push: false` to the `defaults` object
  2. Add `git_auto_push: gitSection.auto_push ?? defaults.git_auto_push` to the return object

  In `cmdGitMergeDevToMain`:
  1. After the successful merge (line 5530-5531), read `config.git_auto_push`
  2. If `git_auto_push` is true: run `git push origin ${mainBranch}` and include `pushed: true/false` in the result
  3. If `git_auto_push` is false (default): include `needs_push: true` in the success result
  4. Always include the `auto_push` config value in the result for the workflow to act on

  **Sync installed copy:**
  Copy `hive/bin/hive-tools.js` to `.claude/hive/bin/hive-tools.js` (identical copy, using `sed 's|~/\\.claude/|./.claude/|g'` path substitution pattern from prior phases).
  </action>
  <verify>
  Run `node hive/bin/hive-tools.js --help 2>&1 | head -5` to confirm no syntax errors.
  Run `grep -c "generateChangelog" hive/bin/hive-tools.js` to confirm function exists.
  Run `grep -c "git_auto_push" hive/bin/hive-tools.js` to confirm config field exists.
  Run `grep -c "needs_push" hive/bin/hive-tools.js` to confirm needs_push flag in merge result.
  </verify>
  <done>
  cmdMilestoneComplete generates .planning/CHANGELOG.md from SUMMARY.md one-liners in Keep a Changelog format.
  cmdGitMergeDevToMain auto-pushes when config.git.auto_push is true, returns needs_push when false.
  loadConfig reads git.auto_push with false default.
  Installed copy (.claude/) synced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update complete-milestone workflow with CHANGELOG step and auto-push handling</name>
  <files>hive/workflows/complete-milestone.md, .claude/hive/workflows/complete-milestone.md</files>
  <action>
  **CHANGELOG step:**

  Add a new step `generate_changelog` between the existing `extract_accomplishments` and `create_milestone_entry` steps in complete-milestone.md:

  ```xml
  <step name="generate_changelog">

  The `milestone complete` CLI command automatically generates `.planning/CHANGELOG.md` from SUMMARY.md one-liners across all phases.

  After running `milestone complete` in the archive step, verify CHANGELOG was generated:

  ```bash
  ls .planning/CHANGELOG.md 2>/dev/null && echo "CHANGELOG generated" || echo "No CHANGELOG"
  ```

  Present: "CHANGELOG.md generated with [N] entries for ${version}"

  </step>
  ```

  Note: Since `cmdMilestoneComplete` now handles CHANGELOG generation internally, the workflow just needs to acknowledge it and include `CHANGELOG.md` in the commit files list.

  **Auto-push handling in merge_dev_to_main step:**

  After the existing merge success handling (around line 482), add auto-push awareness:

  ```
  MERGE_AUTO_PUSH=$(echo "$MERGE_RESULT" | jq -r '.auto_push // false')
  MERGE_PUSHED=$(echo "$MERGE_RESULT" | jq -r '.pushed // false')
  MERGE_NEEDS_PUSH=$(echo "$MERGE_RESULT" | jq -r '.needs_push // false')
  ```

  Handle results:
  - If `MERGE_PUSHED` is true: log "Pushed ${MERGE_TO} to remote."
  - If `MERGE_NEEDS_PUSH` is true: log "Merge complete. Run `git push origin ${MERGE_TO}` to push to remote." (Do NOT auto-push when config says not to)

  **Update git_commit_milestone step:**

  Add `.planning/CHANGELOG.md` to the commit files list in the milestone commit command.

  **Sync installed copy:**
  Copy `hive/workflows/complete-milestone.md` to `.claude/hive/workflows/complete-milestone.md` (with path substitution).
  </action>
  <verify>
  Grep for "generate_changelog" in `hive/workflows/complete-milestone.md` to confirm new step exists.
  Grep for "CHANGELOG.md" in `hive/workflows/complete-milestone.md` to confirm it's in commit files.
  Grep for "needs_push\|auto_push\|MERGE_PUSHED" in `hive/workflows/complete-milestone.md` to confirm push handling.
  Diff source and installed copies to verify sync.
  </verify>
  <done>
  complete-milestone.md has generate_changelog step acknowledging CLI-generated CHANGELOG.
  merge_dev_to_main step handles auto-push result and needs_push flag.
  CHANGELOG.md included in milestone commit.
  Installed copy (.claude/) synced.
  </done>
</task>

</tasks>

<verification>
1. hive-tools.js contains generateChangelog function that reads SUMMARY.md one-liners
2. cmdMilestoneComplete calls generateChangelog and includes changelog_generated in result
3. loadConfig has git_auto_push field with false default
4. cmdGitMergeDevToMain returns needs_push or auto-pushes based on config
5. complete-milestone.md references CHANGELOG generation and handles push result
6. Both source and installed copies are in sync
</verification>

<success_criteria>
- CHANGELOG generation produces Keep a Changelog format from SUMMARY.md one-liners
- Auto-push is gated by config.git.auto_push (default false for safety)
- needs_push flag returned when auto_push is off
- No breaking changes to existing behavior (auto_push defaults to false)
</success_criteria>

<output>
After completion, create `.planning/phases/15-developer-experience/15-01-SUMMARY.md`
</output>
