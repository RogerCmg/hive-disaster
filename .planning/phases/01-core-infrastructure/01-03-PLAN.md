---
phase: 01-core-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - hive/bin/hive-tools.js
autonomous: true

must_haves:
  truths:
    - "Running `hive-tools.js telemetry digest` produces a readable .planning/telemetry/INSIGHTS.md with event summary tables and pattern highlights"
    - "Running `hive-tools.js telemetry digest` with no events produces INSIGHTS.md with a 'No events recorded yet' message"
    - "The telemetry config section in config.json controls whether emit calls write events (enabled: false blocks all writes)"
    - "All 5 telemetry subcommands (emit, query, digest, rotate, stats) are wired and functional"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "cmdTelemetryDigest function and complete telemetry router"
      contains: "cmdTelemetryDigest"
    - path: ".planning/telemetry/INSIGHTS.md"
      provides: "Human-readable digest of telemetry events (generated at runtime)"
      contains: "Telemetry Insights"
  key_links:
    - from: "hive/bin/hive-tools.js (cmdTelemetryDigest)"
      to: ".planning/telemetry/events.jsonl"
      via: "reads all events, aggregates into markdown"
      pattern: "events\\.jsonl.*split.*parse"
    - from: "hive/bin/hive-tools.js (cmdTelemetryDigest)"
      to: ".planning/telemetry/INSIGHTS.md"
      via: "fs.writeFileSync with generated markdown content"
      pattern: "writeFileSync.*INSIGHTS\\.md"
    - from: "hive/bin/hive-tools.js (telemetry case)"
      to: "cmdTelemetryDigest"
      via: "subcommand dispatch"
      pattern: "subcommand === 'digest'"
---

<objective>
Add the digest command that generates INSIGHTS.md from accumulated telemetry events, and ensure the complete telemetry config section integration works end-to-end. This is the final plan for Phase 1, completing all 10 INFRA requirements.

Purpose: The digest command transforms raw event data into human-readable insights that can be committed to git and shared. This closes the storage-to-insight pipeline for Phase 1 (Phase 4 will enhance with pattern detection and agent prompt injection).
Output: Working `hive-tools.js telemetry digest` command, generated INSIGHTS.md file, fully wired telemetry command group.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
@.planning/phases/01-core-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-core-infrastructure/01-02-SUMMARY.md
@hive/bin/hive-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add digest command that generates INSIGHTS.md</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
Add the `cmdTelemetryDigest` function to `hive/bin/hive-tools.js` and wire it into the telemetry router:

1. **cmdTelemetryDigest(cwd, raw)** function:

   **Read events:**
   - Read events.jsonl using `safeReadFile()`
   - Parse JSONL lines (same pattern as query: split, filter, parse, filter nulls)
   - If no events: write a stub INSIGHTS.md with "No events recorded yet" and return

   **Aggregate data:**
   - Count events by type (same as stats)
   - Calculate time range: earliest and latest event timestamps
   - For `agent_completion` events: extract agent names, count completions per agent, calculate average duration_ms if available
   - For `deviation` events: count by severity if available, list recent deviations (last 5)
   - For `tool_error` events: count errors, list most common tool names
   - Total event count

   **Generate INSIGHTS.md** -- Write to `.planning/telemetry/INSIGHTS.md`:
   ```markdown
   # Telemetry Insights

   *Generated: {ISO timestamp}*
   *Period: {earliest event date} to {latest event date}*
   *Total events: {N}*

   ## Event Summary

   | Type | Count | % |
   |------|-------|---|
   | agent_completion | N | X% |
   | deviation | N | X% |
   | ... | ... | ... |

   ## Agent Performance

   | Agent | Completions | Avg Duration |
   |-------|-------------|--------------|
   | hive-executor | N | Xms |
   | hive-planner | N | Xms |

   ## Recent Deviations

   - {timestamp}: {severity} - {resolution} (phase: {phase})
   - ...

   ## Tool Errors

   | Tool | Errors |
   |------|--------|
   | {tool} | N |

   ---
   *Phase 1 digest â€” enhanced analysis available in Phase 4*
   ```

   **Notes on digest scope (per research):**
   - Keep Phase 1 digest simple: counts, basic stats, recent items
   - Phase 4 (FEED-01) will enhance with pattern detection, trend analysis, recommendations
   - Target ~50 lines of digest logic (not including the markdown template)
   - If a section has no data (e.g., no deviations), show "None recorded" instead of omitting the section
   - Agent performance table only appears if agent_completion events have a `data.agent` field
   - Duration stats only appear if events have `data.duration_ms` field
   - Handle gracefully when data fields are missing -- not all events will have all fields

   **Return value:**
   - `output({ generated: true, path: insightsPath, total_events: totalEvents }, raw, insightsPath)`

2. **Wire into router** -- Add to the telemetry case:
   ```javascript
   } else if (subcommand === 'digest') {
     cmdTelemetryDigest(cwd, raw);
   }
   ```

3. **Update file header** -- Add to Telemetry section:
   ```
   *   telemetry digest                        Generate INSIGHTS.md
   ```
  </action>
  <verify>
First ensure there are some events to digest:
```bash
node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"hive-executor","duration_ms":1500}'
node hive/bin/hive-tools.js telemetry emit deviation --data '{"severity":"minor","resolution":"auto-fix","phase":"01"}'
node hive/bin/hive-tools.js telemetry emit tool_error --data '{"tool":"Read","error":"file not found"}'
node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"hive-planner","duration_ms":3000}'
```

Generate digest:
```bash
node hive/bin/hive-tools.js telemetry digest
```
Should return JSON with `generated: true` and the INSIGHTS.md path.

Read the generated file:
```bash
cat .planning/telemetry/INSIGHTS.md
```
Should show markdown with:
- Event Summary table with counts and percentages
- Agent Performance table (hive-executor, hive-planner)
- Recent Deviations section
- Tool Errors section

Test with empty events (delete events.jsonl first):
```bash
rm .planning/telemetry/events.jsonl 2>/dev/null
node hive/bin/hive-tools.js telemetry digest
cat .planning/telemetry/INSIGHTS.md
```
Should show "No events recorded yet" stub.
  </verify>
  <done>
`telemetry digest` reads all events from events.jsonl, aggregates by type, computes agent performance stats and deviation summaries, and writes a human-readable INSIGHTS.md with markdown tables. Empty events produce a stub file. INFRA-06 is satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end verification and config integration smoke test</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
Run the complete Phase 1 end-to-end verification sequence. This task verifies the full telemetry pipeline works as specified in the roadmap success criteria. Fix any issues found.

**Verification sequence:**

1. **Clean slate** -- Remove any existing telemetry test data:
   ```bash
   rm -rf .planning/telemetry/
   ```

2. **Success Criterion 1** -- Emit with valid data:
   ```bash
   node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"hive-executor","duration_ms":1500,"exit_code":0}'
   ```
   Verify: events.jsonl has one line with ts, session, type=agent_completion, v=1, data fields.

3. **Success Criterion 2** -- Query with filters:
   ```bash
   node hive/bin/hive-tools.js telemetry emit deviation --data '{"severity":"minor"}'
   node hive/bin/hive-tools.js telemetry query --type deviation --since 7d --limit 5
   ```
   Verify: returns only the deviation event.

4. **Success Criterion 3** -- Digest:
   ```bash
   node hive/bin/hive-tools.js telemetry digest
   ```
   Verify: .planning/telemetry/INSIGHTS.md exists with tables and summaries.

5. **Success Criterion 4** -- Rotate:
   ```bash
   node hive/bin/hive-tools.js telemetry rotate --force
   ```
   Verify: events.jsonl archived, archive file exists, max 10 check works.

6. **Success Criterion 5** -- Config toggle:
   - Read current config, add/verify telemetry.enabled = false
   - Emit an event -- should return disabled status and NOT write to events.jsonl
   - Restore telemetry.enabled = true

**If any verification step fails:** Fix the issue in hive-tools.js before proceeding. Common issues to check:
- Missing newline in appendFileSync (`JSON.stringify(event) + '\n'`)
- Incorrect path construction (must use `path.join()`)
- Missing null checks on safeReadFile return
- JSONL parsing: `content.split('\n').filter(Boolean)` not `content.split('\n')`
- Config defensive access: `config.telemetry?.enabled !== false`

**Final cleanup:**
- Verify the file header lists all 5 telemetry subcommands
- Verify the telemetry case in the router handles all 5 subcommands
- Remove any test events created during verification: `rm -rf .planning/telemetry/`
  </action>
  <verify>
All 5 roadmap success criteria pass:
1. `emit` appends valid JSONL with envelope fields
2. `query` filters by type, since, and limit
3. `digest` produces readable INSIGHTS.md
4. `rotate` archives and prunes
5. Config `enabled: false` blocks emit

Run: `node hive/bin/hive-tools.js telemetry stats` -- should return clean stats after test events.
Run: `node hive/bin/hive-tools.js telemetry emit --help 2>&1` or bad subcommand -- should list available subcommands.
  </verify>
  <done>
All 5 Phase 1 success criteria verified end-to-end. All 10 INFRA requirements (INFRA-01 through INFRA-10) are satisfied. The telemetry command group has 5 working subcommands (emit, query, digest, rotate, stats). Config toggle controls emit behavior. INSIGHTS.md generation works from accumulated events. File rotation with 500KB threshold and max 10 archives is functional.
  </done>
</task>

</tasks>

<verification>
Complete Phase 1 success criteria from ROADMAP.md:
1. `hive-tools.js telemetry emit agent_completion --data '{...}'` appends valid JSONL line with ts, session, type, v, data
2. `hive-tools.js telemetry query --type deviation --since 7d --limit 5` returns only matching events
3. `hive-tools.js telemetry digest` produces readable INSIGHTS.md with tables and summaries
4. `hive-tools.js telemetry rotate` archives events.jsonl when over 500KB, max 10 archives
5. Config `telemetry.enabled: false` prevents emit from writing events
</verification>

<success_criteria>
- Digest command generates INSIGHTS.md with event summary, agent performance, deviation list, and error summary
- Empty events produce a clean stub INSIGHTS.md
- All 5 telemetry subcommands wired and working end-to-end
- All 10 INFRA requirements satisfied
- All 5 Phase 1 success criteria verified
- Config integration complete with defensive defaults for missing telemetry section
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-03-SUMMARY.md`
</output>
