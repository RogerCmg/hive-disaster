---
phase: 01-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - hive/templates/config.json
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Running `hive-tools.js telemetry emit agent_completion --data '{...}'` appends a valid JSONL line to .planning/telemetry/events.jsonl with ts, session, type, v, and data fields"
    - "Running `hive-tools.js telemetry emit invalid_type` returns an error listing valid event types"
    - "When telemetry.enabled is false in config.json, emit writes nothing and returns a disabled status"
    - "The config template includes a telemetry section with enabled, hooks, workflow_events, and transcript_analysis toggles"
    - "events.jsonl and events-*.jsonl patterns are gitignored"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "Telemetry helper functions (getTelemetryConfig, ensureTelemetryDir, createEventEnvelope, parseSinceDuration, rotateIfNeeded, VALID_EVENT_TYPES) and emit command (cmdTelemetryEmit)"
      contains: "VALID_EVENT_TYPES"
    - path: "hive/templates/config.json"
      provides: "Default telemetry config section"
      contains: "telemetry"
    - path: ".gitignore"
      provides: "Gitignore rules for JSONL event files"
      contains: "events.jsonl"
  key_links:
    - from: "hive/bin/hive-tools.js (cmdTelemetryEmit)"
      to: ".planning/telemetry/events.jsonl"
      via: "fs.appendFileSync with JSON.stringify + newline"
      pattern: "appendFileSync.*events\\.jsonl"
    - from: "hive/bin/hive-tools.js (cmdTelemetryEmit)"
      to: "hive/bin/hive-tools.js (getTelemetryConfig)"
      via: "config check before emit"
      pattern: "getTelemetryConfig.*enabled"
    - from: "hive/bin/hive-tools.js (main switch)"
      to: "hive/bin/hive-tools.js (cmdTelemetryEmit)"
      via: "case 'telemetry' dispatch"
      pattern: "case 'telemetry'"
---

<objective>
Build the telemetry storage foundation: JSONL event storage engine, event envelope format, emit CLI command, config helpers, and config template update. This is the bedrock all other telemetry commands depend on.

Purpose: Establish the append-only JSONL event store and the emit pathway so that hooks and workflows can record structured telemetry events. Without this, nothing else in the Recall system can function.
Output: Working `hive-tools.js telemetry emit` command, helper functions for all subsequent telemetry commands, updated config template, updated .gitignore.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
@hive/bin/hive-tools.js
@hive/templates/config.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add telemetry helper functions, config template section, and .gitignore rules</name>
  <files>hive/bin/hive-tools.js, hive/templates/config.json, .gitignore</files>
  <action>
Add the following to `hive/bin/hive-tools.js`:

1. **Constants** -- Add near the top of the file (after the existing constants like MODEL_PROFILES), a VALID_EVENT_TYPES array:
   ```javascript
   const VALID_EVENT_TYPES = [
     'agent_completion', 'tool_error', 'deviation', 'checkpoint',
     'verification_gap', 'plan_revision', 'user_correction',
     'fallback', 'context_compaction', 'session_summary'
   ];
   ```

2. **Helper functions** -- Add after the existing helper functions (near `safeReadFile` and `loadConfig`), before the `// --- Commands ---` section:

   - `getTelemetryConfig(cwd)` -- Reads `.planning/config.json`, returns telemetry settings with defensive defaults. Pattern: `config.telemetry?.enabled !== false` (treats missing as enabled). Returns object with: `enabled`, `hooks`, `workflow_events`, `transcript_analysis`, `rotation_threshold_kb` (default 500), `max_archives` (default 10). Use try/catch with sensible defaults on failure (same pattern as existing `loadConfig`).

   - `ensureTelemetryDir(cwd)` -- Creates `.planning/telemetry/` directory if it doesn't exist. Uses `fs.mkdirSync(dir, { recursive: true })`. Returns the directory path.

   - `createEventEnvelope(type, data, session)` -- Returns `{ ts: new Date().toISOString(), session: session || process.env.CLAUDE_SESSION_ID || 'unknown', type, v: 1, data: data || {} }`.

   - `parseSinceDuration(sinceStr)` -- Parses duration strings like "7d", "24h", "30m" into Date objects. Also accepts ISO date strings. Returns null on invalid input. Use regex: `/^(\d+)([dhm])$/`. Map: `{ d: 86400000, h: 3600000, m: 60000 }`.

   - `rotateIfNeeded(telemetryDir, config)` -- Checks events.jsonl size via `fs.statSync`. If over `config.rotation_threshold_kb * 1024`, renames to `events-{ISO-timestamp}.jsonl` (colons replaced with dashes, milliseconds stripped). Then prunes archives exceeding `config.max_archives` (oldest first). Returns boolean indicating if rotation happened. Wraps everything in try/catch, returns false on error. Sort archive files alphabetically (ISO timestamps sort naturally).

3. **Config template** -- Add a `"telemetry"` section to `hive/templates/config.json` at the top level (after the existing `"safety"` section):
   ```json
   "telemetry": {
     "enabled": true,
     "hooks": true,
     "workflow_events": true,
     "transcript_analysis": false
   }
   ```

4. **.gitignore** -- Append these lines to `.gitignore`:
   ```
   # Telemetry event data (raw events stay local, INSIGHTS.md is committed)
   .planning/telemetry/events.jsonl
   .planning/telemetry/events-*.jsonl
   ```

**Important conventions to follow:**
- 2-space indentation, single quotes for strings
- Function names in camelCase
- Use `path.join()` for all paths (never string concatenation)
- Follow `safeReadFile` pattern for try/catch with null/default returns
- Use `fs.readFileSync(path, 'utf-8')` consistently (not 'utf8')
  </action>
  <verify>
Run: `node hive/bin/hive-tools.js --help 2>&1 | head -5` -- should not crash (syntax check).
Run: `grep -c 'VALID_EVENT_TYPES' hive/bin/hive-tools.js` -- should return at least 1.
Run: `grep 'telemetry' hive/templates/config.json` -- should show the telemetry section.
Run: `grep 'events.jsonl' .gitignore` -- should show the gitignore rule.
  </verify>
  <done>
Five helper functions (getTelemetryConfig, ensureTelemetryDir, createEventEnvelope, parseSinceDuration, rotateIfNeeded) exist in hive-tools.js. VALID_EVENT_TYPES constant lists all 10 event types. Config template has telemetry section. .gitignore excludes JSONL event files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add telemetry emit command and router case</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
Add the `cmdTelemetryEmit` function and the `telemetry` case to the main CLI switch in `hive/bin/hive-tools.js`:

1. **cmdTelemetryEmit(cwd, type, dataStr, raw)** function -- Add near other cmd* functions:
   - Validate `type` is provided, error if missing (list valid types in error message)
   - Validate `type` is in VALID_EVENT_TYPES, error if not (list valid types)
   - Call `getTelemetryConfig(cwd)` -- if not enabled, return `output({ emitted: false, reason: 'telemetry disabled' }, raw, 'disabled')` and return early
   - Parse `dataStr` with `JSON.parse()` in try/catch. On parse error: `error('Invalid JSON in --data: ' + e.message)`
   - If no dataStr provided, use empty object `{}`
   - Call `ensureTelemetryDir(cwd)` to get telemetry dir path
   - Build event using `createEventEnvelope(type, data)` -- do NOT pass session param, let the function use its default fallback chain
   - Append to events.jsonl: `fs.appendFileSync(eventsFile, JSON.stringify(event) + '\n')`
   - Call `rotateIfNeeded(telemetryDir, telConfig)` for auto-rotation (INFRA-09)
   - Return: `output({ emitted: true, type, ts: event.ts }, raw, 'ok')`

2. **Router case** -- Add `case 'telemetry':` to the main switch statement (before the `default:` case, after `websearch`):
   ```javascript
   case 'telemetry': {
     const subcommand = args[1];
     if (subcommand === 'emit') {
       const type = args[2];
       const dataIdx = args.indexOf('--data');
       const data = dataIdx !== -1 ? args[dataIdx + 1] : null;
       cmdTelemetryEmit(cwd, type, data, raw);
     } else {
       error('Unknown telemetry subcommand: ' + (subcommand || '(none)') + '. Available: emit, query, digest, rotate, stats');
     }
     break;
   }
   ```
   Note: Only `emit` is wired now. The other subcommands will be added in Plans 02 and 03. The error message lists all planned subcommands so users know what's coming.

3. **Update the file header comment** -- Add these lines to the usage documentation at the top of hive-tools.js (in the appropriate alphabetical/section position):
   ```
   * Telemetry:
   *   telemetry emit <type> --data '{json}'  Emit telemetry event
   ```

**Conventions:**
- Follow the exact dispatch pattern used by the `state`, `frontmatter`, and `verify` command groups
- The emit command should `process.exit(1)` on validation errors (via the existing `error()` helper) but never on telemetry write failures when called from hooks (this distinction will matter in Phase 2; for now, the CLI command can error normally)
  </action>
  <verify>
Test emit with valid data:
```bash
cd /path/to/project && node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"test","duration_ms":100}'
```
Should output JSON with `emitted: true`.

Verify JSONL file was created:
```bash
cat .planning/telemetry/events.jsonl
```
Should show one line with ts, session, type, v, data fields.

Test emit with invalid type:
```bash
node hive/bin/hive-tools.js telemetry emit bad_type 2>&1
```
Should output error with valid types list.

Test emit with telemetry disabled:
```bash
# Temporarily set enabled: false in .planning/config.json, emit, verify no new line
```

Test unknown subcommand:
```bash
node hive/bin/hive-tools.js telemetry unknown 2>&1
```
Should output error listing available subcommands.
  </verify>
  <done>
`hive-tools.js telemetry emit <type> --data '{json}'` works end-to-end: validates type against 10 known types, respects config.telemetry.enabled toggle, creates .planning/telemetry/ directory on first use, appends valid JSONL line with envelope fields (ts, session, type, v, data), and triggers auto-rotation check after each emit. Invalid types and bad JSON produce clear error messages.
  </done>
</task>

</tasks>

<verification>
1. `node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"hive-executor","duration_ms":1500}'` -- returns `{ emitted: true, type: "agent_completion", ts: "..." }`
2. `.planning/telemetry/events.jsonl` exists with exactly one valid JSONL line
3. The JSONL line contains all 5 envelope fields: ts (ISO string), session (string), type ("agent_completion"), v (1), data (object with agent and duration_ms)
4. `node hive/bin/hive-tools.js telemetry emit invalid_type 2>&1` exits with error listing valid types
5. `grep 'telemetry' hive/templates/config.json` shows the config section
6. `grep 'events.jsonl' .gitignore` shows the gitignore rules
7. VALID_EVENT_TYPES contains exactly 10 entries matching INFRA-03
</verification>

<success_criteria>
- The emit command is the working foundation for all telemetry capture
- Event envelope format is established (ts, session, type, v, data) per INFRA-02
- JSONL append-only storage works per INFRA-01
- All 10 event types are defined per INFRA-03
- Config gating works (enabled: false blocks writes) per INFRA-10 partial
- Helper functions (getTelemetryConfig, ensureTelemetryDir, createEventEnvelope, parseSinceDuration, rotateIfNeeded) are available for Plans 02 and 03
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-01-SUMMARY.md`
</output>
