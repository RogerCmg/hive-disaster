---
phase: 01-core-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - hive/bin/hive-tools.js
autonomous: true

must_haves:
  truths:
    - "Running `hive-tools.js telemetry query --type deviation --since 7d --limit 5` returns only matching events"
    - "Running `hive-tools.js telemetry query` with no filters returns up to 50 most recent events"
    - "Running `hive-tools.js telemetry stats` shows event counts by type, file size, and archive count"
    - "Running `hive-tools.js telemetry rotate` archives events.jsonl when over 500KB and prunes old archives to max 10"
    - "Auto-rotation triggers on emit when events.jsonl exceeds 500KB threshold"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "cmdTelemetryQuery, cmdTelemetryStats, cmdTelemetryRotate functions and router wiring"
      contains: "cmdTelemetryQuery"
    - path: "hive/bin/hive-tools.js"
      provides: "query subcommand with --type, --since, --limit flags"
      contains: "cmdTelemetryStats"
  key_links:
    - from: "hive/bin/hive-tools.js (cmdTelemetryQuery)"
      to: ".planning/telemetry/events.jsonl"
      via: "safeReadFile + split + filter + JSON.parse per line"
      pattern: "split.*\\\\n.*filter.*JSON\\.parse"
    - from: "hive/bin/hive-tools.js (cmdTelemetryQuery)"
      to: "hive/bin/hive-tools.js (parseSinceDuration)"
      via: "duration parsing for --since flag"
      pattern: "parseSinceDuration"
    - from: "hive/bin/hive-tools.js (cmdTelemetryRotate)"
      to: "hive/bin/hive-tools.js (rotateIfNeeded)"
      via: "explicit rotation call"
      pattern: "rotateIfNeeded"
    - from: "hive/bin/hive-tools.js (telemetry case)"
      to: "cmdTelemetryQuery, cmdTelemetryStats, cmdTelemetryRotate"
      via: "subcommand dispatch in telemetry case"
      pattern: "subcommand === 'query'"
---

<objective>
Add the query, stats, and rotate CLI subcommands to the telemetry command group. These provide the read and maintenance operations for the event store created in Plan 01.

Purpose: Users need to retrieve filtered events, see summary statistics, and manage event file rotation. These commands complete the core CRUD operations for the telemetry system.
Output: Three new working subcommands under `hive-tools.js telemetry`: query, stats, rotate.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
@.planning/phases/01-core-infrastructure/01-01-SUMMARY.md
@hive/bin/hive-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query and stats commands</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
Add two new functions to `hive/bin/hive-tools.js` and wire them into the telemetry router case:

1. **cmdTelemetryQuery(cwd, options, raw)** function:
   - Read events.jsonl using `safeReadFile()` (from Plan 01 helpers)
   - If no file or empty: return `output({ events: [], total: 0 }, raw, 'No events')`
   - Parse JSONL: `content.split('\n').filter(Boolean).map(line => { try { return JSON.parse(line); } catch { return null; } }).filter(Boolean)`
   - Filter by `options.type` if provided: `events.filter(e => e.type === options.type)`
   - Filter by `options.since` if provided: call `parseSinceDuration(options.since)`. If since string provided but parseSinceDuration returns null, call `error('Invalid --since value: ' + options.since + '. Use: 7d, 24h, 30m, or ISO date')`. Filter events where `new Date(e.ts) >= sinceDate`.
   - Apply `options.limit` (default 50): take the LAST N events (most recent), using `events.slice(-limit)`
   - Return: `output({ events, total: events.length }, raw, events.map(e => JSON.stringify(e)).join('\n'))`

2. **cmdTelemetryStats(cwd, raw)** function:
   - Get file size of events.jsonl via `fs.statSync()` in try/catch (default 0)
   - Count archive files: read telemetry dir, filter files matching `events-*.jsonl`
   - Parse events.jsonl, count events by type into a `typeCounts` object
   - Calculate total event count
   - Return:
     ```javascript
     output({
       total_events: totalEvents,
       file_size_bytes: fileSize,
       file_size_kb: Math.round(fileSize / 1024 * 10) / 10,
       archive_count: archiveCount,
       types: typeCounts,
     }, raw, `Events: ${totalEvents} | Size: ${Math.round(fileSize / 1024)}KB | Archives: ${archiveCount}`)
     ```

3. **Wire into router** -- Update the `case 'telemetry':` block to add query and stats subcommands:
   ```javascript
   } else if (subcommand === 'query') {
     const typeIdx = args.indexOf('--type');
     const sinceIdx = args.indexOf('--since');
     const limitIdx = args.indexOf('--limit');
     cmdTelemetryQuery(cwd, {
       type: typeIdx !== -1 ? args[typeIdx + 1] : null,
       since: sinceIdx !== -1 ? args[sinceIdx + 1] : null,
       limit: limitIdx !== -1 ? parseInt(args[limitIdx + 1], 10) : 50,
     }, raw);
   } else if (subcommand === 'stats') {
     cmdTelemetryStats(cwd, raw);
   }
   ```

4. **Update file header** -- Add to the Telemetry section in the usage docs:
   ```
   *   telemetry query [--type X] [--since Y]  Query filtered events
   *     [--limit N]
   *   telemetry stats                         Show event summary
   ```

**Conventions:**
- Use existing `safeReadFile()` helper (returns null on missing file)
- Match the output format from the research code examples exactly
- The raw mode output for query should be newline-delimited JSON (one event per line) -- same format as the JSONL file
- Stats raw output is a single summary line
  </action>
  <verify>
First emit some test events for querying:
```bash
node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"exec-1","duration_ms":1000}'
node hive/bin/hive-tools.js telemetry emit deviation --data '{"severity":"minor","resolution":"auto-fix"}'
node hive/bin/hive-tools.js telemetry emit agent_completion --data '{"agent":"exec-2","duration_ms":2000}'
```

Test query with no filters:
```bash
node hive/bin/hive-tools.js telemetry query
```
Should return all events (3+).

Test query with type filter:
```bash
node hive/bin/hive-tools.js telemetry query --type deviation
```
Should return only deviation events.

Test query with limit:
```bash
node hive/bin/hive-tools.js telemetry query --limit 1
```
Should return only the most recent event.

Test stats:
```bash
node hive/bin/hive-tools.js telemetry stats
```
Should show total count, file size, type breakdown.

Test query with invalid --since:
```bash
node hive/bin/hive-tools.js telemetry query --since garbage 2>&1
```
Should error with hint about valid formats.
  </verify>
  <done>
`telemetry query` returns filtered events with support for --type, --since (duration strings like 7d/24h/30m and ISO dates), and --limit (default 50, takes most recent). Invalid --since values produce clear errors. `telemetry stats` shows total event count, file size in bytes and KB, archive count, and per-type breakdown. Both handle empty/missing events file gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rotate command and verify auto-rotation on emit</name>
  <files>hive/bin/hive-tools.js</files>
  <action>
Add the rotate command and verify auto-rotation integration:

1. **cmdTelemetryRotate(cwd, raw)** function:
   - Get telemetry config via `getTelemetryConfig(cwd)`
   - Get telemetry dir path: `path.join(cwd, '.planning', 'telemetry')`
   - Check if events.jsonl exists. If not: return `output({ rotated: false, reason: 'no events file' }, raw, 'nothing to rotate')`
   - Get file size via `fs.statSync(eventsFile).size`
   - If under threshold (`config.rotation_threshold_kb * 1024`): return `output({ rotated: false, reason: 'under threshold', size_kb: Math.round(size / 1024 * 10) / 10, threshold_kb: config.rotation_threshold_kb }, raw, 'under threshold')`
   - Call `rotateIfNeeded(telemetryDir, config)` -- the helper from Plan 01 does the actual rotation
   - If rotated: return `output({ rotated: true, archived_size_kb: Math.round(size / 1024 * 10) / 10 }, raw, 'rotated')`
   - If not rotated (shouldn't happen if size check passed, but defensive): return appropriate status

   Note: The `rotateIfNeeded` helper already handles rename + archive pruning. The `cmdTelemetryRotate` command adds user-facing messaging around it.

   Alternative simpler approach: Since `rotateIfNeeded` already exists and does the heavy lifting, `cmdTelemetryRotate` can simply force a rotation regardless of size (useful for manual cleanup), OR respect the threshold. Follow the research pattern which respects the threshold and reports status. Add a `--force` flag that rotates regardless of size:
   ```javascript
   const forceIdx = args.indexOf('--force');
   const force = forceIdx !== -1;
   ```
   When `--force`, skip the size check and directly rename + prune.

2. **Wire into router** -- Add to the telemetry case:
   ```javascript
   } else if (subcommand === 'rotate') {
     const force = args.indexOf('--force') !== -1;
     cmdTelemetryRotate(cwd, force, raw);
   }
   ```

3. **Update file header** -- Add to Telemetry section:
   ```
   *   telemetry rotate [--force]              Rotate events file
   ```

4. **Verify auto-rotation on emit** -- The `cmdTelemetryEmit` function from Plan 01 already calls `rotateIfNeeded()` after each append. Verify this is working by checking:
   - After Plan 01's emit function appends, it calls `rotateIfNeeded(telemetryDir, telConfig)`
   - If this call is missing or the import chain is broken, add it now
   - This satisfies INFRA-09 (automatic rotation on exceeding 500KB)
  </action>
  <verify>
Test manual rotate with empty/small file:
```bash
node hive/bin/hive-tools.js telemetry rotate
```
Should return `rotated: false, reason: 'under threshold'` or similar.

Test force rotate:
```bash
node hive/bin/hive-tools.js telemetry rotate --force
```
Should archive even a small events file, creating events-{timestamp}.jsonl.

Verify archive exists:
```bash
ls .planning/telemetry/
```
Should show events-{timestamp}.jsonl archive file.

Test stats after rotation to confirm archive count:
```bash
node hive/bin/hive-tools.js telemetry stats
```
Should show archive_count >= 1.
  </verify>
  <done>
`telemetry rotate` checks events.jsonl against 500KB threshold and archives when exceeded. `--force` flag bypasses size check for manual rotation. Archive files named events-{ISO-timestamp}.jsonl. Old archives pruned to max 10. Auto-rotation on emit (from Plan 01) confirmed working -- `rotateIfNeeded` is called after every append. INFRA-07 (manual rotate), INFRA-08 (stats), and INFRA-09 (auto-rotation) are complete.
  </done>
</task>

</tasks>

<verification>
1. `node hive/bin/hive-tools.js telemetry query --type agent_completion` -- returns only agent_completion events
2. `node hive/bin/hive-tools.js telemetry query --since 7d --limit 5` -- returns at most 5 recent events from last 7 days
3. `node hive/bin/hive-tools.js telemetry query --since invalid 2>&1` -- exits with error about invalid format
4. `node hive/bin/hive-tools.js telemetry stats` -- returns JSON with total_events, file_size_bytes, file_size_kb, archive_count, types
5. `node hive/bin/hive-tools.js telemetry rotate --force` -- creates archive file, events.jsonl is removed/empty
6. After rotation, `ls .planning/telemetry/events-*.jsonl` shows at least one archive file
7. All five telemetry subcommands are listed in the help header (emit, query, stats, rotate, digest -- digest wired in Plan 03)
</verification>

<success_criteria>
- Query command filters by type, time range, and limit
- Stats command provides quick overview of telemetry state
- Rotate command archives events.jsonl and prunes old archives
- Auto-rotation on emit works for the 500KB threshold
- All commands handle empty/missing events file gracefully
- INFRA-04, INFRA-05, INFRA-07, INFRA-08, INFRA-09 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-02-SUMMARY.md`
</output>
