---
phase: 09-branch-lifecycle-build-gates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/workflows/execute-plan.md
  - .claude/hive/workflows/execute-plan.md
autonomous: true

must_haves:
  truths:
    - "After a plan completes, the build command runs automatically"
    - "If the build fails, PR creation is blocked and the user is informed with options (fix/skip/stop)"
    - "Build gates are on by default — the pre-PR gate runs unless explicitly disabled via git.build_gates.pre_pr: false"
    - "A build that hangs beyond the configured timeout (default 300s) is killed and reported as a failure"
    - "When git.flow is none or no build command is detected, the build gate is skipped gracefully"
  artifacts:
    - path: "hive/workflows/execute-plan.md"
      provides: "Build gate step between task completion and summary creation"
      contains: "run-build-gate"
  key_links:
    - from: "hive/workflows/execute-plan.md"
      to: "hive/bin/hive-tools.js"
      via: "git run-build-gate subcommand call after all tasks committed"
      pattern: "hive-tools\\.js git run-build-gate"
    - from: "hive/workflows/execute-plan.md"
      to: "config.json"
      via: "git_build_gates_pre_pr config check before running gate"
      pattern: "build_gates.*pre_pr"
---

<objective>
Add build gate orchestration to execute-plan.md: after all tasks complete and are committed, run the build command and block PR creation on failure, with per-gate config checks and timeout reporting.

Purpose: Broken code must never flow past the plan boundary. The pre-PR build gate catches failures before any PR is created (Phase 10), ensuring only validated code progresses.

Output: Modified execute-plan.md with a new build_gate step that calls Phase 8's run-build-gate subcommand, handles success/failure/timeout/skip, and offers fix/skip/stop options on failure.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-safety-configuration/08-01-SUMMARY.md
@.planning/phases/08-safety-configuration/08-02-SUMMARY.md
@.planning/phases/09-branch-lifecycle-build-gates/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build gate step to execute-plan workflow</name>
  <files>
    hive/workflows/execute-plan.md
    .claude/hive/workflows/execute-plan.md
  </files>
  <action>
    **1. Add a new `build_gate` step to execute-plan.md:**

    Insert a new step between the `verification_failure_gate` step (or after `record_completion_time`) and BEFORE the `generate_user_setup` step. This step runs after all tasks are completed and committed but before the summary is created.

    ```markdown
    <step name="build_gate">
    **Pre-PR build validation.** Runs after all tasks completed and committed, before summary creation.

    **Check if build gate applies:**

    ```bash
    GIT_FLOW=$(echo "$CONFIG_CONTENT" | jq -r '.git.flow // "github"')
    PRE_PR_GATE=$(echo "$CONFIG_CONTENT" | jq -r '.git.build_gates.pre_pr // true')
    ```

    **Skip conditions (any one skips the gate):**
    - `GIT_FLOW` is `"none"` -> Skip: "Git flow disabled. Skipping build gate."
    - `PRE_PR_GATE` is `false` -> Skip: "Pre-PR build gate disabled in config. Skipping."

    **Run build gate:**

    ```bash
    BUILD_RESULT=$(node ./.claude/hive/bin/hive-tools.js git run-build-gate --raw)
    BUILD_SUCCESS=$(echo "$BUILD_RESULT" | jq -r '.success')
    BUILD_SKIPPED=$(echo "$BUILD_RESULT" | jq -r '.skipped // false')
    BUILD_TIMED_OUT=$(echo "$BUILD_RESULT" | jq -r '.timedOut // false')
    BUILD_CMD=$(echo "$BUILD_RESULT" | jq -r '.command // "unknown"')
    BUILD_EXIT_CODE=$(echo "$BUILD_RESULT" | jq -r '.exitCode // "N/A"')
    BUILD_STDERR=$(echo "$BUILD_RESULT" | jq -r '.stderr // ""')
    ```

    **Handle results:**

    | Condition | Action |
    |-----------|--------|
    | `BUILD_SKIPPED` is `"true"` | No build command detected. Log: "No build command detected. Skipping build gate." Set `BUILD_GATE_RESULT="skipped"`. Continue to summary. |
    | `BUILD_SUCCESS` is `"true"` | Build passed. Log: "Build gate passed (command: ${BUILD_CMD})." Set `BUILD_GATE_RESULT="passed"`. Continue to summary. |
    | `BUILD_TIMED_OUT` is `"true"` | Build hung. See timeout handling below. Set `BUILD_GATE_RESULT="timeout"`. |
    | `BUILD_SUCCESS` is `"false"` | Build failed. See failure handling below. Set `BUILD_GATE_RESULT="failed"`. |

    **On build timeout:**

    **Team mode:**
    ```
    SendMessage(type="message", recipient="team-lead",
      summary="Build gate timed out: ${PLAN_ID}",
      content="BUILD GATE TIMED OUT
    Plan: ${PHASE}-${PLAN}
    Command: ${BUILD_CMD}
    Timeout: configured in git.build_timeout (default 300s)

    The build process was killed after exceeding the configured timeout.

    Possible causes:
    - Build command is interactive (requires user input)
    - Build command has an infinite loop or deadlock
    - Timeout is too short for this project

    Options:
    1. fix - Investigate and fix the build issue
    2. increase-timeout - Set a higher timeout
    3. skip - Proceed without build validation (note in SUMMARY)
    4. stop - Stop execution, investigate manually")
    ```

    **Classic mode:**
    ```
    ## Build Gate Timed Out

    **Plan:** ${PHASE}-${PLAN}
    **Command:** ${BUILD_CMD}
    **Timeout:** configured in git.build_timeout (default 300s)

    The build process was killed after exceeding the configured timeout.

    Possible causes:
    - Build command is interactive (requires user input)
    - Build command has an infinite loop or deadlock
    - Timeout is too short for this project

    Options:
    - "fix" - Investigate and fix the build issue
    - "increase-timeout" - Set a higher timeout
    - "skip" - Proceed without build validation
    - "stop" - Stop execution
    ```

    **On build failure (not timeout):**

    **Team mode:**
    ```
    SendMessage(type="message", recipient="team-lead",
      summary="Build gate failed: ${PLAN_ID}",
      content="BUILD GATE FAILED
    Plan: ${PHASE}-${PLAN}
    Command: ${BUILD_CMD}
    Exit code: ${BUILD_EXIT_CODE}

    stderr (truncated):
    ${BUILD_STDERR}

    Options:
    1. fix - I'll attempt to fix the build issue
    2. skip - Proceed without build validation (note in SUMMARY)
    3. stop - Stop execution, investigate manually")
    ```

    **Classic mode:**
    ```
    ## Build Gate Failed

    **Plan:** ${PHASE}-${PLAN}
    **Command:** ${BUILD_CMD}
    **Exit code:** ${BUILD_EXIT_CODE}

    **Output:**
    ${BUILD_STDERR}

    Options:
    - "fix" - Attempt to fix the build issue
    - "skip" - Proceed without build validation
    - "stop" - Stop execution
    ```

    **Handle user response to failure/timeout:**

    | Response | Action |
    |----------|--------|
    | "fix" | Investigate the build failure (read error output, check source files). Apply fixes. Commit fix: `fix(${PHASE}-${PLAN}): fix build failure — {description}`. Re-run build gate (loop back to `BUILD_RESULT` command). If passes: continue. If fails again: re-present options. |
    | "increase-timeout" (timeout only) | Ask user for new timeout value. Note: Cannot change config at runtime — advise user to update `git.build_timeout` in `.planning/config.json` and re-run. Or offer to skip. |
    | "skip" | Set `BUILD_GATE_RESULT="skipped_by_user"`. Continue to summary. The SUMMARY must note: "Build gate skipped by user after failure." |
    | "stop" | Stop execution. Report partial progress. Do NOT create SUMMARY.md. Exit. |

    **Record build gate result for SUMMARY:**

    Set `BUILD_GATE_RESULT` variable for use in create_summary step. Values: "passed", "skipped", "skipped_by_user", "failed", "timeout".
    </step>
    ```

    **2. Update the create_summary step to include build gate result:**

    In the existing `create_summary` step, add build gate information to the SUMMARY.md. After the "Issues Encountered" section, add:

    ```markdown
    **In SUMMARY.md, add a Build Gate section:**

    If `BUILD_GATE_RESULT` is set:

    ```
    ## Build Gate

    **Result:** ${BUILD_GATE_RESULT}
    **Command:** ${BUILD_CMD}

    {If "passed": "Build validation passed."}
    {If "skipped": "No build command detected or git flow disabled."}
    {If "skipped_by_user": "Build gate skipped by user after failure. Build command: ${BUILD_CMD}, Exit code: ${BUILD_EXIT_CODE}"}
    {If "failed": "Build failed. See Issues Encountered."}
    {If "timeout": "Build timed out. See Issues Encountered."}
    ```

    If BUILD_GATE_RESULT is not set (git flow none, gate disabled): omit the section entirely.
    ```

    **3. Sync to installed copy:**

    Copy `hive/workflows/execute-plan.md` to `.claude/hive/workflows/execute-plan.md`. Verify with `diff`.

    **Important implementation details:**
    - The `CONFIG_CONTENT` variable is already loaded in the `init_context` step via `--include config`. Use it directly — do NOT re-read config.json.
    - `run-build-gate` already handles: auto-detection of build command, config override via `git.build_command`, timeout conversion (seconds * 1000), stdout/stderr truncation at 2000 chars, flow bypass check. Do NOT duplicate any of this logic in the workflow.
    - The build gate runs on whatever branch the executor is currently on. In the Phase 9 flow, this is the plan branch. Do NOT switch branches before running the build gate.
    - When BUILD_GATE_RESULT is "skipped" (no build command detected), treat it as a PASS, not an error. This handles projects without test frameworks.
  </action>
  <verify>
    Run: `grep -c "run-build-gate" hive/workflows/execute-plan.md` — should return >= 1.

    Run: `grep -c "build_gate" hive/workflows/execute-plan.md` — should return >= 2 (step name + references).

    Run: `grep -c "BUILD_GATE_RESULT" hive/workflows/execute-plan.md` — should return >= 3 (set + used in summary + skip conditions).

    Run: `grep "build_gates.*pre_pr" hive/workflows/execute-plan.md` — should show the config check.

    Run: `grep -c "timedOut" hive/workflows/execute-plan.md` — should return >= 1 (timeout handling).

    Run: `diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md` — no differences.
  </verify>
  <done>
    execute-plan.md runs the build gate after all tasks complete: checks config (git.flow, build_gates.pre_pr), calls run-build-gate, handles pass/fail/timeout/skip, offers fix/skip/stop on failure, records result in SUMMARY.md. Build gates are on by default. Timeout is handled with clear user messaging. Source and installed copies are in sync.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "run-build-gate" hive/workflows/execute-plan.md` >= 1 — build gate wired into execute-plan
2. `grep "build_gates" hive/workflows/execute-plan.md` — per-gate config check present
3. `grep -c "timedOut" hive/workflows/execute-plan.md` >= 1 — timeout handling present
4. `grep "BUILD_GATE_RESULT" hive/workflows/execute-plan.md` — result tracked for SUMMARY
5. `grep "fix.*skip.*stop" hive/workflows/execute-plan.md` — user options on failure present
6. Source and installed copies match (diff returns empty)
</verification>

<success_criteria>
- Build gate runs after all tasks complete in execute-plan.md
- Gate checks git.flow and git.build_gates.pre_pr config before running
- run-build-gate subcommand called (not inline build logic)
- Build pass: continues to summary normally
- Build skip (no command): treated as pass, continues
- Build fail: blocks, presents error with fix/skip/stop options
- Build timeout: blocks, presents timeout info with fix/increase-timeout/skip/stop options
- Build result recorded in SUMMARY.md
- Source and installed copies are in sync
</success_criteria>

<output>
After completion, create `.planning/phases/09-branch-lifecycle-build-gates/09-02-SUMMARY.md`
</output>
