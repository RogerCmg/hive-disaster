---
phase: 09-branch-lifecycle-build-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - .claude/hive/bin/hive-tools.js
  - hive/workflows/new-project.md
  - .claude/hive/workflows/new-project.md
  - hive/workflows/new-milestone.md
  - .claude/hive/workflows/new-milestone.md
  - hive/workflows/execute-phase.md
  - .claude/hive/workflows/execute-phase.md
autonomous: true

must_haves:
  truths:
    - "Running /hive:new-project with git flow enabled creates a dev branch and checks it out"
    - "Starting a new milestone with git flow enabled creates a dev branch and checks it out"
    - "When a plan begins execution, a branch named hive/phase-{N}-{plan}-{slug} is created from dev and checked out"
    - "After a plan completes and is merged, its plan branch is deleted via safe delete"
    - "When git.flow is none, no branch operations occur (backward compatible)"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "cmdInitNewProject and cmdInitNewMilestone return git_flow and git_dev_branch fields"
      contains: "git_flow"
    - path: "hive/workflows/new-project.md"
      provides: "Git flow setup step after git init"
      contains: "create-dev-branch"
    - path: "hive/workflows/new-milestone.md"
      provides: "Git flow setup step during milestone start"
      contains: "create-dev-branch"
    - path: "hive/workflows/execute-phase.md"
      provides: "Plan branch creation in handle_branching step and cleanup in wave completion"
      contains: "create-plan-branch"
  key_links:
    - from: "hive/workflows/new-project.md"
      to: "hive/bin/hive-tools.js"
      via: "git create-dev-branch subcommand call"
      pattern: "hive-tools\\.js git create-dev-branch"
    - from: "hive/workflows/execute-phase.md"
      to: "hive/bin/hive-tools.js"
      via: "git create-plan-branch and delete-plan-branch subcommand calls"
      pattern: "hive-tools\\.js git create-plan-branch"
    - from: "hive/workflows/new-project.md"
      to: "cmdInitNewProject"
      via: "init JSON returns git_flow field that gates branch creation"
      pattern: "git_flow"
---

<objective>
Wire branch lifecycle into Hive workflows: dev branch creation on project/milestone init, plan-level branch creation before plan execution, and branch cleanup after merge.

Purpose: Plans must execute on isolated branches so concurrent work never conflicts and merge is explicit. This is the foundation for PR-based integration in Phase 10.

Output: Modified workflows (new-project.md, new-milestone.md, execute-phase.md) that call Phase 8 git subcommands at the right lifecycle points, plus extended init commands that return git config fields.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-safety-configuration/08-01-SUMMARY.md
@.planning/phases/08-safety-configuration/08-02-SUMMARY.md
@.planning/phases/09-branch-lifecycle-build-gates/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend init commands and add branch lifecycle to new-project and new-milestone workflows</name>
  <files>
    hive/bin/hive-tools.js
    .claude/hive/bin/hive-tools.js
    hive/workflows/new-project.md
    .claude/hive/workflows/new-project.md
    hive/workflows/new-milestone.md
    .claude/hive/workflows/new-milestone.md
  </files>
  <action>
    **1. Extend cmdInitNewProject (hive/bin/hive-tools.js, ~line 4287):**

    In the `result` object, add these fields after the existing `has_git` field:

    ```javascript
    // Git flow config (Phase 9)
    git_flow: config.git_flow,
    git_dev_branch: config.git_dev_branch,
    ```

    The `config` is already loaded via `loadConfig(cwd)` at line 4262. The `git_flow` and `git_dev_branch` fields already exist in loadConfig (from Phase 8). No new config parsing needed.

    **2. Extend cmdInitNewMilestone (hive/bin/hive-tools.js, ~line 4322):**

    In the `result` object, add these fields after the existing `state_exists` field:

    ```javascript
    // Git flow config (Phase 9)
    git_flow: config.git_flow,
    git_dev_branch: config.git_dev_branch,
    ```

    **3. Extend cmdInitExecutePhase (hive/bin/hive-tools.js, ~line 4100):**

    In the `result` object, add these fields (the init already has `branching_strategy` -- add the git flow fields alongside it):

    ```javascript
    // Git flow config (Phase 9)
    git_flow: config.git_flow,
    git_dev_branch: config.git_dev_branch,
    ```

    **4. Add git flow setup step to new-project.md:**

    In `hive/workflows/new-project.md`, after the `has_git` check and `git init` block in Step 1 (Setup), add a new subsection **before** Step 2:

    ```markdown
    **Git Flow Setup:**

    ```bash
    GIT_FLOW=$(echo "$INIT" | jq -r '.git_flow // "none"')
    GIT_DEV_BRANCH=$(echo "$INIT" | jq -r '.git_dev_branch // "dev"')
    ```

    **If GIT_FLOW is not "none":**

    ```bash
    DEV_RESULT=$(node ./.claude/hive/bin/hive-tools.js git create-dev-branch --raw)
    ```

    Parse result:
    - `created: true` -> Display: "Git flow enabled. Created and checked out branch: {dev_branch}"
    - `created: false, reason: 'already_exists'` -> Checkout dev: `git checkout ${GIT_DEV_BRANCH}`. Display: "Git flow enabled. Checked out existing branch: {dev_branch}"
    - `skipped: true` -> Display: "Git flow disabled. Continuing on current branch."

    **If GIT_FLOW is "none":** Skip. No branch operations.
    ```

    Also update the init parse line in Step 1 to include the new fields:
    `Parse JSON for: ... `git_flow`, `git_dev_branch`.`

    **5. Add git flow setup step to new-milestone.md:**

    In `hive/workflows/new-milestone.md`, after Step 7 (Load Context and Resolve Models) where `INIT` is parsed, add a new subsection:

    ```markdown
    **Git Flow Setup:**

    ```bash
    GIT_FLOW=$(echo "$INIT" | jq -r '.git_flow // "none"')
    GIT_DEV_BRANCH=$(echo "$INIT" | jq -r '.git_dev_branch // "dev"')
    ```

    **If GIT_FLOW is not "none":**

    ```bash
    DEV_RESULT=$(node ./.claude/hive/bin/hive-tools.js git create-dev-branch --raw)
    ```

    Parse result:
    - `created: true` -> Display: "Git flow enabled. Created and checked out branch: {dev_branch}"
    - `created: false, reason: 'already_exists'` -> Checkout dev: `git checkout ${GIT_DEV_BRANCH}`. Display: "Git flow enabled. Checked out existing branch: {dev_branch}"
    - `skipped: true` -> Display: "Git flow disabled. Continuing on current branch."

    **If GIT_FLOW is "none":** Skip. No branch operations.
    ```

    Also update the init parse line in Step 7 to include: `git_flow`, `git_dev_branch`.

    **6. Sync all modified files to .claude/ installed copies:**

    After modifying each source file under `hive/`, copy it to the corresponding `.claude/hive/` path:
    - `cp hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js`
    - `cp hive/workflows/new-project.md .claude/hive/workflows/new-project.md`
    - `cp hive/workflows/new-milestone.md .claude/hive/workflows/new-milestone.md`

    Verify with `diff` that source and installed copies match.

    **Important:** Do NOT use hardcoded "dev" anywhere. Always use the `git_dev_branch` config value (which defaults to "dev" via loadConfig).
  </action>
  <verify>
    Run: `node hive/bin/hive-tools.js init new-project --raw 2>/dev/null | jq '.git_flow, .git_dev_branch'` — should return `"github"` and `"dev"` (or current config values, not null).

    Run: `node hive/bin/hive-tools.js init new-milestone --raw 2>/dev/null | jq '.git_flow, .git_dev_branch'` — should return git config values, not null.

    Run: `grep -c "create-dev-branch" hive/workflows/new-project.md` — should return >= 1.

    Run: `grep -c "create-dev-branch" hive/workflows/new-milestone.md` — should return >= 1.

    Run: `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js` — should show no differences.

    Run: `diff hive/workflows/new-project.md .claude/hive/workflows/new-project.md` — should show no differences.
  </verify>
  <done>
    cmdInitNewProject and cmdInitNewMilestone return git_flow and git_dev_branch. new-project.md and new-milestone.md call create-dev-branch when git flow is enabled. All source and installed copies are in sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add plan branch creation and cleanup to execute-phase workflow</name>
  <files>
    hive/workflows/execute-phase.md
    .claude/hive/workflows/execute-phase.md
  </files>
  <action>
    **1. Rewrite the handle_branching step in execute-phase.md:**

    Replace the existing `handle_branching` step content. The current step checks `branching_strategy` from init and does a simple `git checkout -b`. Replace it with a two-tier check: git_flow first (Phase 9 plan-level branching), then branching_strategy fallback (legacy).

    New content for the `<step name="handle_branching">` section:

    ```markdown
    <step name="handle_branching">
    Check git flow config from init:

    ```bash
    GIT_FLOW=$(echo "$INIT" | jq -r '.git_flow // "none"')
    GIT_DEV_BRANCH=$(echo "$INIT" | jq -r '.git_dev_branch // "dev"')
    BRANCHING_STRATEGY=$(echo "$INIT" | jq -r '.branching_strategy // "none"')
    ```

    **Git flow "none" AND branching_strategy "none":** Skip, continue on current branch.

    **Git flow "github" (Phase 9+ plan-level branching):**

    Plan branches are created PER PLAN, not per phase. For each plan in the current wave, BEFORE spawning the executor:

    1. Generate the branch name:
    ```bash
    PLAN_SLUG=$(node ./.claude/hive/bin/hive-tools.js generate-slug "${PLAN_NAME}" --raw)
    BRANCH_NAME="hive/phase-${PHASE_NUMBER}-${PLAN_NUMBER}-${PLAN_SLUG}"
    ```

    2. Check if branch already exists (re-execution case):
    ```bash
    CURRENT=$(node ./.claude/hive/bin/hive-tools.js git current-branch --raw)
    CURRENT_BRANCH=$(echo "$CURRENT" | jq -r '.branch')
    ```

    3. If already on the target branch: skip creation, log "Already on plan branch: ${BRANCH_NAME}".

    4. If not on target branch, ensure dev branch exists first:
    ```bash
    # Ensure we are on dev before branching
    git checkout "${GIT_DEV_BRANCH}" 2>/dev/null || {
      # Dev branch missing — create it (handles upgrade from pre-Phase-9 projects)
      node ./.claude/hive/bin/hive-tools.js git create-dev-branch --raw
    }
    ```

    5. Create the plan branch:
    ```bash
    BRANCH_RESULT=$(node ./.claude/hive/bin/hive-tools.js git create-plan-branch --name "${BRANCH_NAME}" --raw)
    BRANCH_SUCCESS=$(echo "$BRANCH_RESULT" | jq -r '.success')
    ```

    6. If success: continue. If branch already exists (re-execution): `git checkout "${BRANCH_NAME}"`.

    7. Pass BRANCH_NAME to the executor agent prompt so it knows which branch it is on. Add to the executor spawn prompt:
    ```
    <branch_context>
    You are executing on branch: ${BRANCH_NAME}
    All task commits go to this branch. Do NOT switch branches during execution.
    </branch_context>
    ```

    **Branching_strategy "phase" or "milestone" (legacy fallback):**

    Preserve the existing behavior — use pre-computed `branch_name` from init:
    ```bash
    git checkout -b "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"
    ```

    All subsequent commits go to this branch. User handles merging.
    </step>
    ```

    **2. Add wave_branch_cleanup step after wave completion:**

    After the wave completion report (after step 4 in standalone mode, after step 5 in team mode), add a new cleanup section. Place this INSIDE the execute_waves step, after the wave completion report:

    ```markdown
    **Plan branch cleanup (git flow "github" only):**

    After wave completion and BEFORE proceeding to next wave, clean up merged plan branches.

    **Note:** In Phase 9, branches are cleaned up only after the plan has been merged to dev. Since Phase 10 implements the actual PR and merge flow, full cleanup activates when Phase 10 is complete. For Phase 9, include the cleanup logic so it is ready to be triggered by Phase 10's merge step.

    For each completed plan in the wave (where git_flow is "github"):
    ```bash
    # Switch to dev before deleting plan branch
    git checkout "${GIT_DEV_BRANCH}"

    CLEANUP=$(node ./.claude/hive/bin/hive-tools.js git delete-plan-branch "${BRANCH_NAME}" --raw)
    CLEANUP_SUCCESS=$(echo "$CLEANUP" | jq -r '.success')
    ```

    If cleanup succeeds: log "Cleaned up branch: ${BRANCH_NAME}".
    If cleanup fails with "not fully merged": log warning "Branch ${BRANCH_NAME} not yet merged — skipping cleanup (will be cleaned after merge in Phase 10)". Do NOT force-delete.
    If cleanup fails with other error: log warning but do not block execution.

    Branch cleanup is BEST EFFORT. Stale branches are informational, not harmful.
    ```

    **3. Update the init parse line** at the top of execute-phase.md to include the new fields:

    In the `Parse JSON for:` line, add: `git_flow`, `git_dev_branch`.

    **4. Sync to installed copy:**

    Copy `hive/workflows/execute-phase.md` to `.claude/hive/workflows/execute-phase.md`. Verify with `diff`.

    **Important anti-patterns to AVOID:**
    - Do NOT create branches inside execute-plan.md — execute-phase.md owns branch creation/cleanup (orchestrator responsibility, not executor responsibility)
    - Do NOT hardcode "dev" — always use `${GIT_DEV_BRANCH}` from config
    - Do NOT use `git branch -D` (force delete) — always use safe delete via `delete-plan-branch` subcommand which uses `-d`
    - Do NOT switch branches during plan execution — only between plans
  </action>
  <verify>
    Run: `grep -c "create-plan-branch" hive/workflows/execute-phase.md` — should return >= 1.

    Run: `grep -c "delete-plan-branch" hive/workflows/execute-phase.md` — should return >= 1.

    Run: `grep -c "git_flow" hive/workflows/execute-phase.md` — should return >= 2 (parse line + check).

    Run: `grep "hive/phase-" hive/workflows/execute-phase.md` — should show the branch naming pattern.

    Run: `diff hive/workflows/execute-phase.md .claude/hive/workflows/execute-phase.md` — no differences.

    Verify that the old `branching_strategy` fallback is preserved (backward compatibility).
  </verify>
  <done>
    execute-phase.md creates plan branches (hive/phase-{N}-{plan}-{slug}) from dev before spawning executors, passes branch context to executor agents, handles re-execution (existing branch checkout), and includes cleanup logic for post-merge deletion. Legacy branching_strategy fallback preserved.
  </done>
</task>

</tasks>

<verification>
1. `grep "git_flow" hive/bin/hive-tools.js | grep -c "config.git_flow"` — init commands return git config fields
2. `grep -c "create-dev-branch" hive/workflows/new-project.md` >= 1 — dev branch creation wired
3. `grep -c "create-dev-branch" hive/workflows/new-milestone.md` >= 1 — dev branch creation wired
4. `grep -c "create-plan-branch" hive/workflows/execute-phase.md` >= 1 — plan branch creation wired
5. `grep -c "delete-plan-branch" hive/workflows/execute-phase.md` >= 1 — branch cleanup wired
6. All source/installed copies in sync (diff returns empty for all modified files)
</verification>

<success_criteria>
- Init commands (new-project, new-milestone, execute-phase) all return git_flow and git_dev_branch
- new-project.md creates dev branch when git flow is not "none"
- new-milestone.md creates dev branch when git flow is not "none"
- execute-phase.md creates plan branches (hive/phase-{N}-{plan}-{slug}) per plan before executor spawn
- execute-phase.md includes cleanup logic for plan branch deletion after merge
- Legacy branching_strategy ("phase"/"milestone") still works as fallback
- All source and installed copies are in sync
</success_criteria>

<output>
After completion, create `.planning/phases/09-branch-lifecycle-build-gates/09-01-SUMMARY.md`
</output>
