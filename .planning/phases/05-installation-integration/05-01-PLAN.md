---
phase: 05-installation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - hive/bin/hive-tools.js
  - .claude/hive/bin/hive-tools.js
autonomous: true

must_haves:
  truths:
    - "After running the installer, settings.json contains SubagentStop, PostToolUseFailure, PreCompact, SessionStart (recall-session), and SessionEnd hook registrations pointing to hive-recall-*.js scripts"
    - "After running the installer twice, no duplicate hook registrations exist in settings.json"
    - "After running uninstall, all 4 hive-recall-*.js hook files are removed from the hooks directory"
    - "After running uninstall, settings.json contains no hive-recall hook registrations in any event type"
    - "After running config-ensure-section on a fresh project, config.json contains a telemetry section with enabled, hooks, workflow_events, and transcript_analysis keys"
  artifacts:
    - path: "bin/install.js"
      provides: "Recall hook registration in settings.json and uninstall cleanup"
      contains: "hive-recall-agent"
    - path: "hive/bin/hive-tools.js"
      provides: "Telemetry section in cmdConfigEnsureSection defaults"
      contains: "transcript_analysis"
    - path: ".claude/hive/bin/hive-tools.js"
      provides: "Installed copy of hive-tools.js with telemetry defaults"
      contains: "transcript_analysis"
  key_links:
    - from: "bin/install.js"
      to: "settings.json hooks object"
      via: "recallHooks array loop with idempotent push"
      pattern: "hive-recall-agent\\.js|hive-recall-error\\.js|hive-recall-compact\\.js|hive-recall-session\\.js"
    - from: "bin/install.js uninstall()"
      to: "hooks directory + settings.json"
      via: "gsdHooks file list and hiveHookPatterns filter"
      pattern: "hive-recall"
    - from: "hive/bin/hive-tools.js cmdConfigEnsureSection"
      to: ".planning/config.json"
      via: "defaults object with telemetry section"
      pattern: "telemetry.*enabled.*hooks.*workflow_events.*transcript_analysis"
---

<objective>
Wire Recall hook registration into the installer so `npx hive-cc` automatically deploys all telemetry hooks and config.

Purpose: Users get telemetry out of the box without manual setup. The 4 hook observer files (already copied by the existing pipeline) need their settings.json registrations, and the uninstall path needs to know about them for clean removal. Additionally, `cmdConfigEnsureSection` needs a telemetry section so fresh projects get config defaults.

Output: Modified `bin/install.js` with hook registration and uninstall cleanup, modified `hive/bin/hive-tools.js` with telemetry config defaults.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-installation-integration/05-RESEARCH.md
@bin/install.js
@hive/bin/hive-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Recall hooks in settings.json and update uninstall cleanup</name>
  <files>bin/install.js</files>
  <action>
Three targeted edits to `bin/install.js`:

**Edit 1 — Hook Registration (after line 1479, inside the `if (!isOpencode)` block):**

Add a Recall hook registration block immediately after the existing check-update hook registration. Follow the EXACT same idempotent pattern (check `.some()` before `.push()`):

```javascript
// ── Recall Hook Registration ──
const recallHooks = [
  { event: 'SubagentStop', file: 'hive-recall-agent.js', args: '' },
  { event: 'PostToolUseFailure', file: 'hive-recall-error.js', args: '' },
  { event: 'PreCompact', file: 'hive-recall-compact.js', args: '' },
  { event: 'SessionStart', file: 'hive-recall-session.js', args: ' start' },
  { event: 'SessionEnd', file: 'hive-recall-session.js', args: ' end' },
];

for (const { event, file, args } of recallHooks) {
  const command = isGlobal
    ? buildHookCommand(targetDir, file) + args
    : 'node ' + dirName + '/hooks/' + file + args;

  if (!settings.hooks[event]) {
    settings.hooks[event] = [];
  }

  const alreadyRegistered = settings.hooks[event].some(entry =>
    entry.hooks && entry.hooks.some(h => h.command && h.command.includes(file))
  );

  if (!alreadyRegistered) {
    settings.hooks[event].push({
      hooks: [{ type: 'command', command }]
    });
  }
}

console.log(`  ${green}✓${reset} Configured Recall hooks`);
```

IMPORTANT: This block must be INSIDE the existing `if (!isOpencode)` block (which starts at line 1456) but BEFORE the closing `}` of that block. The existing block ends right after line 1479. Place the new code between line 1479 and the closing `}`.

**Edit 2 — Uninstall Hook File List (line 855):**

Replace the existing `gsdHooks` array:
```javascript
const gsdHooks = ['hive-statusline.js', 'hive-check-update.js', 'hive-check-update.sh'];
```
With the extended version:
```javascript
const gsdHooks = [
  'hive-statusline.js', 'hive-check-update.js', 'hive-check-update.sh',
  'hive-recall-agent.js', 'hive-recall-error.js',
  'hive-recall-compact.js', 'hive-recall-session.js'
];
```

**Edit 3 — Uninstall settings.json Cleanup (lines 884-908):**

Replace the current `SessionStart`-only cleanup block with a comprehensive cleanup that handles ALL event types where Hive hooks may be registered:

```javascript
// Remove Hive hooks from all event types
if (settings.hooks) {
  const hiveHookPatterns = ['hive-check-update', 'hive-statusline', 'hive-recall'];
  let hooksRemoved = false;

  for (const eventType of Object.keys(settings.hooks)) {
    if (Array.isArray(settings.hooks[eventType])) {
      const before = settings.hooks[eventType].length;
      settings.hooks[eventType] = settings.hooks[eventType].filter(entry => {
        if (entry.hooks && Array.isArray(entry.hooks)) {
          return !entry.hooks.some(h =>
            h.command && hiveHookPatterns.some(pattern => h.command.includes(pattern))
          );
        }
        return true;
      });
      if (settings.hooks[eventType].length < before) {
        hooksRemoved = true;
      }
      // Clean up empty arrays
      if (settings.hooks[eventType].length === 0) {
        delete settings.hooks[eventType];
      }
    }
  }

  if (hooksRemoved) {
    settingsModified = true;
    console.log(`  ${green}✓${reset} Removed Hive hooks from settings`);
  }

  // Clean up empty hooks object
  if (Object.keys(settings.hooks).length === 0) {
    delete settings.hooks;
  }
}
```

This replaces the old block that only checked `settings.hooks.SessionStart`. The new version iterates ALL event types (SubagentStop, PostToolUseFailure, PreCompact, SessionStart, SessionEnd) and uses pattern matching to identify any Hive hook by its filename prefix.

DO NOT modify anything outside these 3 edit points. The rest of install.js remains unchanged.
  </action>
  <verify>
1. `grep -n 'hive-recall-agent' bin/install.js` returns matches in both the registration block and uninstall gsdHooks array
2. `grep -n 'hiveHookPatterns' bin/install.js` returns a match in the uninstall section
3. `grep -n 'SessionEnd' bin/install.js` returns a match in the recallHooks array
4. `node -c bin/install.js` passes (syntax check)
  </verify>
  <done>
bin/install.js registers 5 Recall hook events during install (idempotently), lists all 4 Recall hook files for uninstall cleanup, and removes Recall hook registrations from ALL event types during uninstall.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add telemetry defaults to cmdConfigEnsureSection and sync installed copy</name>
  <files>hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js</files>
  <action>
**Edit 1 — Source file (`hive/bin/hive-tools.js`):**

In the `cmdConfigEnsureSection` function (around line 711-725), add the `telemetry` section to the `defaults` object. After the `brave_search` line, add:

```javascript
    telemetry: {
      enabled: true,
      hooks: true,
      workflow_events: true,
      transcript_analysis: false,
    },
```

The full defaults object should end up as:
```javascript
  const defaults = {
    model_profile: 'balanced',
    commit_docs: true,
    search_gitignored: false,
    branching_strategy: 'none',
    phase_branch_template: 'hive/phase-{phase}-{slug}',
    milestone_branch_template: 'hive/{milestone}-{slug}',
    workflow: {
      research: true,
      plan_check: true,
      verifier: true,
    },
    parallelization: true,
    brave_search: hasBraveSearch,
    telemetry: {
      enabled: true,
      hooks: true,
      workflow_events: true,
      transcript_analysis: false,
    },
  };
```

**Edit 2 — Installed copy (`.claude/hive/bin/hive-tools.js`):**

Apply the SAME change to the installed copy. The installed copy uses `./` paths instead of `~/` paths but the `cmdConfigEnsureSection` function is identical in both files.

Verify both files have the telemetry section in the defaults object.
  </action>
  <verify>
1. `grep -A5 'telemetry' hive/bin/hive-tools.js | head -10` shows the telemetry section in defaults
2. `grep -A5 'telemetry' .claude/hive/bin/hive-tools.js | head -10` shows the same
3. `node -c hive/bin/hive-tools.js` passes (syntax check)
4. `node -c .claude/hive/bin/hive-tools.js` passes (syntax check)
  </verify>
  <done>
Both source and installed copies of hive-tools.js include telemetry defaults in cmdConfigEnsureSection, so fresh projects get the telemetry config section automatically.
  </done>
</task>

</tasks>

<verification>
1. **Syntax validation**: `node -c bin/install.js && node -c hive/bin/hive-tools.js && node -c .claude/hive/bin/hive-tools.js` all pass
2. **Hook registration present**: `grep -c 'hive-recall' bin/install.js` returns 6+ (registration array entries + uninstall list)
3. **Idempotency pattern**: `grep 'alreadyRegistered' bin/install.js` confirms idempotent check exists for recall hooks
4. **Uninstall coverage**: `grep 'hiveHookPatterns' bin/install.js` confirms pattern-based cleanup for all event types
5. **Telemetry defaults**: `grep 'transcript_analysis' hive/bin/hive-tools.js` confirms telemetry in config defaults
6. **Installed copy in sync**: `diff <(grep -A6 'telemetry:' hive/bin/hive-tools.js) <(grep -A6 'telemetry:' .claude/hive/bin/hive-tools.js)` shows no differences
</verification>

<success_criteria>
- bin/install.js registers 5 Recall hook events (SubagentStop, PostToolUseFailure, PreCompact, SessionStart, SessionEnd) in settings.json during install
- Registration is idempotent -- running install twice does not create duplicates
- bin/install.js uninstall removes all 4 hive-recall-*.js files and cleans all event types in settings.json
- hive-tools.js cmdConfigEnsureSection creates config.json with telemetry section including all 4 toggle keys
- All 3 modified files pass Node.js syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/05-installation-integration/05-01-SUMMARY.md`
</output>
