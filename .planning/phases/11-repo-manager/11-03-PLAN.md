---
phase: 11-repo-manager
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - hive/workflows/execute-plan.md
  - .claude/hive/workflows/execute-plan.md
  - hive/templates/config.json
  - .claude/hive/templates/config.json
autonomous: true

must_haves:
  truths:
    - "When `git.repo_manager` is true in config, execute-plan submits to the merge queue instead of self-merging"
    - "When `git.repo_manager` is false (default), execute-plan self-merges exactly as before — zero behavior change"
    - "The config template includes `repo_manager: false` in the git section"
    - "After queue submission, the executor reports the queue entry ID and suggests running `/hive:manage-repo`"
  artifacts:
    - path: "hive/workflows/execute-plan.md"
      provides: "Queue submission path in create_pr_and_merge step"
      contains: "repo_manager"
    - path: "hive/templates/config.json"
      provides: "repo_manager config flag"
      contains: "repo_manager"
  key_links:
    - from: "hive/workflows/execute-plan.md (create_pr_and_merge)"
      to: "hive-tools.js git queue-submit"
      via: "CLI invocation when repo_manager is true"
      pattern: "queue-submit"
    - from: "hive/templates/config.json (git.repo_manager)"
      to: "hive/workflows/execute-plan.md (repo_manager check)"
      via: "CONFIG_CONTENT jq read"
      pattern: "repo_manager"
---

<objective>
Wire execute-plan to submit to the merge queue when repo_manager is enabled, add the config flag, and ensure the default self-merge path is completely unchanged.

Purpose: This connects the plan execution pipeline to the repo manager. When enabled, completed plans are queued for validated merge instead of immediately self-merged. The default (repo_manager: false) preserves the Phase 10 self-merge flow exactly.

Output: Modified execute-plan.md with dual-path merge logic, updated config.json template with repo_manager flag.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-repo-manager/11-RESEARCH.md
@.planning/phases/11-repo-manager/11-01-SUMMARY.md
@.planning/phases/10-pr-workflow-integration/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add repo_manager config flag and queue submission path to execute-plan</name>
  <files>hive/workflows/execute-plan.md, hive/templates/config.json</files>
  <action>
**1. Update `hive/templates/config.json`** — Add `repo_manager: false` to the `git` section:

In the `"git"` object, after the `"merge_strategy": "merge"` line, add:
```json
    "repo_manager": false
```

This makes repo manager opt-in. Default behavior is self-merge (Phase 10 flow unchanged).

**2. Update `hive/workflows/execute-plan.md`** — Modify the `create_pr_and_merge` step:

In the `<step name="create_pr_and_merge">` section, after step 3 (push branch and create PR), BEFORE step 4 (self-merge), add a config check that gates the merge path:

After the PR creation succeeds (after `PR_URL` is captured), add this decision point:

```markdown
**3.5. Check merge path (repo manager vs self-merge):**

```bash
REPO_MANAGER=$(echo "$CONFIG_CONTENT" | jq -r '.git.repo_manager // false')
```

**If `REPO_MANAGER` is `true`:**

Submit to merge queue instead of self-merging:

```bash
# Extract plan metadata from frontmatter
PLAN_WAVE=$(grep -m1 "^wave:" "${PLAN_PATH}" | sed 's/wave: *//')

# Submit to merge queue
QUEUE_RESULT=$(node ./.claude/hive/bin/hive-tools.js git queue-submit \
  --plan-id "${PHASE}-${PLAN}" \
  --branch "$(git branch --show-current)" \
  --wave "${PLAN_WAVE}" \
  --pr-number "${PR_NUMBER}" \
  --pr-url "${PR_URL}" \
  --raw)
QUEUE_SUCCESS=$(echo "$QUEUE_RESULT" | jq -r '.success')
QUEUE_ID=$(echo "$QUEUE_RESULT" | jq -r '.id // empty')
```

If queue submission succeeded:
- Log: "Submitted to merge queue: ${QUEUE_ID} (PR #${PR_NUMBER}). Run `/hive:manage-repo` to process."
- Set `PR_FLOW_RESULT="queued"`.
- Do NOT self-merge. Do NOT checkout dev. The repo manager will handle merge and branch cleanup.
- Skip to step 6 (record PR result).

If queue submission failed:
- Log warning: "Failed to submit to merge queue. Falling back to self-merge."
- Continue to step 4 (self-merge) as fallback.

**If `REPO_MANAGER` is `false` or not set (default):**

Continue to step 4 (self-merge) — existing Phase 10 behavior, completely unchanged.
```

**Key constraint:** The existing self-merge code (steps 4 and 5) MUST remain exactly as-is. The repo_manager check is a NEW branch inserted before step 4. If repo_manager is false, execution flows into the existing step 4 without any modification.

**3. Update the PR Flow section in create_summary** (or the optional PR result append):

Add "queued" as a valid `PR_FLOW_RESULT` value. When the result is "queued", the SUMMARY should note:
```
## PR Flow

**Result:** queued
**PR:** ${PR_URL}
**Queue ID:** ${QUEUE_ID}
**Note:** Submitted to merge queue. Merge pending via /hive:manage-repo.
```
  </action>
  <verify>
Verify the config template has repo_manager: `grep 'repo_manager' hive/templates/config.json` should show `"repo_manager": false`. Verify execute-plan.md contains the repo_manager check: `grep 'repo_manager' hive/workflows/execute-plan.md` should show the REPO_MANAGER variable extraction and the condition. Verify the self-merge code is untouched: the existing step 4 content (self-merge PR with `self-merge-pr`) should be identical to before.
  </verify>
  <done>Config template has `repo_manager: false`. Execute-plan has dual-path: repo_manager true -> queue-submit, repo_manager false -> self-merge (unchanged). Fallback from queue failure to self-merge works.</done>
</task>

<task type="auto">
  <name>Task 2: Sync installed copies of modified files</name>
  <files>.claude/hive/workflows/execute-plan.md, .claude/hive/templates/config.json</files>
  <action>
**1. Sync execute-plan.md** from source to installed location with path substitution:
```bash
sed 's|~/\\.claude/|./.claude/|g' hive/workflows/execute-plan.md > .claude/hive/workflows/execute-plan.md
```

**2. Sync config.json** template from source to installed location:
```bash
cp hive/templates/config.json .claude/hive/templates/config.json
```

(config.json has no path references, so no sed substitution needed.)

**3. Verify both copies are in sync:**
- Compare key content: `grep 'repo_manager' .claude/hive/workflows/execute-plan.md` should match the source (with path adjustment)
- Compare config: `diff hive/templates/config.json .claude/hive/templates/config.json` should show no differences
  </action>
  <verify>
Run `grep 'repo_manager' .claude/hive/workflows/execute-plan.md` and confirm the config check is present. Run `grep 'repo_manager' .claude/hive/templates/config.json` and confirm the flag is present. Run `grep '~/.claude/' .claude/hive/workflows/execute-plan.md` and confirm no home-path references leaked into installed copy. Run `diff hive/templates/config.json .claude/hive/templates/config.json` and confirm no differences.
  </verify>
  <done>Installed copies (.claude/hive/) are in sync with source copies (hive/). Execute-plan installed copy uses ./.claude/ paths. Config template is identical in both locations.</done>
</task>

</tasks>

<verification>
1. `jq '.git.repo_manager' hive/templates/config.json` returns `false`
2. `grep -c 'repo_manager' hive/workflows/execute-plan.md` returns at least 2 (variable extraction + condition)
3. `grep 'queue-submit' hive/workflows/execute-plan.md` shows the queue submission CLI call
4. The existing self-merge code block (step 4) is unchanged from Phase 10
5. Installed copies are synced with correct path conventions
6. PR_FLOW_RESULT "queued" is documented for SUMMARY
</verification>

<success_criteria>
When `git.repo_manager` is true, execute-plan submits to the merge queue after PR creation and skips self-merge. When false (default), the Phase 10 self-merge flow runs exactly as before with zero changes. Config template includes the new flag. All installed copies are synced.
</success_criteria>

<output>
After completion, create `.planning/phases/11-repo-manager/11-03-SUMMARY.md`
</output>
