---
phase: 07-close-integration-gaps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - .claude/hive/bin/hive-tools.js
  - hive/workflows/execute-plan.md
  - .claude/hive/workflows/execute-plan.md
  - .planning/REQUIREMENTS.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running `hive-tools.js telemetry digest` with session_summary events produces INSIGHTS.md that includes session analysis patterns in Top Patterns and session recommendations in Recommendations"
    - "The execute-plan.md workflow extracts recall_context from init JSON and passes a <recall> block to Pattern A, Pattern B, A-team, and B-team spawned executors"
    - "All 34 requirement checkboxes in REQUIREMENTS.md show [x] and all 24 traceability rows for Phases 2-6 show Done"
    - "Flow 2 (Session Analysis) end-to-end: session_summary events feed into digest allPatternItems and recommendations, which feed into recall_context, which reaches future agents"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "session_summary event processing in cmdTelemetryDigest"
      contains: "session_summary"
    - path: "hive/workflows/execute-plan.md"
      provides: "Recall extraction and injection for executor agents"
      contains: "recall_context"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Accurate requirement completion status"
      contains: "[x] **HOOK-01**"
  key_links:
    - from: "hive/bin/hive-tools.js (cmdTelemetryDigest)"
      to: "allPatternItems array"
      via: "session_summary event filter feeding SESSION-type pattern items"
      pattern: "session_summary.*allPatternItems"
    - from: "hive/workflows/execute-plan.md"
      to: "spawned executor agents"
      via: "RECALL variable extraction and <recall> block injection"
      pattern: "recall_context.*recall"
    - from: ".claude/hive/bin/hive-tools.js"
      to: "hive/bin/hive-tools.js"
      via: "identical copy (source/installed sync)"
      pattern: "wc -l match"
---

<objective>
Wire three integration gaps identified by the v1.0 milestone audit: (1) session_summary events into the digest pipeline so session analysis patterns reach Top Patterns recall, (2) recall injection into execute-plan.md (the only agent-spawning workflow missing it), and (3) REQUIREMENTS.md checkbox sync to reflect verified completion status.

Purpose: Close the session analysis feedback loop end-to-end and ensure all cross-phase integration connections are wired (30/30).
Output: Updated hive-tools.js, execute-plan.md (source + installed copies), and REQUIREMENTS.md.
</objective>

<execution_context>
@~/.claude/hive/workflows/execute-plan.md
@~/.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-close-integration-gaps/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session_summary processing to cmdTelemetryDigest</name>
  <files>hive/bin/hive-tools.js, .claude/hive/bin/hive-tools.js</files>
  <action>
In `hive/bin/hive-tools.js`, in the `cmdTelemetryDigest` function, add session_summary event processing. All additions follow the existing filter-then-aggregate pattern used for deviations (line ~4752) and tool errors (line ~4761).

**Step 1 — Extract session patterns and recommendations (after the checkpoint outcomes block, around line 4780, before the deviation trend analysis):**

Add a new processing block:
```javascript
// Session analysis patterns (from session_summary events)
const sessionPatterns = {};
const sessionRecs = {};
events.filter(e => e.type === 'session_summary' && e.data).forEach(e => {
  const patterns = e.data.patterns || [];
  patterns.forEach(p => { sessionPatterns[p] = (sessionPatterns[p] || 0) + 1; });
  const recs = e.data.recommendations || [];
  recs.forEach(r => { sessionRecs[r] = (sessionRecs[r] || 0) + 1; });
});
```

**Step 2 — Feed session recommendations into the recommendations array (after the deviation trend recommendations, around line 4808):**

Add:
```javascript
Object.entries(sessionRecs).forEach(([rec, count]) => {
  if (count >= 2) {
    recommendations.push('Session analysis: "' + rec + '" (' + count + ' sessions)');
  }
});
```

**Step 3 — Feed session patterns into allPatternItems (after the toolErrorFreq push block, around line 4820):**

Add:
```javascript
Object.entries(sessionPatterns).forEach(([pattern, count]) => {
  allPatternItems.push({ type: 'SESSION', label: pattern + ' (seen in ' + count + ' sessions)', freq: count });
});
```

This ensures session analysis patterns compete on frequency with deviations and tool errors for the 5-line Top Patterns cap — no reserved slots.

**Step 4 — Add optional Session Analysis markdown section (between Tool Errors and Recommendations sections, around line 4913):**

Add:
```javascript
// Session Analysis (from session_summary events)
const sessionSummaries = events.filter(e => e.type === 'session_summary' && e.data);
if (sessionSummaries.length > 0) {
  lines.push('## Session Analysis');
  lines.push('');
  lines.push('*Sessions analyzed: ' + sessionSummaries.length + '*');
  const avgQuality = Math.round(sessionSummaries.reduce((sum, e) => sum + (e.data.quality_score || 0), 0) / sessionSummaries.length);
  lines.push('*Average quality score: ' + avgQuality + '/100*');
  lines.push('');
  if (Object.keys(sessionPatterns).length > 0) {
    lines.push('**Recurring patterns:**');
    Object.entries(sessionPatterns).sort((a, b) => b[1] - a[1]).slice(0, 5).forEach(([p, count]) => {
      lines.push('- ' + p + ' (' + count + ' sessions)');
    });
    lines.push('');
  }
}
```

**Step 5 — Sync installed copy:**

```bash
cp hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js
```

Verify line counts match:
```bash
wc -l hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js
```

**Do NOT change the digest version number (keep v2).** This is an enhancement, not a schema change.
  </action>
  <verify>
Create a test events.jsonl with session_summary events and run digest:

```bash
# Create temp telemetry dir with test data
mkdir -p /tmp/test-digest/.planning/telemetry
cat > /tmp/test-digest/.planning/telemetry/events.jsonl << 'JSONL'
{"ts":"2026-02-12T00:00:00Z","session":"test","type":"session_summary","v":1,"data":{"quality_score":75,"waste_pct":10,"patterns":["excessive retries on file reads","context pressure from large files"],"recommendations":["use targeted reads with line ranges","split large tasks"]}}
{"ts":"2026-02-12T01:00:00Z","session":"test2","type":"session_summary","v":1,"data":{"quality_score":80,"waste_pct":8,"patterns":["excessive retries on file reads","good error handling"],"recommendations":["use targeted reads with line ranges","add verification steps"]}}
JSONL

# Run digest
cd /tmp/test-digest && node /home/dico/dico-dev/hive-disaster/hive/bin/hive-tools.js telemetry digest --raw 2>/dev/null

# Verify INSIGHTS.md contains session content
grep -c "Session Analysis" /tmp/test-digest/.planning/telemetry/INSIGHTS.md
grep -c "SESSION" /tmp/test-digest/.planning/telemetry/INSIGHTS.md
grep -c "excessive retries" /tmp/test-digest/.planning/telemetry/INSIGHTS.md

# Cleanup
rm -rf /tmp/test-digest
```

All three grep commands should return counts >= 1.
  </verify>
  <done>
INSIGHTS.md has a Session Analysis section with session count and average quality score. Session patterns feed into allPatternItems with type SESSION. Session recommendations with count >= 2 feed into recommendations. Source and installed copies are identical.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add recall extraction and injection to execute-plan.md</name>
  <files>hive/workflows/execute-plan.md, .claude/hive/workflows/execute-plan.md</files>
  <action>
In `hive/workflows/execute-plan.md`, add recall extraction and injection following the exact 3-step pattern used in 10 other workflows (e.g., execute-phase.md lines 24-26 and 190-196).

**Step 1 — Add RECALL extraction after the init_context step's extraction line (after line 21 "Extract from init JSON..."):**

Add these lines after the existing extraction instructions:

```markdown
Extract recall context for agent prompts:
```bash
RECALL=$(echo "$INIT" | jq -r '.recall_context // empty')
```
```

**Step 2 — Add recall block to Pattern A description (in the parse_segments step, Pattern A description around line 84):**

In the Pattern A description text, after the existing prompt description ("execute plan at [path], autonomous, all tasks + SUMMARY + commit, follow deviation/auth rules, report: plan name, tasks, SUMMARY path, commit hash"), add recall injection instruction:

Change the Pattern A line to include recall:
```
**Pattern A:** init_agent_tracking -> spawn Task(subagent_type="hive-executor", model=executor_model) with prompt: execute plan at [path], autonomous, all tasks + SUMMARY + commit, follow deviation/auth rules, report: plan name, tasks, SUMMARY path, commit hash. {If RECALL is non-empty, include <recall> block with past project patterns.} -> track agent_id -> wait -> update tracking -> report.
```

**Step 3 — Add recall block to Pattern B description (around line 86):**

In the Pattern B segment subagent description, add recall instruction. After "spawn hive-executor for assigned tasks only" add: Include `<recall>` block if RECALL is non-empty.

Change the segment_execution step's subagent route (around line 132) to:
```
   - Subagent route: spawn hive-executor for assigned tasks only. Prompt: task range, plan path, read full plan for context, execute assigned tasks, track deviations, NO SUMMARY/commit. {If RECALL is non-empty, include <recall> block with past project patterns.} Track via agent protocol.
```

**Step 4 — Add recall block to Team Routing patterns (A-team and B-team, around lines 96-101):**

Update Pattern A-team description to include:
```
**Pattern A-team:** Send plan to executor teammate. {If RECALL is non-empty, include <recall> block with past project patterns in the message.} Executor runs full plan autonomously, sending progress updates per task. On completion, sends PLAN COMPLETE message.
```

Update Pattern B-team description to include:
```
**Pattern B-team:** Send plan to executor teammate. {If RECALL is non-empty, include <recall> block with past project patterns in the message.} Executor runs until checkpoint, sends checkpoint message to team lead, waits. Team lead relays to user, gets response, sends back to executor. Executor continues with full context. **No segmentation, no continuation agents, no context loss.**
```

**Step 5 — Sync installed copy:**

```bash
cp hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md
```

Verify line counts match:
```bash
wc -l hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md
```

**Important:** Do NOT add recall to Pattern C (main context execution) — it does not spawn a subagent.
  </action>
  <verify>
```bash
# Verify recall extraction exists
grep -c "recall_context" hive/workflows/execute-plan.md

# Verify recall blocks exist in spawn patterns
grep -c "recall" hive/workflows/execute-plan.md

# Verify installed copy matches
diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md
```

The `recall_context` grep should return >= 1. The `recall` grep should return >= 5 (extraction + 4 spawn points). The diff should return empty (no differences).
  </verify>
  <done>
execute-plan.md extracts RECALL from init JSON and includes `<recall>` block instructions in Pattern A, Pattern B, A-team, and B-team spawn descriptions. Pattern C (main context, no spawn) is correctly skipped. Source and installed copies are identical.
  </done>
</task>

<task type="auto">
  <name>Task 3: Sync REQUIREMENTS.md checkboxes with verified status</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
Update `.planning/REQUIREMENTS.md` to reflect the verified completion status of all 34 requirements. Source of truth: 6 phase verification reports, all `status: passed`.

**Step 1 — Flip requirement checkboxes from `[ ]` to `[x]` for Phases 2-6 (24 items):**

Lines 25-31 (HOOK section): Change all 7 items from `- [ ]` to `- [x]`:
- HOOK-01 through HOOK-07

Lines 35-39 (WFLOW section): Change all 5 items from `- [ ]` to `- [x]`:
- WFLOW-01 through WFLOW-05

Lines 43-48 (FEED section): Change all 6 items from `- [ ]` to `- [x]`:
- FEED-01 through FEED-06

Lines 52-54 (INST section): Change all 3 items from `- [ ]` to `- [x]`:
- INST-01 through INST-03

Lines 58-60 (TRANS section): Change all 3 items from `- [ ]` to `- [x]`:
- TRANS-01 through TRANS-03

**Step 2 — Update traceability table rows for Phases 2-6 (24 rows):**

Lines 101-124: Change all "Pending" entries to "Done ✓":
- HOOK-01 through HOOK-07 (lines 101-107)
- WFLOW-01 through WFLOW-05 (lines 108-112)
- FEED-01 through FEED-06 (lines 113-118)
- INST-01 through INST-03 (lines 119-121)
- TRANS-01 through TRANS-03 (lines 122-124)

**Step 3 — Update the last-updated line (line 133):**

Change:
```
*Last updated: 2026-02-12 after Phase 1 completion*
```
To:
```
*Last updated: 2026-02-12 after Phase 7 gap closure*
```

**Do NOT modify the INFRA section (already correct) or any v2/Out of Scope sections.**
  </action>
  <verify>
```bash
# Count checked boxes — should be 34 total
grep -c '\[x\]' .planning/REQUIREMENTS.md

# Count unchecked boxes — should be 0 in v1 section
grep -c '\[ \]' .planning/REQUIREMENTS.md

# Count "Pending" in traceability — should be 0
grep -c 'Pending' .planning/REQUIREMENTS.md

# Count "Done" in traceability — should be 34
grep -c 'Done' .planning/REQUIREMENTS.md
```

34 checked, 0 unchecked in v1 section, 0 Pending, 34 Done.
  </verify>
  <done>
All 34 v1 requirement checkboxes show `[x]`. All 34 traceability rows show "Done ✓". Last-updated line reflects Phase 7 gap closure.
  </done>
</task>

</tasks>

<verification>
1. **Digest pipeline test:** Create test events.jsonl with session_summary events, run `hive-tools.js telemetry digest`, verify INSIGHTS.md contains Session Analysis section and SESSION-type items in Top Patterns
2. **Recall injection test:** `grep -c "recall_context" hive/workflows/execute-plan.md` returns >= 1; `grep -c "recall" hive/workflows/execute-plan.md` returns >= 5
3. **Requirements sync test:** `grep -c '\[x\]' .planning/REQUIREMENTS.md` returns 34; `grep -c 'Pending' .planning/REQUIREMENTS.md` returns 0
4. **Source/installed copy sync:** `diff hive/bin/hive-tools.js .claude/hive/bin/hive-tools.js` and `diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md` both return empty
</verification>

<success_criteria>
- INSIGHTS.md includes session_summary patterns in Top Patterns recall markers when session_summary events exist
- execute-plan.md extracts recall_context and injects recall blocks in all 4 spawn patterns (A, B, A-team, B-team)
- REQUIREMENTS.md has 34/34 checkboxes checked and 34/34 traceability rows showing Done
- All source/installed file pairs are identical
</success_criteria>

<output>
After completion, create `.planning/phases/07-close-integration-gaps/07-01-SUMMARY.md`
</output>
