---
phase: 03-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - hive/workflows/execute-plan.md
  - .claude/hive/workflows/execute-plan.md
  - hive/workflows/execute-phase.md
  - .claude/hive/workflows/execute-phase.md
autonomous: true

must_haves:
  truths:
    - "When workflow_events is false in config, workflow emit calls are silently skipped"
    - "When an executor auto-fixes a deviation (Rules 1-3), a deviation event with phase, plan, severity=auto, and resolution appears in events.jsonl"
    - "When an executor escalates a deviation (Rule 4), a deviation event with severity=architectural and the user decision appears in events.jsonl"
    - "When a checkpoint resolves in team mode, a checkpoint event with type, user_response, and outcome appears in events.jsonl"
    - "When a checkpoint resolves in standalone mode, a checkpoint event with type, user_response, and outcome appears in events.jsonl"
    - "When a user skips a verification failure or modifies plan selection, a user_correction event appears in events.jsonl"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "workflow_events config enforcement in cmdTelemetryEmit"
      contains: "WORKFLOW_EVENT_TYPES"
    - path: "hive/workflows/execute-plan.md"
      provides: "Deviation emit instructions and user_correction emit at gates"
      contains: "telemetry emit deviation"
    - path: "hive/workflows/execute-phase.md"
      provides: "Checkpoint emit instructions in both team and standalone modes"
      contains: "telemetry emit checkpoint"
  key_links:
    - from: "hive/workflows/execute-plan.md"
      to: "hive/bin/hive-tools.js"
      via: "telemetry emit deviation CLI call"
      pattern: "hive-tools\\.js telemetry emit deviation"
    - from: "hive/workflows/execute-phase.md"
      to: "hive/bin/hive-tools.js"
      via: "telemetry emit checkpoint CLI call"
      pattern: "hive-tools\\.js telemetry emit checkpoint"
    - from: "hive/bin/hive-tools.js"
      to: "config.json workflow_events toggle"
      via: "WORKFLOW_EVENT_TYPES check in cmdTelemetryEmit"
      pattern: "WORKFLOW_EVENT_TYPES.*includes.*workflow_events"
---

<objective>
Add workflow_events config enforcement to the telemetry CLI, then insert deviation event emits into execute-plan.md and checkpoint event emits into execute-phase.md. Also add user_correction emits at the verification_failure_gate and identify_plan confirmation gate in execute-plan.md.

Purpose: Captures execution-time semantic events (deviations, checkpoints, user corrections) that hooks cannot observe, enabling Recall to learn from how agents handle unexpected situations and how users interact at decision points.
Output: Modified hive-tools.js with workflow_events gating, execute-plan.md with deviation and user_correction emit instructions, execute-phase.md with checkpoint emit instructions in both team and standalone modes.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workflow-integration/03-RESEARCH.md
@hive/bin/hive-tools.js
@hive/workflows/execute-plan.md
@hive/workflows/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workflow_events config enforcement and deviation/user_correction emits to execute-plan.md</name>
  <files>
    hive/bin/hive-tools.js
    hive/workflows/execute-plan.md
    .claude/hive/workflows/execute-plan.md
  </files>
  <action>
**Part A: hive-tools.js -- Add workflow_events enforcement to cmdTelemetryEmit**

In `hive/bin/hive-tools.js`, find the `cmdTelemetryEmit` function (around line 4578). After the existing `if (!telConfig.enabled)` check (line 4587-4590), add a workflow_events toggle check:

```javascript
const WORKFLOW_EVENT_TYPES = [
  'deviation', 'checkpoint', 'verification_gap', 'plan_revision', 'user_correction'
];
if (WORKFLOW_EVENT_TYPES.includes(type) && !telConfig.workflow_events) {
  output({ emitted: false, reason: 'workflow_events disabled' }, raw, 'disabled');
  return;
}
```

This ensures that when `workflow_events: false` in config.json, all 5 workflow event types are silently skipped while hooks and other event types still work.

**Part B: execute-plan.md -- Add deviation emit instructions (WFLOW-01)**

In `hive/workflows/execute-plan.md`, find the `<deviation_rules>` section (starts around line 192). After the Rule 1-3 auto-fix table row descriptions (around line 203, after the table and before the Rule 4 format section), insert a deviation emit instruction block:

```markdown
**After applying any auto-fix (Rules 1-3), emit a deviation event for Recall:**

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit deviation \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"${PLAN_ID}\",\"deviation_type\":\"rule-${RULE_NUM}\",\"severity\":\"auto\",\"description\":\"${DEVIATION_TITLE}\",\"resolution\":\"${RESOLUTION}\"}"
\`\`\`
```

Then after the Rule 4 decision handling (after line 222 "Wait for response. Implement based on decision. Continue execution." in team mode, and after line 236 classic mode response handling), insert:

```markdown
**After Rule 4 resolution (user responded), emit the deviation event:**

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit deviation \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"${PLAN_ID}\",\"deviation_type\":\"rule-4\",\"severity\":\"architectural\",\"description\":\"${DEVIATION_TITLE}\",\"resolution\":\"${USER_DECISION}\"}"
\`\`\`
```

**Part C: execute-plan.md -- Add user_correction emits at gates (WFLOW-05)**

1. In the `<step name="identify_plan">` section (line 50-52, the interactive mode block), after the confirmation handling, add:

```markdown
If user modifies the plan selection or provides different instructions, emit a user_correction event:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit user_correction \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"${PLAN_ID}\",\"what_changed\":\"plan-selection\",\"user_intent\":\"${USER_RESPONSE}\"}"
\`\`\`
```

2. In the `<step name="verification_failure_gate">` section (around line 349-371), after the "If skipped" line (line 370), add:

```markdown
If user chose "skip", emit a user_correction event:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit user_correction \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"${PLAN_ID}\",\"what_changed\":\"verification-skip\",\"user_intent\":\"${USER_RESPONSE}\"}"
\`\`\`
```

**Part D: Sync to installed copy**

Copy the modified `hive/workflows/execute-plan.md` content identically to `.claude/hive/workflows/execute-plan.md`. Both files must be identical.

**Important notes:**
- Do NOT add `if telemetry enabled` checks in the markdown -- the CLI handles config gating.
- Use shell variable placeholders (${PHASE_NUMBER}, etc.) that the executing agent will fill from its context.
- Keep descriptions metadata-only (no code content) per privacy principle.
- Emit AFTER the event resolves, never before.
  </action>
  <verify>
1. Run `grep -c "WORKFLOW_EVENT_TYPES" hive/bin/hive-tools.js` -- should return >= 2 (definition + usage)
2. Run `grep -c "telemetry emit deviation" hive/workflows/execute-plan.md` -- should return >= 2 (auto-fix + Rule 4)
3. Run `grep -c "telemetry emit user_correction" hive/workflows/execute-plan.md` -- should return >= 2 (identify_plan + verification_failure)
4. Run `diff hive/workflows/execute-plan.md .claude/hive/workflows/execute-plan.md` -- should show no differences
5. Run `node hive/bin/hive-tools.js telemetry emit deviation --data '{"test":true}'` to confirm it still works (emits OK)
  </verify>
  <done>
cmdTelemetryEmit checks workflow_events toggle for all 5 workflow event types. execute-plan.md contains deviation emit instructions after Rules 1-3 auto-fix and Rule 4 resolution, plus user_correction emits at identify_plan and verification_failure_gate. Source and installed copies are identical.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add checkpoint emit instructions to execute-phase.md in both team and standalone modes</name>
  <files>
    hive/workflows/execute-phase.md
    .claude/hive/workflows/execute-phase.md
  </files>
  <action>
**Part A: Team mode checkpoint emit (WFLOW-02)**

In `hive/workflows/execute-phase.md`, find the team mode checkpoint handling section (around line 256-283). After step (d) where the CHECKPOINT_RESPONSE is sent back to the executor (line 278-281), and before step (e) "Executor wakes up with full context", insert:

```markdown
   d2. Emit the checkpoint resolution event for Recall:
      \`\`\`bash
      node ~/.claude/hive/bin/hive-tools.js telemetry emit checkpoint \
        --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"${PLAN_ID}\",\"checkpoint_type\":\"${CHECKPOINT_TYPE}\",\"user_response\":\"${USER_RESPONSE}\",\"outcome\":\"${OUTCOME}\"}"
      \`\`\`
```

Also find the team mode Deviation Rule 4 handling section (around line 285-310). After step (d) where the DEVIATION_RESPONSE is sent (line 304-309), this is where the orchestrator relays the user decision. The executor will emit the actual deviation event (handled in execute-plan.md Plan 01 Task 1). No additional emit needed here -- the executor has first-hand data.

**Part B: Standalone mode checkpoint emit (WFLOW-02)**

In the `<standalone_checkpoints>` section (line 561-589), after step 5 "User responds" (line 577) and before step 6 "Spawn continuation agent" (line 578), insert:

```markdown
5b. Emit the checkpoint resolution event for Recall:
   \`\`\`bash
   node ~/.claude/hive/bin/hive-tools.js telemetry emit checkpoint \
     --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"${PLAN_ID}\",\"checkpoint_type\":\"${CHECKPOINT_TYPE}\",\"user_response\":\"${USER_RESPONSE}\",\"outcome\":\"${OUTCOME}\"}"
   \`\`\`
```

**Part C: Sync to installed copy**

Copy the modified `hive/workflows/execute-phase.md` content identically to `.claude/hive/workflows/execute-phase.md`. Both files must be identical.

**Important notes:**
- Checkpoint emits go in execute-phase.md (the orchestrator) because the orchestrator is the one resolving checkpoints with the user and has the checkpoint type, response, and outcome data.
- Both team_mode and standalone_mode sections MUST have the emit instruction -- otherwise events are only captured in one execution mode.
- The checkpoint_type should be one of: human-verify, decision, human-action.
- The outcome should be one of: passed, selected, completed, issues-reported.
  </action>
  <verify>
1. Run `grep -c "telemetry emit checkpoint" hive/workflows/execute-phase.md` -- should return >= 2 (team mode + standalone mode)
2. Verify team_mode has the emit: `grep -A2 "CHECKPOINT_RESPONSE" hive/workflows/execute-phase.md | grep -c "telemetry"` -- should return >= 1
3. Verify standalone has the emit: search within standalone_checkpoints section for "telemetry emit checkpoint"
4. Run `diff hive/workflows/execute-phase.md .claude/hive/workflows/execute-phase.md` -- should show no differences
  </verify>
  <done>
execute-phase.md contains checkpoint emit instructions in both team_mode (after sending CHECKPOINT_RESPONSE to executor) and standalone_mode (after user responds, before spawning continuation agent). Source and installed copies are identical.
  </done>
</task>

</tasks>

<verification>
1. `grep "WORKFLOW_EVENT_TYPES" hive/bin/hive-tools.js` confirms config enforcement exists
2. `grep "telemetry emit deviation" hive/workflows/execute-plan.md` confirms deviation emits present
3. `grep "telemetry emit checkpoint" hive/workflows/execute-phase.md` confirms checkpoint emits present
4. `grep "telemetry emit user_correction" hive/workflows/execute-plan.md` confirms user_correction emits present
5. Both source/installed pairs are identical (diff returns empty)
6. `node hive/bin/hive-tools.js telemetry emit deviation --data '{"phase":"test","plan":"test","deviation_type":"rule-1","severity":"auto","description":"test","resolution":"test"}'` succeeds
</verification>

<success_criteria>
- cmdTelemetryEmit rejects workflow event types when workflow_events is false
- execute-plan.md has deviation emit after Rules 1-3 and Rule 4
- execute-plan.md has user_correction emit at identify_plan and verification_failure_gate
- execute-phase.md has checkpoint emit in both team_mode and standalone_mode
- All source files synced to .claude/hive/workflows/ installed copies
- WFLOW-01, WFLOW-02, and WFLOW-05 (execute-plan gates) requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-integration/03-01-SUMMARY.md`
</output>
