---
phase: 03-workflow-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/workflows/verify-phase.md
  - .claude/hive/workflows/verify-phase.md
  - hive/workflows/plan-phase.md
  - .claude/hive/workflows/plan-phase.md
autonomous: true

must_haves:
  truths:
    - "When verification finds a failed truth, a verification_gap event with level=truth appears in events.jsonl"
    - "When verification finds a missing or stub artifact, a verification_gap event with level=artifact appears in events.jsonl"
    - "When verification finds an unwired key link, a verification_gap event with level=wiring appears in events.jsonl"
    - "When a plan is revised after checker feedback, a plan_revision event with round number and changes summary appears in events.jsonl"
    - "When a user provides guidance at max iterations or force-proceeds, a user_correction event appears in events.jsonl"
  artifacts:
    - path: "hive/workflows/verify-phase.md"
      provides: "Verification gap emit instructions at truth, artifact, and wiring check points"
      contains: "telemetry emit verification_gap"
    - path: "hive/workflows/plan-phase.md"
      provides: "Plan revision emit and user_correction emit at max iterations"
      contains: "telemetry emit plan_revision"
  key_links:
    - from: "hive/workflows/verify-phase.md"
      to: "hive/bin/hive-tools.js"
      via: "telemetry emit verification_gap CLI call"
      pattern: "hive-tools\\.js telemetry emit verification_gap"
    - from: "hive/workflows/plan-phase.md"
      to: "hive/bin/hive-tools.js"
      via: "telemetry emit plan_revision CLI call"
      pattern: "hive-tools\\.js telemetry emit plan_revision"
    - from: "hive/workflows/plan-phase.md"
      to: "hive/bin/hive-tools.js"
      via: "telemetry emit user_correction CLI call"
      pattern: "hive-tools\\.js telemetry emit user_correction"
---

<objective>
Insert verification_gap event emits into verify-phase.md at truth, artifact, and wiring failure points, and insert plan_revision and user_correction event emits into plan-phase.md at the revision loop and max-iteration gate.

Purpose: Captures planning/verification-time semantic events -- verification failures that reveal implementation gaps, plan revision patterns that show checker effectiveness, and user overrides at iteration limits -- enabling Recall to learn from verification outcomes and planning iterations.
Output: Modified verify-phase.md with verification_gap emit instructions, modified plan-phase.md with plan_revision and user_correction emit instructions.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-workflow-integration/03-RESEARCH.md
@hive/workflows/verify-phase.md
@hive/workflows/plan-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verification_gap emit instructions to verify-phase.md</name>
  <files>
    hive/workflows/verify-phase.md
    .claude/hive/workflows/verify-phase.md
  </files>
  <action>
**Part A: Truth verification failure emit (WFLOW-03)**

In `hive/workflows/verify-phase.md`, find the `<step name="verify_truths">` section (starts around line 72). After the explanation of status determination (line 79, the example about Chat.tsx), add:

```markdown
When a truth's status is FAILED, emit a verification_gap event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit verification_gap \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"level\":\"truth\",\"what_failed\":\"${TRUTH_DESCRIPTION}\",\"expected\":\"VERIFIED\",\"actual\":\"FAILED\"}"
\`\`\`
```

**Part B: Artifact verification failure emit (WFLOW-03)**

In the `<step name="verify_artifacts">` section (starts around line 82), after the status table (line 107-111, the Exists/Substantive/Wired table), add:

```markdown
When an artifact status is MISSING, STUB, or ORPHANED, emit a verification_gap event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit verification_gap \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"level\":\"artifact\",\"what_failed\":\"${ARTIFACT_PATH}\",\"expected\":\"VERIFIED\",\"actual\":\"${ARTIFACT_STATUS}\"}"
\`\`\`

Where ARTIFACT_STATUS is one of: MISSING, STUB, ORPHANED.
```

**Part C: Wiring verification failure emit (WFLOW-03)**

In the `<step name="verify_wiring">` section (starts around line 114), after the link status explanation (around line 130, after "Pattern not found" line), add:

```markdown
When a key link status is NOT_WIRED or PARTIAL, emit a verification_gap event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit verification_gap \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"level\":\"wiring\",\"what_failed\":\"${LINK_FROM} -> ${LINK_TO}\",\"expected\":\"WIRED\",\"actual\":\"${LINK_STATUS}\"}"
\`\`\`

Where LINK_STATUS is one of: NOT_WIRED, PARTIAL.
```

**Part D: Sync to installed copy**

Copy the modified `hive/workflows/verify-phase.md` content identically to `.claude/hive/workflows/verify-phase.md`. Both files must be identical.

**Important notes:**
- WFLOW-03 targets verify-phase.md (automated goal verification), NOT verify-work.md (UAT). The research confirmed this distinction.
- Emit only when a check FAILS, not for every check. Do not emit for VERIFIED/WIRED items.
- The `level` field distinguishes truth, artifact, and wiring failures so Recall can track which verification level catches the most gaps.
- Keep what_failed to identifiers (truth description, file path, link from->to) -- no code content.
  </action>
  <verify>
1. Run `grep -c "telemetry emit verification_gap" hive/workflows/verify-phase.md` -- should return >= 3 (truth, artifact, wiring)
2. Verify truth section has emit: `grep -A1 "verify_truths" hive/workflows/verify-phase.md` area contains "telemetry emit"
3. Verify artifact section has emit: search verify_artifacts area for "telemetry emit"
4. Verify wiring section has emit: search verify_wiring area for "telemetry emit"
5. Run `diff hive/workflows/verify-phase.md .claude/hive/workflows/verify-phase.md` -- should show no differences
  </verify>
  <done>
verify-phase.md contains verification_gap emit instructions at all three verification levels: truth (FAILED), artifact (MISSING/STUB/ORPHANED), and wiring (NOT_WIRED/PARTIAL). Source and installed copies are identical. WFLOW-03 requirement satisfied.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add plan_revision and user_correction emit instructions to plan-phase.md</name>
  <files>
    hive/workflows/plan-phase.md
    .claude/hive/workflows/plan-phase.md
  </files>
  <action>
**Part A: Plan revision emit in team mode (WFLOW-04)**

In `hive/workflows/plan-phase.md`, find section "## 12. Revision Loop" (around line 380), specifically the `<team_mode>` block. After the line "Wait for planner response. Expect `REVISION COMPLETE:` message." (around line 401) and before "Parse changed plan IDs from message." (line 402), insert:

```markdown
After receiving the revision, emit a plan_revision event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit plan_revision \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"round\":${ITERATION_COUNT},\"changes_summary\":\"${PLANNER_CHANGES_SUMMARY}\",\"reason\":\"Checker found issues\"}"
\`\`\`
```

**Part B: Plan revision emit in standalone mode (WFLOW-04)**

In the same section, find the `<standalone_mode>` block. After the line "After planner returns -> spawn checker again (step 10), increment iteration_count." (around line 467), insert the same emit instruction:

```markdown
After planner returns revised plans, emit a plan_revision event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit plan_revision \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"round\":${ITERATION_COUNT},\"changes_summary\":\"${PLANNER_CHANGES_SUMMARY}\",\"reason\":\"Checker found issues\"}"
\`\`\`
```

**Part C: User correction emit at max iterations (WFLOW-05)**

In the team_mode block, find the "If iteration_count >= 3" section (around line 418-422) where the user is offered 3 options (Force proceed / Provide guidance / Abandon). After the "Offer:" line, add:

```markdown
After user responds, emit a user_correction event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit user_correction \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"\",\"what_changed\":\"max-iteration-guidance\",\"user_intent\":\"${USER_CHOICE}\"}"
\`\`\`

Where USER_CHOICE captures which option the user selected and any guidance provided.
```

Add the same emit in the standalone_mode "If iteration_count >= 3" section (around line 469-473), after the "Offer:" line:

```markdown
After user responds, emit a user_correction event for Recall:

\`\`\`bash
node ~/.claude/hive/bin/hive-tools.js telemetry emit user_correction \
  --data "{\"phase\":\"${PHASE_NUMBER}\",\"plan\":\"\",\"what_changed\":\"max-iteration-guidance\",\"user_intent\":\"${USER_CHOICE}\"}"
\`\`\`
```

**Part D: Sync to installed copy**

Copy the modified `hive/workflows/plan-phase.md` content identically to `.claude/hive/workflows/plan-phase.md`. Both files must be identical.

**Important notes:**
- Both team_mode and standalone_mode sections MUST have emit instructions -- the revision loop has parallel code paths.
- The plan_revision event captures the round number (iteration_count) so Recall can track how many revision cycles are typical and whether the checker-planner loop converges.
- The user_correction at max iterations captures whether users force-proceed (accepting remaining issues), provide guidance (extending the loop), or abandon (indicating planning approach failure).
- Keep changes_summary to a brief one-line description, not the full diff of plan changes.
  </action>
  <verify>
1. Run `grep -c "telemetry emit plan_revision" hive/workflows/plan-phase.md` -- should return >= 2 (team mode + standalone mode)
2. Run `grep -c "telemetry emit user_correction" hive/workflows/plan-phase.md` -- should return >= 2 (team mode + standalone mode max iterations)
3. Verify both modes have plan_revision: search team_mode and standalone_mode sections
4. Verify both modes have user_correction: search iteration >= 3 sections
5. Run `diff hive/workflows/plan-phase.md .claude/hive/workflows/plan-phase.md` -- should show no differences
  </verify>
  <done>
plan-phase.md contains plan_revision emit instructions in both team_mode and standalone_mode revision loops, plus user_correction emit instructions at max iteration gates in both modes. Source and installed copies are identical. WFLOW-04 and WFLOW-05 (plan-phase gates) requirements satisfied.
  </done>
</task>

</tasks>

<verification>
1. `grep "telemetry emit verification_gap" hive/workflows/verify-phase.md` confirms verification gap emits at all 3 levels
2. `grep "telemetry emit plan_revision" hive/workflows/plan-phase.md` confirms plan revision emits in both modes
3. `grep "telemetry emit user_correction" hive/workflows/plan-phase.md` confirms user correction emits at max iterations
4. Both source/installed pairs are identical (diff returns empty)
5. Total emit count across verify-phase.md: 3 (truth + artifact + wiring)
6. Total emit count across plan-phase.md: 4 (2 plan_revision + 2 user_correction)
</verification>

<success_criteria>
- verify-phase.md has verification_gap emit at truth, artifact, and wiring failure points
- plan-phase.md has plan_revision emit in both team_mode and standalone_mode
- plan-phase.md has user_correction emit at max iterations in both modes
- All source files synced to .claude/hive/workflows/ installed copies
- WFLOW-03, WFLOW-04, and WFLOW-05 (plan-phase gates) requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-integration/03-02-SUMMARY.md`
</output>
