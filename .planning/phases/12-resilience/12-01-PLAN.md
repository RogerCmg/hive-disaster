---
phase: 12-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/bin/hive-tools.js
  - .claude/hive/bin/hive-tools.js
autonomous: true

must_haves:
  truths:
    - "When a build times out, no orphan child processes survive the kill"
    - "execCommand with timeout kills the entire process tree, not just the parent"
    - "Existing build gate behavior is unchanged for non-timeout cases"
  artifacts:
    - path: "hive/bin/hive-tools.js"
      provides: "execCommand with process group killing on timeout"
      contains: "detached"
    - path: ".claude/hive/bin/hive-tools.js"
      provides: "Installed copy of execCommand with process group killing"
      contains: "detached"
  key_links:
    - from: "hive/bin/hive-tools.js"
      to: "execCommand callers (cmdGitRunBuildGate, cmdGitRunGate2)"
      via: "execCommand return shape unchanged"
      pattern: "execCommand\\("
---

<objective>
Harden build timeout process killing so the entire process tree is terminated when a build exceeds its timeout, preventing orphan processes.

Purpose: Currently `execCommand` uses `spawnSync` with a `timeout` option. When timeout fires, Node.js sends SIGTERM to the spawned process only. But build commands like `npm test` spawn child processes (jest, webpack, etc.) that become orphans when only the parent is killed. This leaves zombie processes consuming resources.

Output: Updated `execCommand` in both copies of hive-tools.js that spawns in a detached process group and kills the entire group (`-pid`) on timeout.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@hive/bin/hive-tools.js (lines 373-389: execCommand function)
@hive/bin/hive-tools.js (lines 5372-5397: cmdGitRunBuildGate)
@hive/bin/hive-tools.js (lines 5814-5879: cmdGitRunGate2)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace spawnSync with process-group-aware timeout killing in execCommand</name>
  <files>
    hive/bin/hive-tools.js
    .claude/hive/bin/hive-tools.js
  </files>
  <action>
Modify the `execCommand` function (line 373) in both `hive/bin/hive-tools.js` and `.claude/hive/bin/hive-tools.js` to kill the entire process group on timeout instead of just the parent process.

**Current code** uses `spawnSync` with `timeout` option, which only kills the direct child.

**New approach:** Replace `spawnSync` with a synchronous wrapper around `spawnSync` that uses `detached: true` to create a new process group, then handles timeout manually:

1. Add `detached: true` to the `spawnSync` options. This causes the child to be a process group leader (its PID = its PGID).
2. When `spawnSync` reports a timeout (`result.error && result.error.code === 'ETIMEDOUT'`), send `SIGKILL` to the process group via `process.kill(-result.pid, 'SIGKILL')` wrapped in try/catch (the process may already be dead).
3. Preserve the existing return shape exactly: `{ success, exitCode, stdout, stderr, signal, timedOut }`.
4. When no timeout is specified (most callers), `detached: true` is still safe -- it just means the child is a group leader, but it completes normally and spawnSync waits.

**Implementation:**

```javascript
function execCommand(command, args, options) {
  const opts = options || {};
  const spawnOpts = {
    cwd: opts.cwd || process.cwd(),
    encoding: 'utf-8',
    timeout: opts.timeout,
    stdio: ['pipe', 'pipe', 'pipe'],
  };

  // On non-Windows: create process group so we can kill the entire tree on timeout
  if (process.platform !== 'win32') {
    spawnOpts.detached = true;
  }

  const result = spawnSync(command, args, spawnOpts);

  // If timed out, kill the entire process group (not just the parent)
  const timedOut = (result.error && result.error.code === 'ETIMEDOUT') || false;
  if (timedOut && result.pid && process.platform !== 'win32') {
    try {
      process.kill(-result.pid, 'SIGKILL');
    } catch {
      // Process group may already be dead â€” safe to ignore
    }
  }

  return {
    success: result.status === 0,
    exitCode: result.status,
    stdout: (result.stdout || '').trim(),
    stderr: (result.stderr || '').trim(),
    signal: result.signal || null,
    timedOut: timedOut,
  };
}
```

**Key details:**
- `detached: true` on non-Windows makes the child a process group leader (PGID = child PID).
- `process.kill(-result.pid, 'SIGKILL')` sends SIGKILL to the negative PID, which targets the entire process group.
- Windows does not support process groups this way, so `detached` is only set on non-Windows. On Windows, `spawnSync` timeout behavior is unchanged (Node.js handles it differently on Windows anyway).
- The return shape is identical -- all callers (cmdGitRunBuildGate, cmdGitRunGate2, and the ~20 other execCommand call sites) work without changes.
- Both copies (hive/ and .claude/hive/) must be updated identically.

**Do NOT** change any other function. Only modify `execCommand`.
  </action>
  <verify>
Run `node -e "const {spawnSync} = require('child_process'); console.log('ok')"` to confirm Node.js works.
Then verify the function compiles: `node -c hive/bin/hive-tools.js && node -c .claude/hive/bin/hive-tools.js`
Then verify the existing non-timeout path works: `node ./.claude/hive/bin/hive-tools.js git detect --raw` should return valid JSON.
Then verify the help output still works: `node ./.claude/hive/bin/hive-tools.js 2>&1 | head -5` (should show usage).
  </verify>
  <done>
execCommand uses detached process groups on non-Windows and kills the entire process group (not just parent) on timeout. Return shape is unchanged. Both copies updated. All existing callers work without modification.
  </done>
</task>

</tasks>

<verification>
1. `node -c hive/bin/hive-tools.js` passes (no syntax errors)
2. `node -c .claude/hive/bin/hive-tools.js` passes (no syntax errors)
3. `node ./.claude/hive/bin/hive-tools.js git detect --raw` returns valid JSON (non-timeout path)
4. `diff <(grep -A 25 'function execCommand' hive/bin/hive-tools.js) <(grep -A 25 'function execCommand' .claude/hive/bin/hive-tools.js)` shows identical code in both copies
5. `grep -c 'detached' hive/bin/hive-tools.js` returns at least 1
6. `grep 'process.kill(-result.pid' hive/bin/hive-tools.js` confirms process group kill is present
</verification>

<success_criteria>
- Build timeout kills the entire process tree, not just the parent process
- No orphan processes survive after a timed-out build
- Existing non-timeout behavior is completely unchanged
- Both hive-tools.js copies are identical
- All callers (cmdGitRunBuildGate, cmdGitRunGate2, and others) continue working without modification
</success_criteria>

<output>
After completion, create `.planning/phases/12-resilience/12-01-SUMMARY.md`
</output>
