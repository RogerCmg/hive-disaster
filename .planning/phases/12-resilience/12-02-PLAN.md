---
phase: 12-resilience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hive/workflows/execute-phase.md
  - .claude/hive/workflows/execute-phase.md
  - hive/workflows/execute-plan.md
  - .claude/hive/workflows/execute-plan.md
autonomous: true

must_haves:
  truths:
    - "Between execution waves, dev branch is synced via git pull so later waves build on merged work from earlier waves"
    - "When queue submission fails, the fallback path runs Gate 2 validation before self-merging to dev"
    - "Gate 2 failure in fallback prevents the self-merge from happening"
  artifacts:
    - path: "hive/workflows/execute-phase.md"
      provides: "Dev sync between waves step"
      contains: "git pull"
    - path: ".claude/hive/workflows/execute-phase.md"
      provides: "Installed copy of dev sync between waves"
      contains: "git pull"
    - path: "hive/workflows/execute-plan.md"
      provides: "Gate 2 in queue fallback path"
      contains: "run-gate-2"
    - path: ".claude/hive/workflows/execute-plan.md"
      provides: "Installed copy of Gate 2 in queue fallback path"
      contains: "run-gate-2"
  key_links:
    - from: "hive/workflows/execute-phase.md"
      to: "git pull origin dev"
      via: "dev sync step after branch cleanup"
      pattern: "git pull origin.*DEV_BRANCH"
    - from: "hive/workflows/execute-plan.md"
      to: "hive-tools.js git run-gate-2"
      via: "Gate 2 call in queue fallback path"
      pattern: "run-gate-2"
---

<objective>
Add two resilience fixes to the git workflow: (1) sync dev branch between execution waves so later waves build on merged work, and (2) run Gate 2 validation before self-merge when queue submission fails.

Purpose: Two gaps exist in the current workflow:
- execute-phase.md does not sync dev between waves. When Wave 1 plans merge to dev (via PR), Wave 2 branches are created from a potentially stale local dev. This can cause merge conflicts or missed code.
- When queue-submit fails in execute-plan.md, the fallback goes straight to self-merge without Gate 2 (pre-merge build validation). The repo manager path would have run Gate 2, but the fallback skips it, potentially merging broken code.

Output: Updated workflow files (both copies) with dev sync and Gate 2 fallback.
</objective>

<execution_context>
@./.claude/hive/workflows/execute-plan.md
@./.claude/hive/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@hive/workflows/execute-phase.md
@hive/workflows/execute-plan.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dev branch sync between waves in execute-phase.md</name>
  <files>
    hive/workflows/execute-phase.md
    .claude/hive/workflows/execute-phase.md
  </files>
  <action>
In both `hive/workflows/execute-phase.md` AND `.claude/hive/workflows/execute-phase.md`, add a "dev sync" step between waves. This step must appear AFTER branch cleanup and BEFORE the next wave's branch creation.

**Location in team_mode** (after step 6 "Plan branch cleanup" and before step 7 "Shutdown wave executors"):

Insert a new step 6.5 (renumber if needed) between branch cleanup and shutdown:

```markdown
6.5. **Sync dev branch (git flow "github" only):**

   After branch cleanup and BEFORE proceeding to next wave, pull dev to incorporate all merged work from this wave. This ensures next wave's plan branches fork from the latest dev state.

   ```bash
   # Only sync if on dev branch and git flow is active
   if [ "$GIT_FLOW" = "github" ]; then
     CURRENT=$(git branch --show-current)
     if [ "$CURRENT" = "${GIT_DEV_BRANCH}" ]; then
       git pull origin "${GIT_DEV_BRANCH}" 2>/dev/null || true
     fi
   fi
   ```

   If pull fails (e.g., no remote, network error): log warning "Could not sync dev from remote. Continuing with local state." Do NOT block execution — local merges from this wave are already on dev. The pull primarily helps when remote has changes from other sources.
```

**Location in standalone_mode** (after step 6 "Plan branch cleanup" and before step 7 "Execute checkpoint plans between waves"):

Insert the identical step 6.5 after standalone branch cleanup:

```markdown
6.5. **Sync dev branch (git flow "github" only):**

   After branch cleanup and BEFORE proceeding to next wave, pull dev to incorporate all merged work from this wave. This ensures next wave's plan branches fork from the latest dev state.

   ```bash
   # Only sync if on dev branch and git flow is active
   if [ "$GIT_FLOW" = "github" ]; then
     CURRENT=$(git branch --show-current)
     if [ "$CURRENT" = "${GIT_DEV_BRANCH}" ]; then
       git pull origin "${GIT_DEV_BRANCH}" 2>/dev/null || true
     fi
   fi
   ```

   If pull fails: log warning but do not block execution. Local merges are already present.
```

**Also add the sync in the dynamic_wave_scheduling section** (team mode only):

In the dynamic scheduling pseudocode, after processing a `PLAN COMPLETE:` message and before spawning the next plan, add a comment:

```
  if message is "PLAN COMPLETE:":
    completed_plans.add(plan.id)
    active_plans.remove(plan.id)

    # Sync dev if git flow is active (pulls merged work so next branch forks from latest)
    if GIT_FLOW == "github":
      git pull origin "${GIT_DEV_BRANCH}" 2>/dev/null || true
```

**Important path convention:** Source copies in `hive/` use `~/` paths (e.g., `~/.claude/hive/bin/hive-tools.js`). Installed copies in `.claude/hive/` use `./` paths (e.g., `./.claude/hive/bin/hive-tools.js`). The markdown content itself is identical between copies since the shell commands in execute-phase.md use `git` directly (no path differences for this change).

Both copies must have the identical dev sync step in both team_mode and standalone_mode sections.
  </action>
  <verify>
Verify the change exists in both copies:
`grep -c 'git pull origin.*GIT_DEV_BRANCH' hive/workflows/execute-phase.md` should return at least 2 (team + standalone).
`grep -c 'git pull origin.*GIT_DEV_BRANCH' .claude/hive/workflows/execute-phase.md` should return at least 2.
`grep -B2 'git pull origin' hive/workflows/execute-phase.md` should show it in the context of "Sync dev branch".
  </verify>
  <done>
execute-phase.md syncs dev via git pull between waves in both team_mode and standalone_mode sections, and in the dynamic_wave_scheduling section. Both copies (hive/ and .claude/hive/) updated identically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Gate 2 validation to queue-submit fallback in execute-plan.md</name>
  <files>
    hive/workflows/execute-plan.md
    .claude/hive/workflows/execute-plan.md
  </files>
  <action>
In both `hive/workflows/execute-plan.md` AND `.claude/hive/workflows/execute-plan.md`, modify the queue-submit fallback path to run Gate 2 before self-merging.

**Current behavior** (step 3.5 in create_pr_and_merge, the "If queue submission failed:" block):

```
If queue submission failed:
- Log warning: "Failed to submit to merge queue. Falling back to self-merge."
- Continue to step 4 (self-merge) as fallback.
```

**New behavior** — replace the queue submission failure block with:

```markdown
If queue submission failed:
- Log warning: "Failed to submit to merge queue. Falling back to self-merge with Gate 2 validation."

**Run Gate 2 (pre-merge build validation) before self-merge:**

```bash
CURRENT_BRANCH=$(git branch --show-current)
GATE2_RESULT=$(node ./.claude/hive/bin/hive-tools.js git run-gate-2 --branch "${CURRENT_BRANCH}" --raw)
GATE2_SUCCESS=$(echo "$GATE2_RESULT" | jq -r '.success')
GATE2_SKIPPED=$(echo "$GATE2_RESULT" | jq -r '.skipped // false')
```

Handle Gate 2 result:

| Condition | Action |
|-----------|--------|
| `GATE2_SKIPPED` is `"true"` | Gate 2 disabled or no build command. Log: "Gate 2 skipped (${reason}). Proceeding to self-merge." Continue to step 4. |
| `GATE2_SUCCESS` is `"true"` | Gate 2 passed. Log: "Gate 2 passed. Proceeding to self-merge." Continue to step 4. |
| `GATE2_SUCCESS` is `"false"` | Gate 2 failed. Present to user with same options as build_gate step: fix / skip / stop. If "fix": investigate, fix, re-commit, re-run Gate 2. If "skip": log "Gate 2 skipped by user. Proceeding to self-merge." Set `BUILD_GATE_RESULT="skipped_by_user"`. Continue to step 4. If "stop": abort, do NOT self-merge. Set `PR_FLOW_RESULT="stopped_gate2_failed"`. |

- Continue to step 4 (self-merge) only if Gate 2 passed or was skipped.
```

**Note about path convention:** The source copy in `hive/workflows/execute-plan.md` uses `~/` paths (e.g., `~/.claude/hive/bin/hive-tools.js`). The installed copy in `.claude/hive/workflows/execute-plan.md` uses `./` paths (e.g., `./.claude/hive/bin/hive-tools.js`). Make sure the Gate 2 command uses the correct path convention for each copy:

- In `hive/workflows/execute-plan.md`: `node ~/.claude/hive/bin/hive-tools.js git run-gate-2 ...`
- In `.claude/hive/workflows/execute-plan.md`: `node ./.claude/hive/bin/hive-tools.js git run-gate-2 ...`

Both copies must reflect the same logical change with the appropriate path convention.
  </action>
  <verify>
Verify the change exists in both copies:
`grep -c 'run-gate-2' hive/workflows/execute-plan.md` should return at least 1.
`grep -c 'run-gate-2' .claude/hive/workflows/execute-plan.md` should return at least 1.
`grep -B5 'run-gate-2' hive/workflows/execute-plan.md` should show it in the context of "queue submission failed" or "fallback".
  </verify>
  <done>
When queue-submit fails, the fallback path now runs Gate 2 (pre-merge build validation) before self-merging. Gate 2 failure prevents the self-merge from happening (user can fix, skip, or stop). Both copies updated with correct path conventions.
  </done>
</task>

</tasks>

<verification>
1. `grep -c 'git pull origin' hive/workflows/execute-phase.md` returns >= 2 (team + standalone sections)
2. `grep -c 'git pull origin' .claude/hive/workflows/execute-phase.md` returns >= 2
3. `grep -c 'run-gate-2' hive/workflows/execute-plan.md` returns >= 1
4. `grep -c 'run-gate-2' .claude/hive/workflows/execute-plan.md` returns >= 1
5. `grep 'Sync dev branch' hive/workflows/execute-phase.md` confirms the new step exists
6. `grep 'Gate 2' hive/workflows/execute-plan.md | grep -i 'fallback\|queue'` confirms Gate 2 is in the fallback path
</verification>

<success_criteria>
- Between execution waves, dev branch is synced via git pull so later waves build on merged work from earlier waves
- When queue submission fails, Gate 2 runs before the self-merge fallback
- Gate 2 failure in the fallback path blocks self-merge (user can fix, skip, or stop)
- Both source (hive/) and installed (.claude/hive/) copies are updated
- Path conventions respected (hive/ uses ~/, .claude/ uses ./)
- Existing non-git-flow behavior is unchanged (skip conditions preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/12-resilience/12-02-SUMMARY.md`
</output>
