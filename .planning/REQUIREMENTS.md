# Requirements: Hive Recall

**Defined:** 2026-02-11
**Core Value:** Persistent memory across sessions — agents learn from past failures without breaking fresh-context architecture

## v1 Requirements

Requirements for initial release. Each maps to roadmap phases.

### Infrastructure

- [x] **INFRA-01**: System stores events in append-only JSONL format at `.planning/telemetry/events.jsonl`
- [x] **INFRA-02**: Every event has common envelope fields: `ts` (ISO timestamp), `session` (ID), `type` (event discriminator), `v` (schema version), `data` (payload)
- [x] **INFRA-03**: System supports 10 event types: agent_completion, tool_error, deviation, checkpoint, verification_gap, plan_revision, user_correction, fallback, context_compaction, session_summary
- [x] **INFRA-04**: `hive-tools.js telemetry emit <type> --data '{json}'` appends event to JSONL
- [x] **INFRA-05**: `hive-tools.js telemetry query [--type X] [--since Y] [--limit N]` retrieves filtered events
- [x] **INFRA-06**: `hive-tools.js telemetry digest` generates INSIGHTS.md from accumulated events
- [x] **INFRA-07**: `hive-tools.js telemetry rotate` archives events.jsonl when over 500KB threshold
- [x] **INFRA-08**: `hive-tools.js telemetry stats` shows quick summary (event counts, file sizes, top types)
- [x] **INFRA-09**: System rotates events.jsonl automatically when exceeding 500KB, keeping max 10 archives
- [x] **INFRA-10**: Config section `telemetry` in config.json with toggles: `enabled`, `hooks`, `workflow_events`, `transcript_analysis`

### Hook Observers

- [ ] **HOOK-01**: SubagentStop hook logs agent completions (agent type, duration, exit code, error if any)
- [ ] **HOOK-02**: PostToolUseFailure hook logs tool errors (tool name, command, error message)
- [ ] **HOOK-03**: PreCompact hook logs context compaction events (trigger type, context pressure signal)
- [ ] **HOOK-04**: SessionStart hook logs session start (session type: startup/resume/clear/compact)
- [ ] **HOOK-05**: SessionEnd hook logs session end (agents spawned count, events recorded count)
- [ ] **HOOK-06**: All hooks are async and fail-silent (try/catch with empty catch, observation never breaks execution)
- [ ] **HOOK-07**: All hooks filter for Hive-specific events only (ignore non-Hive agents/tools)

### Workflow Integration

- [ ] **WFLOW-01**: execute-plan workflow emits `deviation` event when executor auto-fixes (Rules 1-3) or escalates (Rule 4)
- [ ] **WFLOW-02**: execute-phase workflow emits `checkpoint` event after each checkpoint resolution (type, user response, outcome)
- [ ] **WFLOW-03**: verify-work workflow emits `verification_gap` event when verification finds gaps (level, what failed, severity)
- [ ] **WFLOW-04**: plan-phase workflow emits `plan_revision` event when plan is revised after checker feedback (round number, changes)
- [ ] **WFLOW-05**: Any workflow with confirmation gate emits `user_correction` event when user modifies/rejects agent output

### Feedback Loop

- [ ] **FEED-01**: `hive-tools.js telemetry digest` generates `.planning/telemetry/INSIGHTS.md` with agent performance tables, recurring patterns, deviation trends, and recommendations
- [ ] **FEED-02**: Init commands include `recall_context` field in JSON output, extracted from INSIGHTS.md top patterns
- [ ] **FEED-03**: Workflows that spawn agents pass `<recall>` block with relevant past patterns to agent prompts
- [ ] **FEED-04**: `/hive:insights` slash command displays current insights, offers to regenerate digest
- [ ] **FEED-05**: `events.jsonl` is gitignored by default (raw data stays local)
- [ ] **FEED-06**: `INSIGHTS.md` is committed to git (shareable project wisdom)

### Installation

- [ ] **INST-01**: Installer (`bin/install.js`) copies hook observer files during installation
- [ ] **INST-02**: Installer registers hooks in `.claude/settings.json` (SubagentStop, PostToolUseFailure, PreCompact, SessionStart, SessionEnd)
- [ ] **INST-03**: Installer creates telemetry config section in default config.json template

### Transcript Analysis

- [ ] **TRANS-01**: Dedicated `hive-recall-analyst` agent that parses session transcripts for deep patterns (reasoning quality, wasted context, retry patterns)
- [ ] **TRANS-02**: `session_summary` event type generated by transcript analysis with quality score and recommendations
- [ ] **TRANS-03**: Pattern detection across sessions (recurring failures, implicit user preferences, agent behavior drift)

## v2 Requirements

Deferred to future release. Tracked but not in current roadmap.

### Cross-Project Learning

- **CROSS-01**: Global INSIGHTS.md at `~/.claude/hive/INSIGHTS.md` aggregating across projects
- **CROSS-02**: `telemetry digest --global` merges per-project insights
- **CROSS-03**: Global insights injected alongside project-specific ones in agent context

### Auto-Suggestions

- **AUTO-01**: Automatic improvement suggestions when deviation rate exceeds thresholds
- **AUTO-02**: Agent prompt refinement recommendations based on failure patterns

## Out of Scope

| Feature | Reason |
|---------|--------|
| SQLite / database storage | Previous intel system (v1.9.2) removed for using 21MB SQLite dep |
| Runtime npm dependencies | Zero-dep philosophy is core Hive identity |
| Real-time dashboard / web UI | CLI-only tool, markdown digest is sufficient |
| Code content in events | Privacy — events contain metadata only, never source code or secrets |
| Automatic hook installation without installer | Hooks must go through install.js for consistency |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| INFRA-01 | Phase 1 | Done ✓ |
| INFRA-02 | Phase 1 | Done ✓ |
| INFRA-03 | Phase 1 | Done ✓ |
| INFRA-04 | Phase 1 | Done ✓ |
| INFRA-05 | Phase 1 | Done ✓ |
| INFRA-06 | Phase 1 | Done ✓ |
| INFRA-07 | Phase 1 | Done ✓ |
| INFRA-08 | Phase 1 | Done ✓ |
| INFRA-09 | Phase 1 | Done ✓ |
| INFRA-10 | Phase 1 | Done ✓ |
| HOOK-01 | Phase 2 | Pending |
| HOOK-02 | Phase 2 | Pending |
| HOOK-03 | Phase 2 | Pending |
| HOOK-04 | Phase 2 | Pending |
| HOOK-05 | Phase 2 | Pending |
| HOOK-06 | Phase 2 | Pending |
| HOOK-07 | Phase 2 | Pending |
| WFLOW-01 | Phase 3 | Pending |
| WFLOW-02 | Phase 3 | Pending |
| WFLOW-03 | Phase 3 | Pending |
| WFLOW-04 | Phase 3 | Pending |
| WFLOW-05 | Phase 3 | Pending |
| FEED-01 | Phase 4 | Pending |
| FEED-02 | Phase 4 | Pending |
| FEED-03 | Phase 4 | Pending |
| FEED-04 | Phase 4 | Pending |
| FEED-05 | Phase 4 | Pending |
| FEED-06 | Phase 4 | Pending |
| INST-01 | Phase 5 | Pending |
| INST-02 | Phase 5 | Pending |
| INST-03 | Phase 5 | Pending |
| TRANS-01 | Phase 6 | Pending |
| TRANS-02 | Phase 6 | Pending |
| TRANS-03 | Phase 6 | Pending |

**Coverage:**
- v1 requirements: 34 total
- Mapped to phases: 34
- Unmapped: 0 ✓

---
*Requirements defined: 2026-02-11*
*Last updated: 2026-02-12 after Phase 1 completion*
